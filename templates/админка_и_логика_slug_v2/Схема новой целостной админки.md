### 1. Схема новой целостной админки

Сделаем одну админку с 5 крупными разделами, в которой учтено и старое, и новое ТЗ, а контент чётко разложен по типам.

#### 1.1. Типы контента (теги для страниц)

Единая модель `Page` с полем `type`:

1. `intro` — вводная, индекс сайта
   - Один документ.
   - URL: `/` (slug игнорируется).
   - Всегда free, без пэйвола.
2. `article` — основные статьи (уроки)
   - Только у них есть пара free/premium.
   - Один `.md` → две обёртки (free и premium).
   - Точно есть: slug, SEO, меню, пэйвол-настройки.
3. `appendix` — аппендикс (доп. материалы)
   - Только премиум.
   - Могут иметь slug, H1, меню, но: `noindex`, без free и пэйвола.
4. `recommendation` — рекомендации
   - Всегда free.
   - Свой slug, SEO, меню и «подпись в меню», карточки-рекомендации.
5. `legal` — легал-документы
   - Только модалки.
   - Используем H1 из `.md` и путь к файлу.
   - Нет slug, нет SEO, `noindex`, не строить отдельные страницы.
6. `image` — мета по картинкам
   - Отдельный список (не `Page`, но фильтруется рядом).
   - Путь к файлу + ALT + подпись.

Фильтры в левой колонке: `intro`, `article`, `appendix`, `recommendation`, `legal`, `image`, `all`.

------

#### 1.2. Основные разделы админки

##### Раздел 1. «Сайт, оплата и иконки»

Всё глобальное, что не привязано к конкретной странице:

1. Блок «Параметры сайта»
   - Название проекта (для манифеста и внутренних заголовков).
   - Базовый URL (без слеша на конце).
   - Email поддержки.
   - Режим среды: `prod / stage / dev`.
2. Блок «Юридические данные и футер»
   - Имя ИП/юрлица.
   - ИНН, ОГРН.
   - Почтовый адрес.
   - Год копирайта.
3. Блок «Robokassa» (как в старой админке, но чище)
   - merchantLogin.
   - password1, password2.
   - Success URL, Fail URL.
   - Флаг «тестовый режим».
4. Блок «Цены и продукты»
   - Список тарифов:
     - Внутренний ID тарифа.
     - Человеческое название.
     - Цена.
     - Валюта.
     - Описание (что включено).
     - Robokassa Description / доп.параметры, если нужны.
5. Блок «SEO по умолчанию и Open Graph»
   - Глобальный `META description` (fallback).
   - Глобальная `OG-image` (одна картинка).
   - Суффикс для `<title>` (например, `— Слишком умная уборка`).
6. Блок «Иконки и manifest»
   - Пути к favicon: svg, 32×32, apple-touch-icon.
   - Поля site.webmanifest: `name`, `short_name`, `description`, `theme_color`, `background_color`, `start_url`.

------

##### Раздел 2. «Контент»

Главная рабочая зона для страниц.

Левая колонка:

- Фильтры по типу (`intro / article / appendix / recommendation / legal / image / all`).
- Поиск по названию / пути.
- Список сущностей с кратким статусом (ОК, частично, пусто).

Правая часть — формы:

1. Для `intro` (вводная = index)
   - Read-only: путь к `.md`, `H1 из .md`.
   - SEO:
     - SEO-H1 (если не задан — можно использовать H1).
     - TITLE.
     - META description.
     - robots (обычно `index,follow`).
     - canonical (обычно `/`).
   - Меню не задаём (она не висит как отдельный пункт).
2. Для `article` (основные статьи — блок free/premium)
   - Общие поля:
     - Путь к `.md`.
     - Тип: `article` (read-only).
   - Slug:
     - Поле `slug`.
     - В ТЗ: если пусто — бэкенд делает транслитерацию SEO-H1 или H1 (правило ниже).
   - Заголовки и SEO:
     - `H1 из .md` (read-only, для премиум).
     - `SEO-H1` (обязателен; H1 free-версии).
     - `TITLE`.
     - `META description`.
     - `robots` (по умолчанию `index,follow`).
     - `canonical` (если пусто — бэкенд сам).
   - Меню:
     - `Заголовок в меню`.
     - `Подпись в меню` (опционально; если пусто — не выводить в билде).
   - Free/premium:
     - Флаг `Есть free-версия` (для статей должен быть всегда true, но поле можно оставить read-only и прятать на UI).
   - Пэйвол (можно отдельной вкладкой внутри карточки или в отдельном разделе, но данные одни и те же).
3. Для `appendix` (премиум-аппендикс)
   - Путь к `.md`, тип `appendix`.
   - Slug (по тем же правилам).
   - `H1 из .md` (read-only).
   - SEO:
     - SEO-H1 (опционально, но может пригодиться, если часть аппендикса когда-нибудь станет открытой).
     - TITLE, META description.
     - robots по умолчанию `noindex,nofollow`.
   - Меню:
     - `Заголовок в меню`.
     - `Подпись в меню` (опционально).
4. Для `recommendation` (рекомендации)
   - Путь к `.md`, тип `recommendation`.
   - Slug.
   - `H1 из .md` (read-only).
   - SEO:
     - SEO-H1 (по смыслу = H1, но поле отдельно).
     - TITLE, META description, robots (`index,follow`).
   - Меню:
     - `Заголовок в меню` (обязательно).
     - `Подпись в меню` (обязательно).
   - Связанные карточки-рекомендации редактируются в отдельном подпункте (см. ниже).
5. Для `legal` (модалки)
   - Путь к `.md`.
   - H1 из `.md`.
   - Тип модалки (offer, privacy, payment и т.п.).
   - SEO-поля отсутствуют, robots зашиты бэкендом как `noindex,nofollow`, slug не нужен.
6. Для `image` (картинки)
   - Путь к файлу.
   - Поле `ALT`.
   - Поле `Подпись/описание`.
   - Никаких slug / SEO / OG — этим управляют страницы.

------

##### Раздел 3. «Рекомендации и входные точки»

Тонкий слой над страницами типа `recommendation` и некоторыми `article`:

1. Сетка карточек рекомендаций
   - Сущность `RecommendationCard`:
     - pageId (ссылка на `Page`).
     - Иконка/emoji.
     - Заголовок карточки (может отличаться от SEO-H1).
     - Текст карточки (1–3 предложения).
     - Порядок сортировки, флаг «показывать».
2. Превью меню
   - Собирается из `article`, `appendix`, `recommendation` (кроме intro/legal).
   - Показывает `Заголовок в меню` + «подпись в меню».

------

##### Раздел 4. «Модалки и HTML-блоки»

Сюда переносим старый «Редактор модалок и HTML-блоков»:

1. Список модалок
   - Привязка типа модалки к `.md` и к конкретной кнопке/ссылке на сайте.
   - Возможность задать «заголовок модалки» (если не брать H1 из `.md`).
2. HTML-блоки
   - Идентификатор блока (`hero_cta`, `course_banner` и т.п.).
   - Тип содержимого (markdown/HTML).
   - Черновик/опубликовано.

------

##### Раздел 5. «SEO-обзор»

Пересборка старой `seo.html`, но без отдельной логики — это просто ещё один интерфейс к тем же полям:

1. Таблица: каждая строка — страница (`intro/article/appendix/recommendation/image/other`).
2. Фильтры: по типу, по robots (index/noindex), по заполненности TITLE/DESC.
3. В строке доступны к быстрому редактированию:
   - SEO-H1, TITLE, META description, robots, canonical.
4. Никаких дополнительных SEO-полей, которых нет в «Контенте».

------

##### Раздел 6. «Цены, CTA и запуск сборки»

Собираем старые блоки:

1. Цены (дублируется из «Сайт, оплата и иконки», но можно оставить один источник данных и просто «повторный вид». Если дублировать UI не хочется — этот раздел можно не выделять.)
2. Тексты CTA
   - Отдельные поля под основные call-to-action:
     - Текст кнопок («Купить курс», «Перейти в кабинет»).
     - Короткие маркетинговые подписи у блоков.
3. Запуск сборки и логи
   - Кнопка «Собрать сайт».
   - Показ последнего статуса, времени, среды (`prod/stage/dev`).
   - Viewer логов (последние N записей).

------

### 2. ТЗ для бэкэнда (укрупнённое)

#### 2.1. Модель данных

1. `Page`
   - `id` (uuid/int).
   - `type` (`intro | article | appendix | recommendation | legal | other`).
   - `md_path` (относительный путь к `.md`).
   - `slug` (строка без слешей; может быть пустым в базе).
   - `h1_md` (прочитанный из `.md` при сборке или сохранённый кешом).
   - `seo_h1` (строка, может быть пустой).
   - `title` (может быть пустой).
   - `meta_description` (может быть пустой).
   - `meta_robots` (может быть пустой).
   - `meta_canonical` (может быть пустой).
   - `menu_label` (может быть пустой).
   - `menu_subtitle` (может быть пустой).
   - `has_free` (bool; для `article` true, для остальных типов фиксировано).
2. `PaywallConfig`
   - `page_id` → `Page` (`type = article`).
   - `mode` (`paragraphs | percent`).
   - `min_open_percent` (int 0–100).
   - `open_paragraphs` (int).
   - `show_toc_above` (bool).
3. `ImageMeta`
   - `id`.
   - `path`.
   - `alt`.
   - `caption`.
4. `RecommendationCard`
   - `id`.
   - `page_id` (`Page` с `type in (article, recommendation)`).
   - `icon` (emoji или имя иконки).
   - `card_title`.
   - `card_text`.
   - `sort_order` (int).
   - `is_active` (bool).
5. `ModalConfig`
   - `id`.
   - `code` (`public_offer`, `privacy_policy` и т.п.).
   - `md_path`.
   - `title_override` (опционально; если пусто — брать H1 из `.md`).
6. `PricePlan`
   - `id`.
   - `code` (для внутренней логики/Robokassa).
   - `name`.
   - `price`.
   - `currency`.
   - `description`.
7. `GlobalConfig`
   - `site_name`.
   - `base_url`.
   - `support_email`.
   - `env` (`prod/stage/dev`).
   - `legal_name`, `inn`, `ogrn`, `legal_address`.
   - `copyright_year`.
   - Robokassa-поля: `merchant_login`, `password1`, `password2`, `success_url`, `fail_url`, `test_mode`.
   - SEO: `global_meta_description`, `title_suffix`, `global_og_image`.
   - Icons: `favicon_svg`, `favicon_32`, `apple_touch_icon`.
   - Manifest: `mf_name`, `mf_short_name`, `mf_description`, `mf_theme_color`, `mf_background_color`, `mf_start_url`.

------

#### 2.2. Правила формирования slug

1. При сохранении `Page`:
   - Если `slug` заполнен в админке →
     - Прогнать через санитайзер (строчные, `a-z0-9-`, убрать пробелы и служебные символы).
     - Проверить уникальность внутри данного типа URL (например, среди всех `article` + `appendix` + `recommendation`).
   - Если `slug` пустой →
     - Для `intro`: slug игнорируется (страница — `/`).
     - Для остальных: взять `seo_h1`, если он не пуст; иначе `h1_md`.
     - Применить транслитерацию + санитайзер.
     - При конфликте слуг + суффикс `-2`, `-3` и т.д.
2. slug хранится без слешей; построение маршрутов — на уровне роутинга.

------

#### 2.3. Маршруты и типы страниц

Схема может быть такой (пример, фактические пути — по вашему решению, главное — консистентность):

1. `intro`
   - URL: `/`.
   - Всегда free, доступна без авторизации.
   - `robots`: `index,follow`.
2. `article`
   - Free: `/course/<slug>`
     - Генерируется из `Page`+`PaywallConfig`.
     - Показывается первая часть текста, далее — блюр + CTA.
     - Доступ без авторизации.
     - `robots`: по `meta_robots` или `index,follow` по умолчанию.
   - Premium: `/cabinet/course/<slug>`
     - Полный текст.
     - Требует авторизации и действующей покупки.
     - Если пользователь не авторизован → вместо статьи рендерится экран логина/покупки (без редиректа, статус 200 или 401 по вашему решению).
     - `robots`: принудительно `noindex,nofollow` (игнорируем правки из админки).
     - `canonical`: всегда указывает на free-URL `/course/<slug>`.
3. `appendix`
   - URL: `/cabinet/appendix/<slug>` (пример).
   - Только premium, без free-версии, без пэйвола.
   - Если неавторизован → экран логина/покупки.
   - `robots`: `noindex,nofollow`.
   - `canonical`: либо нет, либо указывает сам на себя.
4. `recommendation`
   - URL: `/recommendations/<slug>` или `/course/routes/<slug>` — по дизайну.
   - Всегда free, открытые страницы.
   - `robots`: по `meta_robots` или `index,follow`.
   - Используются как посадочные/маршруты.
5. `legal`
   - Не генерировать отдельные HTML-страницы.
   - Отдавать по API (например, `/api/legal/<code>`) чистый HTML/markdown для вставки в модалки.
   - Всегда трактуются как `noindex,nofollow`.
6. `image`
   - Нет отдельных маршрутов (кроме статики).
   - Метаданные используются при вставке в страницы.

------

#### 2.4. SEO и HEAD

1. `<title>`
   - Если `Page.title` не пустой → использовать его.
   - Иначе, если есть `Page.seo_h1` → `seo_h1 + " " + GlobalConfig.title_suffix`.
   - Иначе — `h1_md + " " + suffix`.
2. `<meta name="description">`
   - Если `Page.meta_description` не пустой → использовать его.
   - Иначе → `GlobalConfig.global_meta_description`.
3. `<meta name="robots">`
   - Если `Page.meta_robots` не пустой → использовать его, кроме случаев:
     - `type = appendix` или premium-URL → принудительно `noindex,nofollow`.
     - `type = legal` → принудительно `noindex,nofollow`.
   - Если пусто:
     - `intro`, `article` (free), `recommendation` → `index,follow`.
     - `appendix`, premium-URL, `legal` → `noindex,nofollow`.
4. `<link rel="canonical">`
   - Если `meta_canonical` задан → использовать его.
   - Иначе:
     - Для `intro` → `base_url + "/"`.
     - Для `article` (free) → `base_url + "/course/<slug>"`.
     - Для premium-URL статьи → `canonical` указывает на free-URL.
     - Для `recommendation` → `base_url + "/<route>/<slug>"`.
     - Для `appendix` → либо сам на себя, либо не ставить (по согласованию).
5. Open Graph
   - `og:title` = `<title>`.
   - `og:description` = `<meta description>`.
   - `og:image` = `Page-specific`, если позже введём; пока — `GlobalConfig.global_og_image`.
   - `og:url` = текущий URL.
   - Для premium-URL статьи допускается `og:url` = free-URL.

------

#### 2.5. Поведение при шаринге и доступе к премиум

1. Кнопка «Поделиться» в UI
   - Для free-страниц (`intro`, `article` free, `recommendation`) → шарим текущий URL.
   - Для premium-страниц (`article` premium, `appendix`) → фронтенд должен шарить free-URL (у статьи) или не показывать шаринг (у чистого аппендикса). Это описывается в фронтенд-ТЗ, но опирается на различение `has_free`.
2. Переход на премиум-URL без авторизации
   - Бэкэнд определяет, что пользователь не авторизован/нет доступа.
   - Вместо редиректа отдаётся страница логина/покупки (или 401 с фронтовой подменой — по выбору).
   - В любом случае не отдавать полный текст урока.

------

#### 2.6. API для админки (в общих чертах)

1. Глобальные настройки
   - `GET /admin/global-config` → `GlobalConfig`.
   - `PUT /admin/global-config` → обновить.
2. Страницы
   - `GET /admin/pages?type=article&query=...` → список `Page` (без тела markdown).
   - `GET /admin/pages/{id}` → одна `Page`.
   - `PUT /admin/pages/{id}` → обновить поля (slug, seo_h1, title, meta_description, meta_robots, meta_canonical, menu_label, menu_subtitle, type не меняем).
3. Paywall
   - `GET /admin/paywall` → список `PaywallConfig`.
   - `PUT /admin/paywall/{page_id}` → изменить режим, проценты, абзацы, show_toc_above.
4. Рекомендации
   - `GET /admin/recommendations` → список `RecommendationCard`.
   - `PUT /admin/recommendations/{id}`.
5. Изображения
   - `GET /admin/images` → `ImageMeta`.
   - `PUT /admin/images/{id}` → ALT, caption.
6. Модалки и HTML-блоки
   - `GET /admin/modals`, `PUT /admin/modals/{id}`.
   - `GET /admin/html-blocks`, `PUT /admin/html-blocks/{id}`.
7. Сборка
   - `POST /admin/build` → триггер сборки.
   - `GET /admin/build/status` → статус последней сборки + лог (с пагинацией, если надо).

------

Если нужно, следующим шагом можно детализировать ровно две вещи:
— точную таблицу типов URL (для каждой комбинации type + free/premium);
— формат выходной структуры (где хранится всё это — JSON-файлы, БД, YAML).