const X="modulepreload",Y=function(e){return"/"+e},z={},ge=function(t,n,i){let a=Promise.resolve();if(n&&n.length>0){document.getElementsByTagName("link");const r=document.querySelector("meta[property=csp-nonce]"),l=(r==null?void 0:r.nonce)||(r==null?void 0:r.getAttribute("nonce"));a=Promise.allSettled(n.map(p=>{if(p=Y(p),p in z)return;z[p]=!0;const E=p.endsWith(".css"),A=E?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${p}"]${A}`))return;const d=document.createElement("link");if(d.rel=E?"stylesheet":X,E||(d.as="script"),d.crossOrigin="",d.href=p,l&&d.setAttribute("nonce",l),document.head.appendChild(d),E)return new Promise((b,m)=>{d.addEventListener("load",b),d.addEventListener("error",()=>m(new Error(`Unable to preload CSS for ${p}`)))})}))}function s(r){const l=new Event("vite:preloadError",{cancelable:!0});if(l.payload=r,window.dispatchEvent(l),!l.defaultPrevented)throw r}return a.then(r=>{for(const l of r||[])l.status==="rejected"&&s(l.reason);return t().catch(s)})};function Q(e){if(!e){console.warn("Form validation: form element is null");return}e.querySelectorAll('input[required], input[type="email"], input[minlength]').forEach(n=>{n.addEventListener("invalid",function(i){i.preventDefault(),this.validity.valueMissing?this.type==="email"?this.setCustomValidity("Пожалуйста, введите email"):this.type==="password"?this.setCustomValidity("Пожалуйста, введите пароль"):this.type==="checkbox"?this.setCustomValidity("Необходимо поставить галочку"):this.setCustomValidity("Пожалуйста, заполните это поле"):this.validity.typeMismatch&&this.type==="email"?this.setCustomValidity("Некорректный формат email"):this.validity.tooShort?this.setCustomValidity(`Минимум ${this.minLength} символов`):this.validity.tooLong?this.setCustomValidity(`Максимум ${this.maxLength} символов`):this.setCustomValidity("")}),n.addEventListener("input",function(){this.setCustomValidity("")}),n.addEventListener("change",function(){this.setCustomValidity("")})})}function ve(){document.readyState==="loading"?document.addEventListener("DOMContentLoaded",j,{once:!0}):j()}function j(){document.querySelectorAll('.cta-button, button[onclick*="openCTAModal"]').forEach(n=>{n.removeAttribute("onclick"),n.addEventListener("click",Z)});const t=document.getElementById("cta-payment-modal");if(t){t.hasAttribute("hidden")||t.setAttribute("hidden","");const n=t.querySelector(".modal-close"),i=t.querySelector(".modal-overlay"),a=t.querySelector("#payment-form");n&&n.addEventListener("click",D),i&&i.addEventListener("click",D),a&&(a.addEventListener("submit",ne),te(a),Q(a)),document.addEventListener("keydown",function(s){s.key==="Escape"&&!t.hasAttribute("hidden")&&D()})}}let x=null;function Z(e){e&&e.preventDefault();const t=document.getElementById("cta-payment-modal");if(!t){console.error("CTA modal not found");return}x=document.activeElement,t.removeAttribute("hidden"),document.body.style.overflow="hidden";const n=t.querySelector('input[name="email"]');if(n&&setTimeout(()=>n.focus(),100),ee(),window.analytics&&typeof window.analytics.track=="function"){const i=window.location.pathname.split("/").filter(Boolean).pop()||"home";window.analytics.track("cta_click",{slug:i})}else console.log("Analytics: CTA clicked")}typeof window<"u"&&(window.openCTAModal=Z,window.closeCTAModal=D);function D(){const e=document.getElementById("cta-payment-modal");if(!e)return;e.setAttribute("hidden",""),document.body.style.overflow="",x&&(x.focus(),x=null),document.removeEventListener("keydown",G);const t=document.getElementById("payment-error");t&&(t.style.display="none",t.textContent="")}function ee(e){document.addEventListener("keydown",G)}function G(e){const t=document.getElementById("cta-payment-modal");if(!(!t||t.hasAttribute("hidden"))&&e.key==="Tab"){const n=t.querySelectorAll('a[href], button, textarea, input[type="text"], input[type="email"], input[type="radio"], input[type="checkbox"], select'),i=n[0],a=n[n.length-1];e.shiftKey?document.activeElement===i&&(a.focus(),e.preventDefault()):document.activeElement===a&&(i.focus(),e.preventDefault())}}function te(e){const t=e.querySelector('input[name="email"]'),n=e.querySelector('input[name="accept_offer"]'),i=document.getElementById("payment-error"),a=()=>{const s=t.value.trim(),r=/^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)+$/;return s?r.test(s)?(i.textContent==="Неверный формат email"&&(i.style.display="none"),t.classList.remove("invalid"),!0):(v(i,"Неверный формат email"),t.classList.add("invalid"),!1):!0};t&&(t.addEventListener("blur",a),t.addEventListener("input",()=>{t.classList.contains("invalid")&&a()})),n&&n.addEventListener("change",()=>{n.checked&&i.textContent==="Необходимо согласие с условиями оферты"&&(i.style.display="none")})}async function ne(e){var A;e.preventDefault();const t=e.target,n=document.getElementById("payment-error"),i=t.email,a=t.accept_offer,s=t.querySelector('button[type="submit"]');if(!i){v(n,"Ошибка формы: поле email не найдено");return}if(!a){v(n,"Ошибка формы: поле согласия не найдено");return}const r=i.value?i.value.trim():"",l=a.checked;if(!r){v(n,"Пожалуйста, укажите email");return}if(!l){v(n,"Необходимо согласие с условиями оферты");return}if(!/^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)+$/.test(r)){v(n,"Неверный формат email");return}if(r.length>254){v(n,"Email слишком длинный");return}if(!s){v(n,"Ошибка формы: кнопка отправки не найдена");return}const E=s.textContent;s.disabled=!0,s.textContent="Создание счёта...",n&&(n.style.display="none");try{const d=await fetch("/server/api/order/create.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:r})}),b=d.clone();let m;try{m=await d.json()}catch(g){const C=await b.text().catch(()=>"");throw console.error("Payment error: invalid JSON from /server/api/order/create.php",{parseError:g,rawText:C}),new Error("Сервер оплат вернул некорректный ответ. Проверьте, запущен ли backend /server.")}if(!d.ok)throw new Error(m.error||`HTTP ${d.status}`);if(m.endpoint&&m.params){window.analytics&&typeof window.analytics.track=="function"?window.analytics.track("payment_initiated",{invoice_id:m.params.InvId,amount:m.params.OutSum}):console.log("Analytics: Payment initiated",m.params.InvId);const g=document.createElement("form");g.method="POST",g.action=m.endpoint;for(const[C,S]of Object.entries(m.params))if(S!=null){const k=document.createElement("input");k.type="hidden",k.name=C,k.value=S,g.appendChild(k)}document.body.appendChild(g),g.submit()}else throw new Error(m.error||"Не удалось создать счёт")}catch(d){console.error("Payment error:",d);const b=(A=d.message)!=null&&A.includes("Failed to fetch")?"Не удалось связаться с сервером оплаты. Проверьте подключение или запуск backend (/server).":d.message||"Произошла ошибка. Попробуйте ещё раз.";v(n,b),s.disabled=!1,s.textContent=E}}function v(e,t){e&&(e.textContent=t,e.style.display="block",e.scrollIntoView({behavior:"smooth",block:"nearest"}))}function Ee(){document.readyState==="loading"?document.addEventListener("DOMContentLoaded",N):N()}function N(){oe(window.location.hostname)&&se(),ie(),ae(),pe(),re()}function oe(e=""){return["localhost","127.0.0.1","::1","0.0.0.0"].includes(e)||/^10\./.test(e)||/^192\.168\./.test(e)||/^172\.(1[6-9]|2[0-9]|3[01])\./.test(e)||/\.local$/i.test(e)}function ie(){document.querySelectorAll(".modal:not([hidden]), .cookie-banner:not([hidden])").forEach(e=>e.setAttribute("hidden",""))}function se(){const e=window.fetch;window.fetch=function(t,n){return t.includes("/server/api/get-payment-success.php")?(console.log("Dev Mode: Mocking payment success API"),Promise.resolve({ok:!0,json:()=>Promise.resolve({status:"success",email:"dev@example.com",password:"DevPassword123"})})):t.includes("/server/api/user-info.php")?(console.log("Dev Mode: Mocking user info API"),Promise.resolve({ok:!0,json:()=>Promise.resolve({status:"success",email:"dev@example.com"})})):t.includes("/server/change-password.php")?(console.log("Dev Mode: Mocking change password API"),Promise.resolve({ok:!0,json:()=>Promise.resolve({status:"success",message:"Пароль успешно изменен (dev mode)"})})):e.apply(this,arguments)}}function ae(){const t=new URLSearchParams(window.location.search).get("payment");t==="success"?(H(),window.history.replaceState({},document.title,window.location.pathname)):t==="fail"&&(U(),window.history.replaceState({},document.title,window.location.pathname))}function re(){window.openPaymentSuccessModal=H,window.closePaymentSuccessModal=de,window.openPaymentFailModal=U,window.closePaymentFailModal=me,window.openSettingsModal=R,window.closeSettingsModal=fe,window.copySuccessPassword=ue,window.handleCabinetClick=le}function ce(){const e=document.querySelector('[data-build-slot="body"]'),t=((e==null?void 0:e.dataset.pageType)||document.body.dataset.pageType||"").toLowerCase(),n=window.location&&window.location.pathname||"",i=!!document.querySelector(".premium-teaser"),a=t==="free"||t==="paywall"||t==="intro-free",s=t==="premium"||t==="intro-premium",r=/template-paywall/i.test(n)||n.includes("/course/")&&!n.includes("/premium/"),l=n.startsWith("/premium/")||/template\.html$/i.test(n);return{isPaywall:i||a||r,isPremium:s||l}}function le(){const{isPaywall:e,isPremium:t}=ce();if(t&&!e){console.log("Cabinet: premium context detected -> Opening Settings Modal"),R();return}console.log("Cabinet: paywall/guest context detected -> Opening Login Modal"),window.openLoginModal&&window.openLoginModal()}async function H(){const e=document.getElementById("payment-success-modal");if(e){try{const n=await(await fetch("/server/api/get-payment-success.php")).json();n.status==="success"&&n.password?(document.getElementById("success-password-display").textContent=n.password,document.getElementById("success-password-container").style.display="block"):document.getElementById("success-password-container").style.display="none"}catch(t){console.error("Error fetching payment data:",t)}e.removeAttribute("hidden"),document.body.style.overflow="hidden"}}function de(){const e=document.getElementById("payment-success-modal");e&&(e.setAttribute("hidden",""),document.body.style.overflow="")}function ue(){const e=document.getElementById("success-password-display").textContent;navigator.clipboard.writeText(e).then(()=>{alert("Пароль скопирован!")})}function U(){const e=document.getElementById("payment-fail-modal");e&&(e.removeAttribute("hidden"),document.body.style.overflow="hidden")}function me(){const e=document.getElementById("payment-fail-modal");e&&(e.setAttribute("hidden",""),document.body.style.overflow="")}async function R(){const e=document.getElementById("settings-modal");if(e){try{const n=await(await fetch("/server/api/user-info.php")).json();if(n.status==="success")document.getElementById("settings-email").textContent=n.email;else{window.location.href="/";return}}catch(t){console.error(t)}e.removeAttribute("hidden"),document.body.style.overflow="hidden"}}function fe(){const e=document.getElementById("settings-modal");e&&(e.setAttribute("hidden",""),document.body.style.overflow="",document.getElementById("settings-password-form").reset(),document.getElementById("settings-error").style.display="none",document.getElementById("settings-success").style.display="none")}function pe(){const e=document.getElementById("settings-password-form");if(!e)return;e.querySelectorAll("input[required]").forEach(n=>{n.addEventListener("invalid",function(i){i.preventDefault(),this.validity.valueMissing?this.setCustomValidity("Пожалуйста, заполните это поле"):this.setCustomValidity("")}),n.addEventListener("input",function(){this.setCustomValidity("")})}),e.addEventListener("submit",async n=>{n.preventDefault();const i=new FormData(e),a=document.getElementById("settings-error"),s=document.getElementById("settings-success");a.style.display="none",s.style.display="none";try{const l=await(await fetch("/server/change-password.php",{method:"POST",body:JSON.stringify(Object.fromEntries(i)),headers:{"Content-Type":"application/json"}})).json();l.status==="success"?(s.textContent=l.message,s.style.display="block",e.reset()):(a.textContent=l.message,a.style.display="block")}catch{a.textContent="Ошибка сети",a.style.display="block"}})}const q="cookieConsent",T={};let V=!1;function ye(e){try{return window.localStorage?window.localStorage.getItem(e):T[e]}catch{return T[e]}}function K(e,t){try{if(window.localStorage){window.localStorage.setItem(e,t);return}}catch{}T[e]=t}function be(){if(typeof window<"u"&&window.COOKIE_BANNER_DISABLED||V)return;V=!0;const e=()=>he();document.readyState==="loading"?document.addEventListener("DOMContentLoaded",e,{once:!0}):e()}function he(){window.closeCookieBanner=P,window.acceptCookies=$,window.declineCookies=_,window.openCookieBanner=F;const e=document.getElementById("cookie-banner");if(!e)return;ye(q)||F();const n=e.querySelector(".cookie-btn-accept"),i=e.querySelector(".cookie-btn-decline"),a=e.querySelector(".cookie-close");n&&!n.dataset.bound&&(n.dataset.bound="true",n.addEventListener("click",s=>{s.preventDefault(),s.stopPropagation(),$()})),i&&!i.dataset.bound&&(i.dataset.bound="true",i.addEventListener("click",s=>{s.preventDefault(),s.stopPropagation(),_()})),a&&!a.dataset.bound&&(a.dataset.bound="true",a.addEventListener("click",s=>{s.preventDefault(),s.stopPropagation(),P()})),e.dataset.bound||(e.dataset.bound="true",e.addEventListener("click",we)),document.__cookieDelegateBound||(document.__cookieDelegateBound=!0,document.addEventListener("click",s=>{const r=s.target.closest("[data-cookie-action]");if(!r)return;const l=r.getAttribute("data-cookie-action");s.preventDefault(),s.stopPropagation(),W(l)}))}function F(){const e=document.getElementById("cookie-banner");e&&e.removeAttribute("hidden")}function P(){const e=document.getElementById("cookie-banner");e&&e.setAttribute("hidden","")}function $(){K(q,"accepted"),P()}function _(){K(q,"declined"),P()}function we(e){const t=e.target.closest("[data-cookie-action]");if(!t)return;const n=t.getAttribute("data-cookie-action");W(n)}function W(e){switch(e){case"accept":$();break;case"decline":_();break;case"close":P();break}}(function(){const e="/shared/legal/",t={terms:"legal-terms",privacy:"privacy-policy",offer:"public-offer",contacts:"contacts",refund:"refund-policy",requisites:"contacts",cookies:"privacy-policy",default:"legal-terms"},n=typeof window<"u"&&window.LEGAL_SLUG_MAP&&typeof window.LEGAL_SLUG_MAP=="object"?{...t,...window.LEGAL_SLUG_MAP}:{...t},i=new Map,a=new Map,s=S();function r(o){return o?n[o]||n.default||o:n.default||o}async function l(o){const u=`legal-${o}-modal`,c=document.getElementById(u),y=r(o)||o;if(!c){console.error(`Модальное окно ${u} не найдено`);return}let h=i.get(y);h||(h=await E(o),h?i.set(y,h):a.has(o)&&(h=a.get(o),i.set(y,h),console.warn(`[LegalModal] Используется fallback контент для ${o}`))),h&&A(c,h),c.removeAttribute("hidden"),c.setAttribute("aria-hidden","false"),document.body.style.overflow="hidden";const w=c.querySelector(".modal-close");w&&w.focus()}function p(o){const u=`legal-${o}-modal`,c=document.getElementById(u);c&&(c.setAttribute("hidden",""),c.setAttribute("aria-hidden","true"),document.body.style.overflow="")}async function E(o){const u=r(o),c=s.map(f=>`${f}${u}-content.html`);for(const f of c)try{const y=await fetch(f);if(!y.ok)throw new Error(`HTTP ${y.status}: ${y.statusText}`);return await y.text()}catch(y){console.warn(`Ошибка загрузки legal контента (${o}) с ${f}:`,y.message)}return console.error(`Не удалось загрузить legal контент (${o}) ни по одному из путей`),null}function A(o,u){const c=o.querySelector(".legal-text");if(c){const f=d(u);c.innerHTML=f}else console.error("Контейнер .legal-text не найден в модальном окне")}function d(o){const c=new DOMParser().parseFromString(o,"text/html"),f=new Set(["h1","h2","h3","h4","h5","h6","p","br","hr","ul","ol","li","strong","em","b","i","u","a","span","div","table","thead","tbody","tr","th","td","blockquote","pre","code"]),y=new Set(["href","class","id","target","rel"]);function h(w){if(w.nodeType===Node.TEXT_NODE)return w.textContent;if(w.nodeType!==Node.ELEMENT_NODE)return"";const L=w.tagName.toLowerCase();if(!f.has(L))return Array.from(w.childNodes).map(h).join("");let M="";for(const B of w.attributes)if(y.has(B.name.toLowerCase())){let I=B.value;if(B.name==="href"){const O=I.toLowerCase().trim();if(O.startsWith("javascript:")||O.startsWith("data:"))continue}I=I.replace(/"/g,"&quot;"),M+=` ${B.name}="${I}"`}L==="a"&&!w.hasAttribute("rel")&&(M+=' rel="noopener"');const J=Array.from(w.childNodes).map(h).join("");return["br","hr"].includes(L)?`<${L}${M}>`:`<${L}${M}>${J}</${L}>`}return Array.from(c.body.childNodes).map(h).join("")}function b(){document.addEventListener("click",o=>{const u=o.target.closest("[data-legal]");if(u){o.preventDefault();const c=u.getAttribute("data-legal");l(c)}})}function m(){document.addEventListener("keydown",o=>{o.key==="Escape"&&document.querySelectorAll(".legal-modal:not([hidden])").forEach(c=>{const f=c.id.replace("legal-","").replace("-modal","");p(f)})})}function g(){document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{C(),b(),m()}):(C(),b(),m())}function C(){document.querySelectorAll(".legal-modal").forEach(o=>{const u=o.id?o.id.replace("legal-","").replace("-modal",""):null,c=o.querySelector(".legal-text");u&&c&&c.innerHTML.trim()&&a.set(u,c.innerHTML)})}function S(){const o=new Set,u=typeof window<"u"?window.LEGAL_BASE_PATH:"";return u&&o.add(k(u)),o.add(k(e)),["./","../","../../","../../../"].forEach(f=>o.add(k(`${f}shared/legal/`))),Array.from(o)}function k(o){return o?o.endsWith("/")?o.slice(0,-1)+"/":`${o}/`:""}window.openLegalModal=l,window.closeLegalModal=p,g()})();export{ge as _,Ee as a,be as b,ve as i};
