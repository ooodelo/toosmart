<!-- –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê –î–õ–Ø LEGAL –†–ê–ó–î–ï–õ–û–í -->
<div class="modal legal-modal" id="legal-terms-modal">
    <div class="modal-overlay" onclick="closeLegalModal('terms')"></div>
    <div class="modal-content legal-modal-content">
        <h2 class="modal-title">–£—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</h2>
        <div class="legal-text">
            <p>–ó–¥–µ—Å—å –±—É–¥—É—Ç —Ä–∞–∑–º–µ—â–µ–Ω—ã —É—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è...</p>
        </div>
    </div>
    <button class="modal-close" type="button" onclick="closeLegalModal('terms')" aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
</div>

<div class="modal legal-modal" id="legal-offer-modal">
    <div class="modal-overlay" onclick="closeLegalModal('offer')"></div>
    <div class="modal-content legal-modal-content">
        <h2 class="modal-title">–ü—É–±–ª–∏—á–Ω–∞—è –æ—Ñ–µ—Ä—Ç–∞</h2>
        <div class="legal-text">
            <p>–ó–¥–µ—Å—å –±—É–¥–µ—Ç —Ä–∞–∑–º–µ—â–µ–Ω —Ç–µ–∫—Å—Ç –ø—É–±–ª–∏—á–Ω–æ–π –æ—Ñ–µ—Ä—Ç—ã...</p>
        </div>
    </div>
    <button class="modal-close" type="button" onclick="closeLegalModal('offer')" aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
</div>

<div class="modal legal-modal" id="legal-privacy-modal">
    <div class="modal-overlay" onclick="closeLegalModal('privacy')"></div>
    <div class="modal-content legal-modal-content">
        <h2 class="modal-title">–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</h2>
        <div class="legal-text">
            <p>–ó–¥–µ—Å—å –±—É–¥–µ—Ç —Ä–∞–∑–º–µ—â–µ–Ω–∞ –ø–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏...</p>
        </div>
    </div>
    <button class="modal-close" type="button" onclick="closeLegalModal('privacy')" aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
</div>

<div class="modal legal-modal" id="legal-refund-modal">
    <div class="modal-overlay" onclick="closeLegalModal('refund')"></div>
    <div class="modal-content legal-modal-content">
        <h2 class="modal-title">–ü–æ—Ä—è–¥–æ–∫ –≤–æ–∑–≤—Ä–∞—Ç–∞</h2>
        <div class="legal-text">
            <p>–ó–¥–µ—Å—å –±—É–¥–µ—Ç —Ä–∞–∑–º–µ—â–µ–Ω –ø–æ—Ä—è–¥–æ–∫ –≤–æ–∑–≤—Ä–∞—Ç–∞...</p>
        </div>
    </div>
    <button class="modal-close" type="button" onclick="closeLegalModal('refund')" aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
</div>

<div class="modal legal-modal" id="legal-contacts-modal">
    <div class="modal-overlay" onclick="closeLegalModal('contacts')"></div>
    <div class="modal-content legal-modal-content">
        <h2 class="modal-title">–ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã</h2>
        <div class="legal-text">
            <p>–ó–¥–µ—Å—å –±—É–¥–µ—Ç —Ä–∞–∑–º–µ—â–µ–Ω–∞ –∫–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è...</p>
        </div>
    </div>
    <button class="modal-close" type="button" onclick="closeLegalModal('contacts')" aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
</div>

<!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –í–•–û–î–ê –í –õ–ö -->
<div class="modal" id="login-modal" role="dialog" aria-modal="true" aria-labelledby="login-modal-title">
    <div class="modal-overlay" onclick="closeLoginModal()"></div>
    <div class="modal-content">
        <h2 id="login-modal-title" class="modal-title">–í–æ–π—Ç–∏ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h2>

        <p style="text-align: center; color: #666; margin-bottom: 24px; font-size: 15px;">
            –í–≤–µ–¥–∏—Ç–µ email, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ
        </p>

        <div id="login-error" style="display: none;" role="alert"></div>

        <form id="login-form">
            <input type="email" name="email" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à email" required autocomplete="email"
                aria-label="Email –¥–ª—è –≤—Ö–æ–¥–∞">

            <input type="password" name="password" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" required autocomplete="current-password"
                aria-label="–ü–∞—Ä–æ–ª—å" style="margin-bottom: 16px;">

            <button type="submit" class="modal-submit">
                –í–æ–π—Ç–∏
            </button>
        </form>

        <p style="text-align: center; margin-top: 16px;">
            <a href="/premium/" style="color: #667eea; text-decoration: none; font-size: 14px;">
                –ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?
            </a>
        </p>

        <p class="modal-security">
            üîê –í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –Ω–∞–¥–µ–∂–Ω–æ –∑–∞—â–∏—â–µ–Ω—ã
        </p>
    </div>
    <button class="modal-close" type="button" onclick="closeLoginModal()" aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
</div>

<!-- COOKIE CONSENT (modal-style bottom sheet) -->
<div class="cookie-banner" id="cookie-banner" hidden>
    <div class="cookie-content-wrapper">
        <button class="cookie-close" type="button" onclick="closeCookieBanner()" aria-label="–ó–∞–∫—Ä—ã—Ç—å"
            data-cookie-action="close">√ó</button>
        <div class="cookie-content">
            <p class="cookie-text">
                üç™ –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º cookies –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã —Å–∞–π—Ç–∞ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏.
                –ü—Ä–æ–¥–æ–ª–∂–∞—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–∞–π—Ç, –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å
                <a href="#" onclick="openLegalModal('privacy'); return false;">–ü–æ–ª–∏—Ç–∏–∫–æ–π –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</a>.
            </p>
            <div class="cookie-buttons">
                <button class="cookie-btn cookie-btn-accept" data-cookie-action="accept">–ü—Ä–∏–Ω—è—Ç—å</button>
                <button class="cookie-btn cookie-btn-decline" data-cookie-action="decline">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

{{> modal-payment-success }}
{{> modal-payment-fail }}
{{> modal-settings }}

<script>
    function isDevHost(hostname) {
        return ['localhost', '127.0.0.1', '::1', '0.0.0.0'].includes(hostname)
            || /^10\./.test(hostname)
            || /^192\.168\./.test(hostname)
            || /^172\.(1[6-9]|2[0-9]|3[01])\./.test(hostname)
            || /\.local$/i.test(hostname);
    }

    // –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –ø—Ä—è—á–µ–º –º–æ–¥–∞–ª–∫–∏, –µ—Å–ª–∏ –ø–ª–∞–≥–∏–Ω Vite –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª
    (function ensureHidden() {
        document.querySelectorAll('.modal:not([hidden]), .cookie-banner:not([hidden])')
            .forEach(el => el.setAttribute('hidden', ''));
    })();

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω —Å —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–º–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏ (–µ—Å–ª–∏ –º–æ–¥—É–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞)
    if (typeof window.openLegalModal !== 'function') {
        window.openLegalModal = function (type) {
            const modalId = 'legal-' + type + '-modal';
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.removeAttribute('hidden');
                document.body.style.overflow = 'hidden';
            }
        };
    }

    if (typeof window.closeLegalModal !== 'function') {
        window.closeLegalModal = function (type) {
            const modalId = 'legal-' + type + '-modal';
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.setAttribute('hidden', '');
                document.body.style.overflow = '';
            }
        };
    }

    // Fallback-—Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è cookie banner, –µ—Å–ª–∏ –º–æ–¥—É–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å
    if (typeof window.closeCookieBanner !== 'function') {
        window.closeCookieBanner = function () {
            const banner = document.getElementById('cookie-banner');
            if (banner) {
                banner.setAttribute('hidden', '');
            }
        };
    }

    if (typeof window.openCookieBanner !== 'function') {
        window.openCookieBanner = function () {
            const banner = document.getElementById('cookie-banner');
            if (banner) {
                banner.removeAttribute('hidden');
            }
        };
    }

    if (typeof window.acceptCookies !== 'function') {
        window.acceptCookies = function () {
            try { localStorage.setItem('cookieConsent', 'accepted'); } catch (e) { }
            window.closeCookieBanner();
        };
    }

    if (typeof window.declineCookies !== 'function') {
        window.declineCookies = function () {
            try { localStorage.setItem('cookieConsent', 'declined'); } catch (e) { }
            window.closeCookieBanner();
        };
    }

    // Fallback –±–∏–Ω–¥–∏–Ω–≥ –Ω–∞ –∫–Ω–æ–ø–∫–∏ –±–∞–Ω–Ω–µ—Ä–∞, –µ—Å–ª–∏ –º–æ–¥—É–ª—å –Ω–µ —É—Å–ø–µ–ª
    (function bindCookieFallbackOnce() {
        const banner = document.getElementById('cookie-banner');
        if (!banner || banner.dataset.bound) return;
        banner.dataset.bound = 'true';
        banner.addEventListener('click', function (event) {
            const target = event.target.closest('[data-cookie-action]');
            if (!target) return;
            const action = target.getAttribute('data-cookie-action');
            if (action === 'accept') {
                window.acceptCookies();
            } else if (action === 'decline') {
                window.declineCookies();
            } else if (action === 'close') {
                window.closeCookieBanner();
            }
        });
    })();

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –≤—Ö–æ–¥–∞ –≤ –õ–ö
    function openLoginModal() {
        const modal = document.getElementById('login-modal');
        if (modal) {
            modal.removeAttribute('hidden');
            document.body.style.overflow = 'hidden';

            // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ email
            const emailInput = modal.querySelector('input[name="email"]');
            if (emailInput) {
                setTimeout(() => emailInput.focus(), 100);
            }
        }
    }

    function closeLoginModal() {
        const modal = document.getElementById('login-modal');
        if (modal) {
            modal.setAttribute('hidden', '');
            document.body.style.overflow = '';

            // –û—á–∏—Å—Ç–∫–∞ –æ—à–∏–±–æ–∫
            const errorDiv = document.getElementById('login-error');
            if (errorDiv) {
                errorDiv.style.display = 'none';
                errorDiv.textContent = '';
            }
        }
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –≤—Ö–æ–¥–∞
    document.addEventListener('DOMContentLoaded', function () {
        const loginForm = document.getElementById('login-form');
        if (loginForm) {
            // –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è –≤–∞–ª–∏–¥–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
            const inputs = loginForm.querySelectorAll('input[required], input[type="email"]');
            inputs.forEach(input => {
                input.addEventListener('invalid', function (e) {
                    e.preventDefault();
                    if (this.validity.valueMissing) {
                        if (this.type === 'email') {
                            this.setCustomValidity('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ email');
                        } else if (this.type === 'password') {
                            this.setCustomValidity('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å');
                        } else {
                            this.setCustomValidity('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ —ç—Ç–æ –ø–æ–ª–µ');
                        }
                    } else if (this.validity.typeMismatch && this.type === 'email') {
                        this.setCustomValidity('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email');
                    } else {
                        this.setCustomValidity('');
                    }
                });
                input.addEventListener('input', function () {
                    this.setCustomValidity('');
                });
            });

            loginForm.addEventListener('submit', function (e) {
                e.preventDefault();

                const email = this.email.value.trim();
                const password = this.password.value;
                const errorDiv = document.getElementById('login-error');
                const submitBtn = this.querySelector('button[type="submit"]');

                if (!email || !password) {
                    if (errorDiv) {
                        errorDiv.textContent = '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è';
                        errorDiv.style.display = 'block';
                        errorDiv.style.background = '#fff5f5';
                        errorDiv.style.color = '#c62828';
                        errorDiv.style.padding = '12px 16px';
                        errorDiv.style.borderRadius = '10px';
                        errorDiv.style.fontSize = '14px';
                        errorDiv.style.marginBottom = '16px';
                        errorDiv.style.borderLeft = '3px solid #e53935';
                    }
                    return;
                }

                // DEV MODE CHECK (compile-time flag preferred; fallback ‚Äî host)
                const isDev = (typeof window.__DEV_LOGIN_BYPASS__ === 'boolean')
                    ? window.__DEV_LOGIN_BYPASS__
                    : isDevHost(window.location.hostname);

                // Strict Email Validation (Required for both modes)
                const emailRegex = /^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)+$/;

                if (!emailRegex.test(email)) {
                    if (errorDiv) {
                        errorDiv.textContent = '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email';
                        errorDiv.style.display = 'block';
                        errorDiv.style.background = '#fff5f5';
                        errorDiv.style.color = '#c62828';
                        errorDiv.style.padding = '12px 16px';
                        errorDiv.style.borderRadius = '10px';
                        errorDiv.style.fontSize = '14px';
                        errorDiv.style.marginBottom = '16px';
                        errorDiv.style.borderLeft = '3px solid #e53935';
                    }
                    return;
                }

                if (isDev) {
                    // DEV MODE: Bypass password check
                    console.log('Dev Mode: Login bypassed');
                    window.location.href = '/template.html';
                    return;
                }

                // PROD MODE: Submit to server
                submitBtn.disabled = true;
                submitBtn.textContent = '–í—Ö–æ–¥...';

                // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —Å –¥–∞–Ω–Ω—ã–º–∏
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/premium/';

                const emailField = document.createElement('input');
                emailField.type = 'hidden';
                emailField.name = 'email';
                emailField.value = email;
                form.appendChild(emailField);

                const passwordField = document.createElement('input');
                passwordField.type = 'hidden';
                passwordField.name = 'password';
                passwordField.value = password;
                form.appendChild(passwordField);

                document.body.appendChild(form);
                form.submit();
            });
        }
    });

    // Cookie consent logic moved to src/js/cookie-banner.js

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –≤—Å–µ—Ö legal –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø–æ Escape
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
            closeLegalModal('terms');
            closeLegalModal('offer');
            closeLegalModal('privacy');
            closeLegalModal('refund');
            closeLegalModal('contacts');
            closeLoginModal();
            closeCookieBanner();
        }
    });
</script>
