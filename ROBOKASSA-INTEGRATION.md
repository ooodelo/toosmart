# ๐ณ Robokassa Integration - ะะฝััััะบัะธั ะฟะพ ัะฐะทะฒะตัััะฒะฐะฝะธั

ะะพะปะฝะฐั ะธะฝัะตะณัะฐัะธั Robokassa + MySQL + Magic Links + ะคะธัะบะฐะปะธะทะฐัะธั 54-ะคะ

**ะะตััะธั:** v1.0
**ะะฐัะฐ:** 2024
**ะกัะฐััั:** Production Ready

---

## ๐ ะกะพะดะตัะถะฐะฝะธะต

1. [ะะฑะทะพั ะฐััะธัะตะบัััั](#ะพะฑะทะพั-ะฐััะธัะตะบัััั)
2. [ะขัะตะฑะพะฒะฐะฝะธั](#ััะตะฑะพะฒะฐะฝะธั)
3. [ะะฐัััะพะนะบะฐ MySQL](#ะฝะฐัััะพะนะบะฐ-mysql)
4. [ะะฐัััะพะนะบะฐ ะบะพะฝัะธะณััะฐัะธะธ](#ะฝะฐัััะพะนะบะฐ-ะบะพะฝัะธะณััะฐัะธะธ)
5. [ะะฐัััะพะนะบะฐ Robokassa](#ะฝะฐัััะพะนะบะฐ-robokassa)
6. [ะะธะณัะฐัะธั ะดะฐะฝะฝัั](#ะผะธะณัะฐัะธั-ะดะฐะฝะฝัั)
7. [ะขะตััะธัะพะฒะฐะฝะธะต](#ัะตััะธัะพะฒะฐะฝะธะต)
8. [ะะฐะทะฒะตัััะฒะฐะฝะธะต](#ัะฐะทะฒะตัััะฒะฐะฝะธะต)
9. [Troubleshooting](#troubleshooting)

---

## ๐๏ธ ะะฑะทะพั ะฐััะธัะตะบัััั

### ะงัะพ ะธะทะผะตะฝะธะปะพัั

**ะะพ ะธะฝัะตะณัะฐัะธะธ:**
- โ SQLite ะฑะฐะทะฐ ะดะฐะฝะฝัั
- โ ะะฐัะพะปะธ ะฒ ะพัะบัััะพะผ ะฒะธะดะต ะฟะพ email
- โ ะะฐะทะพะฒะฐั ะธะฝัะตะณัะฐัะธั Robokassa
- โ ะะตั ัะธัะบะฐะปะธะทะฐัะธะธ (ัะตะบะธ 54-ะคะ)
- โ ะะพะฝะพะปะธัะฝะฐั ััััะบัััะฐ ะบะพะดะฐ

**ะะพัะปะต ะธะฝัะตะณัะฐัะธะธ:**
- โ MySQL ะฑะฐะทะฐ ะดะฐะฝะฝัั
- โ Magic links ะดะปั ะฒัะพะดะฐ (ะฑะตะทะพะฟะฐัะฝะตะต)
- โ ะะพะดัะปัะฝะฐั ะฐััะธัะตะบัััะฐ
- โ ะคะธัะบะฐะปะธะทะฐัะธั (ัะตะบะธ 54-ะคะ)
- โ ะกะธััะตะผะฐ ะดะพัััะฟะพะฒ
- โ ะะฐะปะธะดะฐัะธั ัะตะฝ ะฝะฐ ัะตัะฒะตัะต
- โ ะะดะผะธะฝ-ะฟะฐะฝะตะปั ะดะปั ัะฟัะฐะฒะปะตะฝะธั ะทะฐะบะฐะทะฐะผะธ

### ะกัััะบัััะฐ ะฟัะพะตะบัะฐ

```
/server/
โโโ api/                    # API endpoints
โ   โโโ order/
โ   โ   โโโ create.php     # ะกะพะทะดะฐะฝะธะต ะทะฐะบะฐะทะฐ
โ   โโโ auth/
โ       โโโ login.php      # ะัะพะด ะฟะพ ะฟะฐัะพะปั
โ       โโโ magic-consume.php  # ะัะพะด ะฟะพ magic link
โ       โโโ set-password.php   # ะฃััะฐะฝะพะฒะบะฐ ะฟะฐัะพะปั
โโโ robokassa/
โ   โโโ result.php         # ResultURL ะพะฑัะฐะฑะพััะธะบ
โโโ src/                   # ะััะพะดะฝัะน ะบะพะด ะผะพะดัะปะตะน
โ   โโโ utils.php          # ะฃัะธะปะธัั
โ   โโโ config_loader.php  # ะะฐะณััะทะบะฐ ะบะพะฝัะธะณััะฐัะธะธ
โ   โโโ schema_init.php    # ะะฝะธัะธะฐะปะธะทะฐัะธั ะะ
โ   โโโ mailer.php         # ะัะฟัะฐะฒะบะฐ email
โ   โโโ robokassa/
โ   โ   โโโ helpers.php    # ะคัะฝะบัะธะธ Robokassa
โ   โโโ order/
โ   โ   โโโ create.php     # ะกะพะทะดะฐะฝะธะต ะทะฐะบะฐะทะฐ
โ   โโโ auth/
โ   โ   โโโ login.php
โ   โ   โโโ magic_consume.php
โ   โ   โโโ set_password.php
โ   โโโ admin/
โ       โโโ orders.php     # ะัะพัะผะพัั ะทะฐะบะฐะทะพะฒ
โ       โโโ setup.php      # ะะฐัััะพะนะบะฐ ัะตัะตะท ะฐะดะผะธะฝะบั
โ       โโโ admin_guard.php
โโโ storage/              # ะะพะฝัะธะณััะฐัะธั ะธ ะดะฐะฝะฝัะต
โ   โโโ settings.json     # ะัะฝะพะฒะฝะฐั ะบะพะฝัะธะณััะฐัะธั
โ   โโโ products.json     # ะะฐัะฐะปะพะณ ัะพะฒะฐัะพะฒ
โโโ sql/
โ   โโโ schema.sql        # SQL ััะตะผะฐ
โโโ health.php            # Health check

/scripts/
โโโ migrate_sqlite_to_mysql.php  # ะะธะณัะฐัะธั ะดะฐะฝะฝัั
```

---

## ๐ฆ ะขัะตะฑะพะฒะฐะฝะธั

### ะกะตัะฒะตัะฝัะต ััะตะฑะพะฒะฐะฝะธั:
- PHP 7.4+ (ัะตะบะพะผะตะฝะดัะตััั 8.0+)
- MySQL 5.7+ ะธะปะธ MariaDB 10.2+
- ะะพะดัะปะธ PHP:
  - `pdo_mysql`
  - `mbstring`
  - `json`
  - `openssl`

### ะัะพะฒะตัะบะฐ requirements:

```bash
php -v
php -m | grep -E "pdo_mysql|mbstring|json|openssl"
mysql --version
```

---

## ๐๏ธ ะะฐัััะพะนะบะฐ MySQL

### ะจะฐะณ 1: ะกะพะทะดะฐะฝะธะต ะฑะฐะทั ะดะฐะฝะฝัั

```sql
CREATE DATABASE toosmart CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

### ะจะฐะณ 2: ะกะพะทะดะฐะฝะธะต ะฟะพะปัะทะพะฒะฐัะตะปั

```sql
CREATE USER 'toosmart_user'@'localhost' IDENTIFIED BY 'ะะะจ_ะะะะะะะซะ_ะะะะะะฌ';
GRANT ALL PRIVILEGES ON toosmart.* TO 'toosmart_user'@'localhost';
FLUSH PRIVILEGES;
```

### ะจะฐะณ 3: ะะผะฟะพัั ััะตะผั

```bash
mysql -u toosmart_user -p toosmart < /home/user/toosmart/server/sql/schema.sql
```

### ะจะฐะณ 4: ะัะพะฒะตัะบะฐ ัะฐะฑะปะธั

```sql
USE toosmart;
SHOW TABLES;
```

ะะพะปะถะฝั ะฑััั ัะพะทะดะฐะฝั ัะฐะฑะปะธัั:
- `users` - ะฟะพะปัะทะพะฒะฐัะตะปะธ
- `orders` - ะทะฐะบะฐะทั
- `access` - ะดะพัััะฟั
- `magic_links` - magic links ะดะปั ะฒัะพะดะฐ

---

## โ๏ธ ะะฐัััะพะนะบะฐ ะบะพะฝัะธะณััะฐัะธะธ

### ะจะฐะณ 1: ะะตะดะฐะบัะธัะพะฒะฐะฝะธะต `server/storage/settings.json`

```json
{
  "db": {
    "dsn": "mysql:host=localhost;dbname=toosmart;charset=utf8mb4",
    "user": "toosmart_user",
    "pass": "ะะะจ_ะะะะะะฌ_ะะข_MYSQL"
  },
  "robokassa": {
    "merchant_login": "ะะะจ_MERCHANT_LOGIN",
    "pass1": "ะะะจ_PASSWORD_1",
    "pass2": "ะะะจ_PASSWORD_2",
    "is_test": true,
    "signature_alg": "md5",
    "success_url": "https://toosmart.com/server/success.php",
    "fail_url": "https://toosmart.com/",
    "default_sno": "usn_income",
    "default_tax": "none",
    "product_code": "premium_course"
  },
  "security": {
    "session_name": "toosmart_cabinet",
    "admin_token": "ะกะะะะะะะะฃะะขะ_ะกะะฃะงะะะะฃะฎ_ะกะขะะะะฃ_32+"
  },
  "emails": {
    "from": "noreply@toosmart.com",
    "transport": "phpmail"
  },
  "site": {
    "base_url": "https://toosmart.com"
  }
}
```

### ะะตะฝะตัะฐัะธั admin_token:

```bash
openssl rand -hex 32
```

### ะจะฐะณ 2: ะะฐัััะพะนะบะฐ ัะพะฒะฐัะพะฒ `server/storage/products.json`

ะคะฐะนะป ัะถะต ะฝะฐัััะพะตะฝ, ะฝะพ ะผะพะถะฝะพ ะธะทะผะตะฝะธัั ัะตะฝั:

```json
{
  "premium_course": {
    "name": "ะััั \"Clean - ะขะตะพัะธั ะฟัะฐะฒะธะปัะฝะพะน ัะฑะพัะบะธ\"",
    "price": 990.0,
    "tax": "none",
    "payment_method": "full_payment",
    "payment_object": "service"
  }
}
```

### ะจะฐะณ 3: ะัะฐะฒะฐ ะดะพัััะฟะฐ

```bash
chmod 600 /home/user/toosmart/server/storage/settings.json
chmod 600 /home/user/toosmart/server/storage/products.json
```

---

## ๐ง ะะฐัััะพะนะบะฐ Robokassa

### ะจะฐะณ 1: ะัะพะด ะฒ ะปะธัะฝัะน ะบะฐะฑะธะฝะตั Robokassa

https://auth.robokassa.ru/

### ะจะฐะณ 2: ะกะพะทะดะฐะฝะธะต ะผะฐะณะฐะทะธะฝะฐ

1. ะะตัะตะนะดะธัะต ะฒ ัะฐะทะดะตะป "ะะฐะณะฐะทะธะฝั"
2. ะกะพะทะดะฐะนัะต ะฝะพะฒัะน ะผะฐะณะฐะทะธะฝ
3. ะะฐะฟะพะปะฝะธัะต ะดะฐะฝะฝัะต ะพ ะผะฐะณะฐะทะธะฝะต

### ะจะฐะณ 3: ะขะตัะฝะธัะตัะบะธะต ะฝะฐัััะพะนะบะธ

ะะตัะตะนะดะธัะต ะฒ "ะขะตัะฝะธัะตัะบะธะต ะฝะฐัััะพะนะบะธ" ะผะฐะณะฐะทะธะฝะฐ:

**ะะปะณะพัะธัะผ ะฟะพะดะฟะธัะธ:**
- MD5 (ะธะปะธ SHA256, ะตัะปะธ ะฝัะถะฝะพ)

**ะคะธัะบะฐะปะธะทะฐัะธั:**
- ะะบะปััะธัะต "ะัะฟัะฐะฒะปััั ัะตะบะธ ะฒ ะะคะ" (ะดะปั 54-ะคะ)

**URL-ั:**
- **Result URL:** `https://toosmart.com/server/robokassa/result.php`
- **Success URL:** `https://toosmart.com/server/success.php`
- **Fail URL:** `https://toosmart.com/`

**ะะตัะพะด ะพัะฟัะฐะฒะบะธ ะดะฐะฝะฝัั:**
- ResultURL: POST
- Success/Fail: GET ะธะปะธ POST (ะปัะฑะพะน)

### ะจะฐะณ 4: ะะพะปััะตะฝะธะต ะฟะฐัะพะปะตะน

ะ ะปะธัะฝะพะผ ะบะฐะฑะธะฝะตัะต ัะบะพะฟะธััะนัะต:
- MerchantLogin
- Password #1 (ะดะปั ัะพัะผะธัะพะฒะฐะฝะธั ัััะปะบะธ)
- Password #2 (ะดะปั ResultURL)

ะััะฐะฒััะต ะธั ะฒ `server/storage/settings.json`

### ะจะฐะณ 5: ะขะตััะพะฒัะน ัะตะถะธะผ

ะะปั ัะตััะธัะพะฒะฐะฝะธั:
1. ะ ะะ Robokassa ะฒะบะปััะธัะต "ะขะตััะพะฒัะน ัะตะถะธะผ"
2. ะ `settings.json` ัััะฐะฝะพะฒะธัะต `"is_test": true`
3. ะัะฟะพะปัะทัะนัะต ัะตััะพะฒัะต ะฟะฐัะพะปะธ

---

## ๐ ะะธะณัะฐัะธั ะดะฐะฝะฝัั

ะัะปะธ ั ะฒะฐั ะตััั ะฟะพะปัะทะพะฒะฐัะตะปะธ ะฒ ััะฐัะพะน SQLite ะฑะฐะทะต:

```bash
php scripts/migrate_sqlite_to_mysql.php
```

ะกะบัะธะฟั ะฐะฒัะพะผะฐัะธัะตัะบะธ:
- ะงะธัะฐะตั ะฟะพะปัะทะพะฒะฐัะตะปะตะน ะธะท SQLite
- ะะตัะตะฝะพัะธั ะธั ะฒ MySQL
- ะัะดะฐะตั ะดะพัััะฟ
- ะกะพะทะดะฐะตั ะทะฐะบะฐะทั (ะตัะปะธ ะตััั invoice_id)

ะะตะทัะปััะฐั:
```
========================================
ะะธะณัะฐัะธั ะดะฐะฝะฝัั ะธะท SQLite ะฒ MySQL
========================================

๐ ะะพะดะบะปััะตะฝะธะต ะบ SQLite ะฑะฐะทะต...
๐ ะะพะดะบะปััะตะฝะธะต ะบ MySQL ะฑะฐะทะต...
๐ ะงัะตะฝะธะต ะฟะพะปัะทะพะฒะฐัะตะปะตะน ะธะท SQLite...
ะะฐะนะดะตะฝะพ ะฟะพะปัะทะพะฒะฐัะตะปะตะน: 5

ะะฑัะฐะฑะพัะบะฐ: user1@example.com ... โ ะผะธะณัะธัะพะฒะฐะฝ
ะะฑัะฐะฑะพัะบะฐ: user2@example.com ... โ ะผะธะณัะธัะพะฒะฐะฝ
...

========================================
ะะตะทัะปััะฐัั ะผะธะณัะฐัะธะธ:
โ ะะธะณัะธัะพะฒะฐะฝะพ: 5
โญ๏ธ  ะัะพะฟััะตะฝะพ: 0
โ ะัะธะฑะพะบ: 0
========================================
```

---

## ๐งช ะขะตััะธัะพะฒะฐะฝะธะต

### ะจะฐะณ 1: Health Check

ะัะบัะพะนัะต ะฒ ะฑัะฐัะทะตัะต:

```
https://toosmart.com/server/health.php
```

ะะถะธะดะฐะตะผัะน ะพัะฒะตั:
```json
{
  "status": "ok",
  "database": "connected",
  "users_count": 5,
  "timestamp": "2024-11-21 22:00:00"
}
```

### ะจะฐะณ 2: ะขะตััะพะฒะฐั ะพะฟะปะฐัะฐ

1. ะัะบัะพะนัะต ะณะปะฐะฒะฝัั ัััะฐะฝะธัั ัะฐะนัะฐ
2. ะะฐะถะผะธัะต ะฝะฐ CTA ะบะฝะพะฟะบั "ะัะฟะธัั ะบััั"
3. ะะฒะตะดะธัะต email
4. ะะพะดัะฒะตัะดะธัะต ะพัะตััั
5. ะะฐะถะผะธัะต "ะะฟะปะฐัะธัั"

ะะพะปะถะตะฝ ะฟัะพะธะทะพะนัะธ ัะตะดะธัะตะบั ะฝะฐ ัััะฐะฝะธัั Robokassa (ัะตััะพะฒัั).

### ะจะฐะณ 3: ะัะพะฒะตัะบะฐ ResultURL

ะ ัะตััะพะฒะพะผ ัะตะถะธะผะต Robokassa:
1. ะะฒะตะดะธัะต ัะตััะพะฒัะต ะดะฐะฝะฝัะต ะบะฐััั
2. ะะพะดัะฒะตัะดะธัะต ะพะฟะปะฐัั
3. Robokassa ะฒัะทะพะฒะตั ResultURL
4. ะัะพะฒะตัััะต, ััะพ ะฟะธััะผะพ ั magic link ะฟัะธัะปะพ ะฝะฐ email

### ะจะฐะณ 4: ะัะพะด ะฟะพ Magic Link

1. ะัะบัะพะนัะต ะฟะธััะผะพ
2. ะะตัะตะนะดะธัะต ะฟะพ ัััะปะบะต ะฒะธะดะฐ:
   ```
   https://toosmart.com/magic?token=...&email=...
   ```
3. ะะพะปะถะตะฝ ะฟัะพะธะทะพะนัะธ ะฐะฒัะพะผะฐัะธัะตัะบะธะน ะฒัะพะด

---

## ๐ ะะฐะทะฒะตัััะฒะฐะฝะธะต

### ะงะตะบะปะธัั ะฟะตัะตะด ะฟัะพะดะฐะบัะตะฝะพะผ:

- [ ] MySQL ะฑะฐะทะฐ ัะพะทะดะฐะฝะฐ ะธ ััะตะผะฐ ะธะผะฟะพััะธัะพะฒะฐะฝะฐ
- [ ] `settings.json` ะทะฐะฟะพะปะฝะตะฝ ะฟัะฐะฒะธะปัะฝัะผะธ ะดะฐะฝะฝัะผะธ
- [ ] `is_test: false` ะฒ settings.json
- [ ] Robokassa ะฝะฐัััะพะตะฝะฐ (ัะธัะบะฐะปะธะทะฐัะธั ะฒะบะปััะตะฝะฐ)
- [ ] ResultURL ะดะพัััะฟะตะฝ ะธะทะฒะฝะต (ะฝะต 403/404)
- [ ] Health check ะฒะพะทะฒัะฐัะฐะตั `"status": "ok"`
- [ ] ะขะตััะพะฒะฐั ะพะฟะปะฐัะฐ ะฟัะพัะปะฐ ััะฟะตัะฝะพ
- [ ] Magic link ัะฐะฑะพัะฐะตั
- [ ] Email ะพัะฟัะฐะฒะปััััั ะบะพััะตะบัะฝะพ
- [ ] ะัะฐะฒะฐ ะฝะฐ ัะฐะนะปั ะฝะฐัััะพะตะฝั (600 ะฝะฐ ะบะพะฝัะธะณะธ)

### ะะตัะตะบะปััะตะฝะธะต ะฒ ะฟัะพะดะฐะบัะตะฝ:

1. ะ Robokassa ะะ ะพัะบะปััะธัะต "ะขะตััะพะฒัะน ัะตะถะธะผ"
2. ะ `settings.json` ัััะฐะฝะพะฒะธัะต `"is_test": false`
3. ะัะฟะพะปัะทัะนัะต ะฟัะพะดะฐะบัะฝ ะฟะฐัะพะปะธ (ะฝะต ัะตััะพะฒัะต)

---

## ๐๏ธ Troubleshooting

### ะัะพะฑะปะตะผะฐ: Health check ะฒะพะทะฒัะฐัะฐะตั 500

**ะะตัะตะฝะธะต:**
- ะัะพะฒะตัััะต ะฟะพะดะบะปััะตะฝะธะต ะบ MySQL
- ะัะพะฒะตัััะต ะฟัะฐะฒะฐ ะดะพัััะฟะฐ ะบ `settings.json`
- ะัะพะฒะตัััะต ะปะพะณะธ PHP: `tail -f /var/log/php-errors.log`

### ะัะพะฑะปะตะผะฐ: Robokassa ะฝะต ะฒัะทัะฒะฐะตั ResultURL

**ะะตัะตะฝะธะต:**
- ะัะพะฒะตัััะต, ััะพ URL ะดะพัััะฟะตะฝ ะธะทะฒะฝะต (curl)
- ะัะพะฒะตัััะต IP whitelist ะฒ ะฝะฐัััะพะนะบะฐั ัะตัะฒะตัะฐ
- ะฃะฑะตะดะธัะตัั, ััะพ ResultURL ัะบะฐะทะฐะฝ ะฒ ะะ Robokassa
- ะัะพะฒะตัััะต ะปะพะณะธ Apache/Nginx

### ะัะพะฑะปะตะผะฐ: Invalid signature

**ะะตัะตะฝะธะต:**
- ะัะพะฒะตัััะต, ััะพ pass1 ะธ pass2 ัะพะฒะฟะฐะดะฐัั ั ะะ Robokassa
- ะฃะฑะตะดะธัะตัั, ััะพ algorithm ัะพะฒะฟะฐะดะฐะตั (md5/sha256)
- ะัะพะฒะตัััะต, ััะพ ะธัะฟะพะปัะทัะตัะต ะฟัะฐะฒะธะปัะฝัะต ะฟะฐัะพะปะธ (ัะตัั/ะฟัะพะด)

### ะัะพะฑะปะตะผะฐ: Email ะฝะต ะพัะฟัะฐะฒะปััััั

**ะะตัะตะฝะธะต:**
- ะัะปะธ ะธัะฟะพะปัะทัะตัะต phpmail, ะฝะฐัััะพะนัะต sendmail ะฝะฐ ัะตัะฒะตัะต
- ะะตัะตะบะปััะธัะตัั ะฝะฐ SMTP ะฒ `settings.json`:
  ```json
  "emails": {
    "from": "noreply@toosmart.com",
    "transport": "smtp",
    "smtp": {
      "host": "smtp.gmail.com",
      "port": 587,
      "user": "your@gmail.com",
      "pass": "app_password",
      "secure": "tls"
    }
  }
  ```

### ะัะพะฑะปะตะผะฐ: Magic link ะฝะต ัะฐะฑะพัะฐะตั

**ะะตัะตะฝะธะต:**
- ะัะพะฒะตัััะต, ััะพ ัััะปะบะฐ ะฝะต ะธััะตะบะปะฐ (24 ัะฐัะฐ)
- ะัะพะฒะตัััะต, ััะพ ัััะปะบะฐ ะฝะต ะฑัะปะฐ ะธัะฟะพะปัะทะพะฒะฐะฝะฐ ัะฐะฝะตะต
- ะัะพะฒะตัััะต ัะฐะฑะปะธัั `magic_links` ะฒ MySQL

---

## ๐ ะกัััะบัััะฐ ะฑะฐะทั ะดะฐะฝะฝัั

### ะขะฐะฑะปะธัะฐ `users`

| ะะพะปะต | ะขะธะฟ | ะะฟะธัะฐะฝะธะต |
|------|-----|----------|
| id | INT | ะะตัะฒะธัะฝัะน ะบะปัั |
| email | VARCHAR(255) | Email ะฟะพะปัะทะพะฒะฐัะตะปั (ัะฝะธะบะฐะปัะฝัะน) |
| password_hash | VARCHAR(255) | ะฅะตั ะฟะฐัะพะปั (NULL = ะฝะต ัััะฐะฝะพะฒะปะตะฝ) |
| created_at | DATETIME | ะะฐัะฐ ัะตะณะธัััะฐัะธะธ |

### ะขะฐะฑะปะธัะฐ `orders`

| ะะพะปะต | ะขะธะฟ | ะะฟะธัะฐะฝะธะต |
|------|-----|----------|
| id | INT | ะะตัะฒะธัะฝัะน ะบะปัั |
| inv_id | INT | InvoiceID ะพั Robokassa (ัะฝะธะบะฐะปัะฝัะน) |
| email | VARCHAR(255) | Email ะฟะพะบัะฟะฐัะตะปั |
| amount | DECIMAL(10,2) | ะกัะผะผะฐ ะทะฐะบะฐะทะฐ |
| status | VARCHAR(20) | pending / paid |
| receipt_json | TEXT | JSON ัะตะบะฐ ะดะปั ัะธัะบะฐะปะธะทะฐัะธะธ |
| created_at | DATETIME | ะะฐัะฐ ัะพะทะดะฐะฝะธั |
| paid_at | DATETIME | ะะฐัะฐ ะพะฟะปะฐัั |

### ะขะฐะฑะปะธัะฐ `access`

| ะะพะปะต | ะขะธะฟ | ะะฟะธัะฐะฝะธะต |
|------|-----|----------|
| id | INT | ะะตัะฒะธัะฝัะน ะบะปัั |
| user_id | INT | ID ะฟะพะปัะทะพะฒะฐัะตะปั (FK) |
| granted_at | DATETIME | ะะฐัะฐ ะฒัะดะฐัะธ ะดะพัััะฟะฐ |
| ends_at | DATETIME | ะะฐัะฐ ะพะบะพะฝัะฐะฝะธั (NULL = ะฑะตัััะพัะฝะพ) |

### ะขะฐะฑะปะธัะฐ `magic_links`

| ะะพะปะต | ะขะธะฟ | ะะฟะธัะฐะฝะธะต |
|------|-----|----------|
| id | INT | ะะตัะฒะธัะฝัะน ะบะปัั |
| user_id | INT | ID ะฟะพะปัะทะพะฒะฐัะตะปั (FK) |
| token | CHAR(64) | ะขะพะบะตะฝ (ัะฝะธะบะฐะปัะฝัะน) |
| expires_at | DATETIME | ะะฐัะฐ ะธััะตัะตะฝะธั |
| consumed_at | DATETIME | ะะฐัะฐ ะธัะฟะพะปัะทะพะฒะฐะฝะธั (NULL = ะฝะต ะธัะฟะพะปัะทะพะฒะฐะฝ) |
| created_at | DATETIME | ะะฐัะฐ ัะพะทะดะฐะฝะธั |

---

## ๐ ะะตะทะพะฟะฐัะฝะพััั

### ะะตะฐะปะธะทะพะฒะฐะฝะฝัะต ะผะตัั ะฑะตะทะพะฟะฐัะฝะพััะธ:

- โ ะัะพะฒะตัะบะฐ ะฟะพะดะฟะธัะธ Robokassa (hash_equals)
- โ ะะฐะปะธะดะฐัะธั email ะฝะฐ ัะตัะฒะตัะต
- โ ะะฐัะธัะฐ ะพั ะธะทะผะตะฝะตะฝะธั ัะตะฝ (ัะตะฝะฐ ะฑะตัะตััั ั ัะตัะฒะตัะฐ)
- โ ะัะธะฟัะพะณัะฐัะธัะตัะบะธ ััะพะนะบะธะต ัะพะบะตะฝั (random_bytes)
- โ ะฅะตัะธัะพะฒะฐะฝะธะต ะฟะฐัะพะปะตะน (password_hash)
- โ ะะฐัะธัะฐ ะพั race conditions (ััะฐะฝะทะฐะบัะธะธ)
- โ ะะณัะฐะฝะธัะตะฝะธะต ะฒัะตะผะตะฝะธ ะดะตะนััะฒะธั magic links (24 ัะฐัะฐ)
- โ ะะดะฝะพัะฐะทะพะฒัะต magic links (consumed_at)

### ะะตะบะพะผะตะฝะดะฐัะธะธ:

- ะฅัะฐะฝะธัะต `settings.json` ะฒะฝะต ะฒะตะฑ-ะบะพัะฝั (ะธะปะธ ั ะฟัะฐะฒะฐะผะธ 600)
- ะัะฟะพะปัะทัะนัะต HTTPS ะดะปั ะฒัะตั endpoint
- ะะตะณัะปััะฝะพ ะพะฑะฝะพะฒะปัะนัะต PHP
- ะะฐัััะพะนัะต firewall ะดะปั ResultURL (ัะพะปัะบะพ IP Robokassa)

---

## ๐ ะะพะดะดะตัะถะบะฐ

ะัะปะธ ะฒะพะทะฝะธะบะปะธ ะฒะพะฟัะพัั:

1. ะัะพะฒะตัััะต ัะฐะทะดะตะป [Troubleshooting](#troubleshooting)
2. ะัะพะฒะตัััะต ะปะพะณะธ ัะตัะฒะตัะฐ
3. ะัะพะฒะตัััะต `server/health.php`
4. ะะฑัะฐัะธัะตัั ะฒ ะฟะพะดะดะตัะถะบั Robokassa (ะดะปั ะฒะพะฟัะพัะพะฒ ะพ ะฟะปะฐัะตะถะฐั)

---

## ๐ Changelog

### v1.0 (2024-11-21)
- โ ะะพะปะฝะฐั ะธะฝัะตะณัะฐัะธั Robokassa
- โ ะะตัะตัะพะด ะฝะฐ MySQL
- โ Magic links ะดะปั ะฒัะพะดะฐ
- โ ะคะธัะบะฐะปะธะทะฐัะธั 54-ะคะ
- โ ะะพะดัะปัะฝะฐั ะฐััะธัะตะบัััะฐ
- โ ะะธะณัะฐัะธั ะธะท SQLite
- โ ะะดะผะธะฝ-ะฟะฐะฝะตะปั ะดะปั ะทะฐะบะฐะทะพะฒ

---

**ะะพัะพะฒะพ! ะกะธััะตะผะฐ ะฟะพะปะฝะพัััั ะธะฝัะตะณัะธัะพะฒะฐะฝะฐ ะธ ะณะพัะพะฒะฐ ะบ ัะฐะฑะพัะต.**
