┌─────────────────────────────────────────────────┐
│  1. Покупатель оплачивает                       │
└──────────────┬──────────────────────────────────┘
               ▼
┌─────────────────────────────────────────────────┐
│  2. Robokassa → ResultURL                       │
│     server/robokassa-callback.php               │
│     - Генерирует пароль                         │
│     - Читает шаблон из email-templates.json     │
│     - Отправляет письмо                         │
│     - Сохраняет в сессию:                       │
│       $_SESSION['new_password'] = "xxx"         │
│       $_SESSION['new_password_email'] = "..."   │
└──────────────┬──────────────────────────────────┘
               ▼
┌─────────────────────────────────────────────────┐
│  3. Robokassa → Success URL                     │
│     server/success.php                          │
│     - Редирект на /server/?payment=success      │
└──────────────┬──────────────────────────────────┘
               ▼
┌─────────────────────────────────────────────────┐
│  4. server/index.php                            │
│     - Видит ?payment=success                    │
│     - Читает $_SESSION['new_password']          │
│     - Загружает templates/payment-success.html  │
│     - Заменяет {{EMAIL}}, {{PASSWORD}}          │
│     - Создает токен авто-логина                 │
│     - УДАЛЯЕТ пароль из сессии                  │
│     - Показывает модалку                        │
└──────────────┬──────────────────────────────────┘
               ▼
┌─────────────────────────────────────────────────┐
│  5. Пользователь видит окно                     │
│     ✅ Оплата успешна!                          │
│     Email: user@example.com                     │
│     Пароль: XxXxXxXx                           │
│     💾 Пароль отправлен на email                │
│     [Войти в курс] ← кнопка                     │
└──────────────┬──────────────────────────────────┘
               ▼
┌─────────────────────────────────────────────────┐
│  6. Клик на "Войти в курс"                      │
│     → auto-login.php?token=yyy                  │
│     - Проверяет токен из сессии                 │
│     - Авторизует: $_SESSION['premium_user']     │
│     - Удаляет токен (одноразовый!)              │
│     - Редирект на /premium/course/...           │
└──────────────┬──────────────────────────────────┘
               ▼
┌─────────────────────────────────────────────────┐
│  7. Пользователь в курсе (авторизован)          │
└─────────────────────────────────────────────────┘





## 📋 Расширение задачи: Управление контентом через админку

Отличная идея! Добавим в админку интерфейс для управления всем пользовательским контентом.

Globadmin/**/*.{html,php,js}

Read/home/user/toosmart/admin/index.html

Read 100 lines

Read/home/user/toosmart/admin/index.html

Read 100 lines

Отлично! Вижу у вас уже есть админка с табами. Сейчас опишу, какие разделы добавить для управления контентом.

------

## 📋 РАСШИРЕННАЯ ЗАДАЧА: Админка для управления контентом

### **Добавить 3 новых таба в админку:**

------

## **1️⃣ Таб: "Настройки продукта"**

### **Назначение:**

Редактирование информации о товаре (название, цена) из server/storage/products.json

### **Интерфейс:**

```
┌─────────────────────────────────────────────┐
│  📦 Настройки продукта                       │
│  Управление товаром в интернет-магазине      │
└─────────────────────────────────────────────┘

┌─────────────────────────────────────────────┐
│  Основная информация                         │
├─────────────────────────────────────────────┤
│                                              │
│  Название товара *                           │
│  ┌───────────────────────────────────────┐  │
│  │ Курс "Clean - Теория правильной...    │  │
│  └───────────────────────────────────────┘  │
│  ℹ️ Отображается в окне оплаты Robokassa   │
│                                              │
│  Цена, ₽ *                                   │
│  ┌───────────────────────────────────────┐  │
│  │ 5490                                   │  │
│  └───────────────────────────────────────┘  │
│  ℹ️ Указывается без символа рубля           │
│                                              │
│  [Сохранить изменения]                       │
│                                              │
└─────────────────────────────────────────────┘

┌─────────────────────────────────────────────┐
│  📊 Дополнительные параметры                 │
├─────────────────────────────────────────────┤
│                                              │
│  Налог: none ⓘ                               │
│  Способ расчета: full_payment ⓘ              │
│  Предмет расчета: service ⓘ                  │
│                                              │
│  ℹ️ Эти параметры для фискализации (54-ФЗ)  │
│  Обычно не требуют изменения                 │
│                                              │
└─────────────────────────────────────────────┘
```

### **Функционал:**

- Поля ввода для name и price
- Валидация: цена должна быть числом > 0
- Кнопка "Сохранить" → отправляет POST на /admin/api/update-product.php
- После сохранения показывается уведомление "✅ Сохранено"
- Автозагрузка текущих значений из products.json при открытии таба

### **Backend API:**

**Файл:** admin/api/update-product.php

**Что делает:**

1. Проверяет права администратора
2. Валидирует входные данные (название не пустое, цена > 0)
3. Читает server/storage/products.json
4. Обновляет поле premium_course
5. Сохраняет обратно в JSON
6. Возвращает { "success": true }

------

## **2️⃣ Таб: "Email-шаблоны"**

### **Назначение:**

Редактирование текста письма, которое приходит покупателю после оплаты

### **Интерфейс:**

```
┌─────────────────────────────────────────────────────────┐
│  ✉️ Email-шаблоны                                        │
│  Настройка писем, отправляемых пользователям            │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│  Письмо после оплаты                                     │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  Тема письма *                                           │
│  ┌────────────────────────────────────────────────────┐ │
│  │ Ваш доступ к курсу Clean - Теория правильной...    │ │
│  └────────────────────────────────────────────────────┘ │
│                                                          │
│  Текст письма *                                          │
│  ┌────────────────────────────────────────────────────┐ │
│  │ Здравствуйте!                                      │ │
│  │                                                    │ │
│  │ Спасибо за покупку курса «Clean - Теория...       │ │
│  │                                                    │ │
│  │ Ваши данные для входа в закрытую версию:          │ │
│  │ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━                     │ │
│  │                                                    │ │
│  │ Email:                                             │ │
│  │ {{email}}                                          │ │
│  │                                                    │ │
│  │ Пароль:                                            │ │
│  │ {{password}}                                       │ │
│  │                                                    │ │
│  │ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━                     │ │
│  │ ...                                                │ │
│  └────────────────────────────────────────────────────┘ │
│  ↕️ (8 строк)                                            │
│                                                          │
│  📝 Доступные переменные:                                │
│  {{email}} - Email покупателя                            │
│  {{password}} - Сгенерированный пароль                   │
│  {{site_url}} - Адрес сайта                              │
│  {{reply_to}} - Email поддержки                          │
│                                                          │
│  [Сохранить изменения]  [Сбросить по умолчанию]          │
│                                                          │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│  📧 Предпросмотр письма                                  │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  От: noreply@toosmart.ru                                 │
│  Кому: test@example.com                                  │
│  Тема: Ваш доступ к курсу Clean - Теория правильной...  │
│                                                          │
│  ┌────────────────────────────────────────────────────┐ │
│  │                                                    │ │
│  │  Здравствуйте!                                     │ │
│  │                                                    │ │
│  │  Спасибо за покупку курса «Clean - Теория...      │ │
│  │                                                    │ │
│  │  Ваши данные для входа в закрытую версию:         │ │
│  │  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━                    │ │
│  │                                                    │ │
│  │  Email:                                            │ │
│  │  test@example.com                                  │ │
│  │                                                    │ │
│  │  Пароль:                                           │ │
│  │  DemoPassword123                                   │ │
│  │                                                    │ │
│  │  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━                    │ │
│  │  ...                                               │ │
│  │                                                    │ │
│  └────────────────────────────────────────────────────┘ │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

### **Функционал:**

- Textarea для темы письма
- Большой textarea для тела письма (с подсветкой переменных {{...}})
- **Live-preview** - при вводе текста превью обновляется в реальном времени
- Плейсхолдеры заменяются на демо-значения для превью:
  - {{email}} → test@example.com
  - {{password}} → DemoPassword123
  - {{site_url}} → https://toosmart.ru
  - {{reply_to}} → support@toosmart.ru
- Кнопка "Сохранить" → POST на /admin/api/update-email-template.php
- Кнопка "Сбросить" → восстанавливает дефолтный шаблон

### **Backend API:**

**Файл:** admin/api/update-email-template.php

**Что делает:**

1. Проверяет права администратора
2. Валидирует: subject не пустой, body не пустой
3. Читает server/storage/email-templates.json
4. Обновляет welcome.subject и welcome.body
5. Сохраняет JSON
6. Возвращает { "success": true }

------

## **3️⃣ Таб: "Модальное окно успеха"**

### **Назначение:**

Редактирование текста модального окна, которое видит покупатель сразу после оплаты

### **Интерфейс:**

```
┌──────────────────────────────────────────────────────────┐
│  ✅ Модальное окно успешной оплаты                        │
│  Настройка окна, которое видит покупатель после оплаты   │
└──────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────┐
│  Тексты в модальном окне                                  │
├──────────────────────────────────────────────────────────┤
│                                                           │
│  Заголовок 1 (крупный) *                                  │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ ✅ Оплата прошла успешно!                            │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                           │
│  Заголовок 2 (средний) *                                  │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ Добро пожаловать в курс                              │ │
│  │ «Clean - Теория правильной уборки»                   │ │
│  └─────────────────────────────────────────────────────┘ │
│  ℹ️ Можно использовать <br> для переноса строки          │
│                                                           │
│  Подзаголовок блока с данными *                           │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ Ваши данные для входа:                               │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                           │
│  Подсказка под паролем *                                  │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ 💾 Пароль также отправлен на ваш email              │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                           │
│  Текст кнопки *                                           │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ Войти в курс                                         │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                           │
│  [Сохранить изменения]  [Сбросить по умолчанию]           │
│                                                           │
└──────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────┐
│  🖼️ Предпросмотр модального окна                         │
├──────────────────────────────────────────────────────────┤
│                                                           │
│  ┌────────────────────────────────────────────────────┐  │
│  │                                                    │  │
│  │      ✅ Оплата прошла успешно!                     │  │
│  │      Добро пожаловать в курс                       │  │
│  │      «Clean - Теория правильной уборки»            │  │
│  │                                                    │  │
│  │  ┌──────────────────────────────────────────────┐ │  │
│  │  │                                              │ │  │
│  │  │  Ваши данные для входа:                      │ │  │
│  │  │                                              │ │  │
│  │  │  Email:                                      │ │  │
│  │  │  test@example.com                            │ │  │
│  │  │                                              │ │  │
│  │  │  Пароль:                                     │ │  │
│  │  │  DemoPassword123                             │ │  │
│  │  │                                              │ │  │
│  │  │  💾 Пароль также отправлен на ваш email     │ │  │
│  │  │                                              │ │  │
│  │  └──────────────────────────────────────────────┘ │  │
│  │                                                    │  │
│  │      [     Войти в курс     ]                      │  │
│  │                                                    │  │
│  └────────────────────────────────────────────────────┘  │
│                                                           │
│  ℹ️ Реальный вид на сайте может немного отличаться       │
│                                                           │
└──────────────────────────────────────────────────────────┘
```

### **Функционал:**

- 5 полей ввода для разных текстов
- **Live-preview** модального окна в реальном стиле сайта
- Превью использует демо-данные:
  - Email: test@example.com
  - Пароль: DemoPassword123
- При изменении текста превью обновляется в реальном времени
- Кнопка "Сохранить" → генерирует новый HTML-шаблон и сохраняет
- Кнопка "Сбросить" → восстанавливает дефолтный текст

### **Backend API:**

**Файл:** admin/api/update-success-modal.php

**Что делает:**

1. Проверяет права администратора

2. Принимает JSON с полями:

   ```json
   {
     "heading1": "✅ Оплата прошла успешно!",
     "heading2": "Добро пожаловать в курс<br>«Clean - Теория правильной уборки»",
     "credentials_label": "Ваши данные для входа:",
     "hint": "💾 Пароль также отправлен на ваш email",
     "button_text": "Войти в курс"
   }
   ```

3. Генерирует новый HTML-файл payment-success.html с этими текстами

4. Сохраняет в server/templates/payment-success.html

5. Возвращает { "success": true }

------

## **Архитектура админки**

### **Структура файлов:**

```
/admin/
├── index.html                      # Главная страница (уже есть)
├── server.js                       # Proxy сервер (уже есть)
├── api/
│   ├── update-product.php          # Сохранение настроек продукта
│   ├── update-email-template.php   # Сохранение email-шаблона
│   ├── update-success-modal.php    # Сохранение модального окна
│   ├── get-product.php             # Получение текущих настроек продукта
│   ├── get-email-template.php      # Получение текущего email-шаблона
│   └── get-success-modal.php       # Получение текущих текстов модалки
└── assets/
    ├── tabs.js                     # Логика переключения табов
    └── admin.css                   # Стили (уже есть в index.html)
```

------

## **Технические детали**

### **1. Авторизация**

Все API-эндпоинты должны проверять:

```php
require_once __DIR__ . '/../../server/config.php';
require_once __DIR__ . '/../../server/security.php';

Config::load();
Security::initSession();

// Проверка админского токена
$token = $_SERVER['HTTP_X_ADMIN_TOKEN'] ?? '';
$expected = Config::get('ADMIN_TOKEN');

if (!hash_equals($expected, $token)) {
    http_response_code(403);
    die(json_encode(['error' => 'forbidden']));
}
```

### **2. Валидация данных**

**Для продукта:**

- name: не пустая строка, <= 255 символов
- price: число, > 0, <= 999999

**Для email-шаблона:**

- subject: не пустая строка, <= 255 символов
- body: не пустая строка, <= 10000 символов
- Должен содержать {{email}} и {{password}}

**Для модального окна:**

- Все поля: не пустые строки, <= 500 символов каждое
- Разрешены HTML-теги: <br>, <strong>, <em>

### **3. Live Preview**

**Для email:**

```javascript
// При изменении textarea
document.getElementById('email-body').addEventListener('input', function(e) {
  let text = e.target.value;
  
  // Заменяем плейсхолдеры на демо-данные
  text = text.replace(/\{\{email\}\}/g, 'test@example.com');
  text = text.replace(/\{\{password\}\}/g, 'DemoPassword123');
  text = text.replace(/\{\{site_url\}\}/g, 'https://toosmart.ru');
  text = text.replace(/\{\{reply_to\}\}/g, 'support@toosmart.ru');
  
  // Обновляем превью
  document.getElementById('email-preview').textContent = text;
});
```

**Для модального окна:**

```javascript
// При изменении любого поля
function updateModalPreview() {
  const heading1 = document.getElementById('heading1').value;
  const heading2 = document.getElementById('heading2').value;
  // ... и т.д.
  
  // Обновляем HTML превью
  document.getElementById('preview-heading1').innerHTML = heading1;
  document.getElementById('preview-heading2').innerHTML = heading2;
  // ...
}

// Навешиваем на все поля
document.querySelectorAll('.modal-field').forEach(field => {
  field.addEventListener('input', updateModalPreview);
});
```

------

## **Безопасность**

1. **Все API только через POST** (кроме GET для получения данных)
2. **CSRF-защита** через токен в заголовках
3. **Валидация и санитизация** всех входных данных
4. **HTML-экранирование** при выводе в превью
5. **Ограничение длины** полей
6. **Whitelist HTML-тегов** для модального окна (только <br>, <strong>, <em>)

------

## **Итоговая структура табов в админке**

```
┌────────────────────────────────────────────────────────┐
│  [Заказы] [Настройки продукта] [Email] [Модалка успеха]│
└────────────────────────────────────────────────────────┘
        ▲            ▲               ▲           ▲
        │            │               │           │
   (уже есть)    (новый)         (новый)     (новый)
```

------

## **Что получится:**

✅ **Одно место для управления всем контентом**
✅ **Не нужно лезть в код** - все через интерфейс
✅ **Live preview** - сразу видно результат
✅ **Безопасно** - авторизация + валидация
✅ **Удобно** - отдельные поля для каждого текста





