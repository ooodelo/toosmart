# Детальный аудит кода TooSmart

**Дата аудита**: 18 ноября 2025
**Версия документации**: v1.1

---

## 1. Общая оценка

### Степень соответствия реализации документации: **85%**

Проект в целом реализован согласно техническому заданию и архитектурной документации. Основные компоненты работают корректно, однако выявлен ряд критических ошибок в коде и несколько расхождений с требованиями документации.

---

## 2. Критические ошибки и баги

### 2.1. КРИТИЧЕСКИЕ (требуют немедленного исправления)

#### 1. XSS уязвимость в legal-modals.js
**Файл**: `src/legal-modals.js:98`
**Проблема**: Использование `innerHTML` без санитизации
**Риск**: Высокий - возможна XSS атака
**Рекомендация**: Использовать DOMPurify или textContent

#### 2. Логическая ошибка в mode-utils.js
**Файл**: `src/mode-utils.js:126`
**Проблема**: `getClientRects` возвращает DOMRectList, но код ожидает DOMRect
**Код**:
```javascript
const r = root.getClientRects(); // Возвращает DOMRectList, не DOMRect
```
**Рекомендация**: Использовать `getBoundingClientRect()` или `getClientRects()[0]`

#### 3. Открытый CORS в админ-панели
**Файл**: `admin/server.js:39`
**Проблема**: `Access-Control-Allow-Origin: *`
**Риск**: Высокий - любой сайт может отправлять запросы
**Рекомендация**: Ограничить allowed origins до localhost

#### 4. Debug информация в production
**Файл**: `scripts/lib/build.js:1141`
**Проблема**: Выводится информация о пути к файлам в production сборке
**Риск**: Средний - утечка структуры проекта
**Рекомендация**: Использовать переменную DEBUG для условного вывода

---

### 2.2. ВЫСОКИЙ ПРИОРИТЕТ

#### 5. Неработающая логика в extractLogicalIntro
**Файл**: `scripts/lib/build.js:621-623, 631-633`
**Проблема**: Бессмысленный код - обе ветки присваивают одинаковое значение
```javascript
const paragraphCount = hasIntroductionKeyword(h2Token.text)
  ? MAX_INTRO_PARAGRAPHS
  : MAX_INTRO_PARAGRAPHS; // Одно и то же значение!
```
**Описание**: По документации, алгоритм должен различать количество параграфов в зависимости от наличия слова "введение", но код игнорирует результат проверки
**Рекомендация**: Исправить на разные значения (например, 3 vs 1-2)

#### 6. Неправильная валидация email
**Файл**: `src/cta.js:116`
**Проблема**: Использует базовый regex, не соответствующий RFC 5322
**Рекомендация**: Использовать проверенную библиотеку или HTML5 validation

#### 7. Потенциальный доступ к null
**Файл**: `src/cta.js:99-100`
**Проблема**: Нет проверки на null перед использованием DOM элементов
```javascript
const modal = document.getElementById('cta-modal');
modal.classList.add('active'); // Может быть null
```
**Рекомендация**: Добавить null-check

#### 8. Отсутствие обработки ошибок
**Файл**: `scripts/lib/build.js:113-157`
**Проблема**: Нет try-catch для операций файловой системы
**Рекомендация**: Добавить обработку ошибок с информативными сообщениями

#### 9. Потенциальные утечки памяти
**Файл**: `src/script.js` (множественные места)
**Проблема**: Event listeners не всегда удаляются при очистке
**Рекомендация**: Использовать AbortController или централизованную систему очистки

---

### 2.3. СРЕДНИЙ ПРИОРИТЕТ

#### 10. Магические числа без констант
**Файлы**: `src/script.js`, `scripts/lib/build.js`
**Проблема**: Числовые значения без именованных констант
```javascript
if (width < 768) { ... }  // Что такое 768?
```
**Рекомендация**: Вынести в именованные константы (BREAKPOINT_MOBILE = 768)

#### 11. Дублирование кода в template файлах
**Файлы**: `src/template.html`, `src/template-full.html`, `src/template-paywall.html`
**Проблема**: Cookie Banner и Legal Modals повторяются во всех шаблонах
**Рекомендация**: Использовать включаемые частичные шаблоны

#### 12. Закомментированный код
**Множественные файлы**
**Проблема**: Оставлен закомментированный код без объяснения
**Рекомендация**: Удалить или добавить комментарий с причиной сохранения

---

## 3. Расхождения с документацией

### 3.1. Частично реализовано / Отклонения

| Требование | Статус | Описание расхождения |
|------------|--------|---------------------|
| **Cookie Banner в конфиге** | Не реализовано | По документации должен быть `cookiesBannerEnabled: true/false` в site.json, но в конфиге этого поля нет |
| **Cookie Banner в основном шаблоне** | Не реализовано | Cookie Banner реализован только в template-full.html и template-paywall.html, но отсутствует в основном template.html |
| **Различие параграфов в логическом введении** | Баг | По документации алгоритм должен различать количество параграфов (1-3 vs полный блок) в зависимости от "введение", но код всегда использует MAX_INTRO_PARAGRAPHS |
| **data-analytics атрибуты** | Частично | По документации CTA кнопка должна иметь `data-analytics="cta-premium"`, но не все кнопки имеют этот атрибут |
| **wordsPerMinute** | Расхождение | В документации указано 200 слов/мин, в config/site.json установлено 180 |

### 3.2. Полностью реализовано (соответствует)

| Компонент | Статус | Примечание |
|-----------|--------|------------|
| Структура контента (intro/course/appendix/recommendations/legal) | OK | Полное соответствие |
| extractLogicalIntro с ветками A/B/C | OK | Алгоритм реализован (кроме бага с paragraphCount) |
| Progress Widget | OK | Реализован с data-page-type, data-button-text, data-next-page |
| Карусель рекомендаций | OK | recommendations.json генерируется, JS загружает динамически |
| SEO (robots.txt, sitemap.xml) | OK | Генерируются корректно |
| Schema.org микроразметка | OK | Course, WebPage, Article схемы |
| Навигация Free/Premium | OK | Линейная цепь intro → course → appendix |
| Меню с типами контента | OK | Соответствует документации |
| Robokassa интеграция | OK | create-invoice.php, callback, success |
| PHP авторизация | OK | Sessions, CSRF, rate limiting |
| Защита premium через .htaccess | OK | Реализовано |
| Legal Modals | OK | Оферта, политика, cookies |

---

## 4. Структурный анализ

### 4.1. Архитектура

**Соответствие**: 90%

Архитектура соответствует описанию в ARCHITECTURE_v1.1.md:
- Static Site Generator с freemium моделью
- Три выходные директории (free, premium, shared)
- PHP backend для авторизации и платежей
- Node.js для сборки

### 4.2. Модули сборки

| Модуль | Статус | Примечание |
|--------|--------|------------|
| Parser Markdown | OK | marked + DOMPurify |
| Logical Intro Extractor | БАГИ | Работает, но логика с "введение" не различает параграфы |
| Reading Time Calculator | OK | Формат соответствует |
| Menu Generator | OK | buildMenuItems() для free/premium |
| Free Page Generator | OK | buildFree() |
| Premium Page Generator | OK | buildPremium() |
| Recommendations Builder | OK | JSON + HTML |
| SEO Generator | OK | robots, sitemap, meta |
| Config Manager | OK | loadSiteConfig() |

### 4.3. Компоненты фронтенда

| Компонент | Статус | Примечание |
|-----------|--------|------------|
| Premium Teaser (blur) | OK | CSS blur эффект |
| CTA Button | OK | Модальное окно, форма |
| Progress Widget | OK | Круг → кнопка "Далее" |
| Sidebar Menu | OK | Адаптивное меню |
| Recommendations Carousel | OK | Динамическая загрузка JSON |
| Legal Modals | OK | Все документы |
| Cookie Banner | Частично | Только в 2 из 3 шаблонов |

---

## 5. Безопасность

### 5.1. Реализованные меры

- CSRF Protection
- Rate Limiting (5 попыток за 15 мин)
- XSS Prevention (DOMPurify)
- Password Hashing (bcrypt)
- Secure Sessions
- File Locking (flock)
- Secure Logging

### 5.2. Выявленные уязвимости

1. **XSS в legal-modals.js** - innerHTML без санитизации
2. **Открытый CORS** в админ-панели
3. **Отсутствие CSP headers** в PHP ответах

---

## 6. Рекомендации по улучшению

### 6.1. Немедленные действия (Критические исправления)

1. Исправить XSS уязвимость в `legal-modals.js`
2. Исправить CORS в `admin/server.js`
3. Исправить логическую ошибку в `mode-utils.js:126`
4. Убрать debug информацию из production сборки

### 6.2. Краткосрочные действия

1. Исправить баг в `extractLogicalIntro` - должен различать количество параграфов
2. Добавить Cookie Banner в основной `template.html`
3. Добавить `cookiesBannerEnabled` в конфиг
4. Добавить `data-analytics` на все CTA кнопки
5. Привести `wordsPerMinute` к единому значению (200 или 180)
6. Добавить null-checks для DOM элементов

### 6.3. Среднесрочные действия

1. Вынести магические числа в константы
2. Унифицировать шаблоны (частичные include)
3. Добавить unit-тесты для критических функций
4. Добавить JSDoc типизацию
5. Очистить закомментированный код

### 6.4. Долгосрочные улучшения

1. Миграция с JSON на SQLite/PostgreSQL для масштабирования
2. Добавить e2e тесты
3. Рассмотреть переход на TypeScript
4. Добавить CI/CD pipeline

---

## 7. Итоговая оценка по категориям

| Категория | Оценка | Комментарий |
|-----------|--------|-------------|
| **Функциональность** | 85% | Основной функционал работает, есть баги |
| **Соответствие документации** | 85% | Большинство требований реализовано |
| **Качество кода** | 70% | Дублирование, магические числа, нет типизации |
| **Безопасность** | 75% | Основные меры есть, критические уязвимости |
| **Тестируемость** | 50% | Нет unit-тестов, только link-linter |
| **Поддерживаемость** | 70% | Код читаем, но требует рефакторинга |

**Общая оценка: 73/100**

---

## 8. Заключение

Проект TooSmart в целом реализует требования технического задания. Архитектура соответствует документации, основные компоненты работают. Однако обнаружены критические уязвимости безопасности (XSS, CORS) и логические ошибки в коде (extractLogicalIntro), которые требуют немедленного исправления.

Рекомендуется:
1. **Срочно** исправить 4 критические проблемы
2. **В течение недели** исправить 5 проблем высокого приоритета
3. **Планово** провести рефакторинг и добавить тесты

---

## Приложения

- `CODE_AUDIT_REPORT.md` - детальный отчет о найденных проблемах в коде
- `CRITICAL_FIXES_NEEDED.md` - инструкции по исправлению критических ошибок
