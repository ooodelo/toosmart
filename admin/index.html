<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</title>
  <style>
    :root {
      --bg-page: #f8fafc;
      --bg-card: #ffffff;
      --bg-hover: #f1f5f9;
      --bg-active: #e2e8f0;
      --bg-dark: #1e293b;

      --text-primary: #0f172a;
      --text-secondary: #475569;
      --text-muted: #94a3b8;
      --text-inverse: #ffffff;

      --border-light: #e2e8f0;
      --border-medium: #cbd5e1;
      --border-focus: #3b82f6;

      --accent: #3b82f6;
      --accent-hover: #2563eb;
      --accent-soft: rgba(59, 130, 246, 0.1);

      --success: #10b981;
      --success-soft: rgba(16, 185, 129, 0.1);
      --warning: #f59e0b;
      --warning-soft: rgba(245, 158, 11, 0.1);
      --danger: #ef4444;
      --danger-soft: rgba(239, 68, 68, 0.1);

      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);

      --radius-sm: 8px;
      --radius-md: 14px;
      --radius-lg: 22px;

      --transition: 0.15s ease;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-page);
      color: var(--text-primary);
      line-height: 1.5;
      min-height: 100vh;
    }

    .app {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    .header {
      background: var(--bg-card);
      border-bottom: 1px solid var(--border-light);
      padding: 12px 24px;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-inner {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .brand-logo {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .brand-title {
      font-weight: 600;
      font-size: 15px;
    }

    .status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--text-muted);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
    }

    .main {
      flex: 1;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px 24px;
      width: 100%;
    }

    .tabs {
      display: flex;
      gap: 4px;
      background: var(--bg-card);
      padding: 5px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-sm);
      margin-bottom: 20px;
    }

    .tab {
      flex: 1;
      padding: 12px 20px;
      border: none;
      background: transparent;
      border-radius: var(--radius-md);
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .tab:hover {
      background: var(--bg-hover);
    }

    .tab.active {
      background: var(--accent);
      color: var(--text-inverse);
    }

    .section {
      display: none;
    }

    .section.active {
      display: block;
    }

    .section-header {
      margin-bottom: 16px;
    }

    .section-title {
      font-size: 18px;
      font-weight: 600;
    }

    .section-subtitle {
      font-size: 13px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-light);
      margin-bottom: 16px;
      overflow: hidden;
      box-shadow: 0 14px 28px rgba(15, 23, 42, 0.12), 0 10px 10px rgba(15, 23, 42, 0.08);
    }

    .card-header {
      padding: 14px 18px;
      border-bottom: 1px solid var(--border-light);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .card-title {
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-body {
      padding: 18px;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }

    .grid-3 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }

    @media (max-width: 768px) {

      .grid-2,
      .grid-3 {
        grid-template-columns: 1fr;
      }
    }

    .form-group {
      margin-bottom: 14px;
    }

    .form-group:last-child {
      margin-bottom: 0;
    }

    .form-label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 5px;
    }

    .form-hint {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 9px 12px;
      border: 1px solid var(--border-medium);
      border-radius: var(--radius-md);
      font-size: 13px;
      background: var(--bg-card);
      transition: var(--transition);
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: var(--border-focus);
      box-shadow: 0 0 0 3px var(--accent-soft);
    }

    .form-input.readonly {
      background: var(--bg-hover);
      color: var(--text-muted);
    }

    .form-textarea {
      resize: vertical;
      min-height: 70px;
    }

    .form-row {
      display: flex;
      gap: 12px;
    }

    .form-row .form-group {
      flex: 1;
    }

    .form-checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      cursor: pointer;
    }

    .form-checkbox input {
      width: 16px;
      height: 16px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 9px 16px;
      border: none;
      border-radius: var(--radius-md);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
      white-space: nowrap;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-primary {
      background: var(--accent);
      color: var(--text-inverse);
    }

    .btn-primary:hover:not(:disabled) {
      background: var(--accent-hover);
    }

    .btn-success {
      background: var(--success);
      color: var(--text-inverse);
    }

    .btn-warning {
      background: var(--warning);
      color: var(--text-inverse);
    }

    .btn-outline {
      background: transparent;
      border: 1px solid var(--border-medium);
      color: var(--text-secondary);
    }

    .btn-outline:hover:not(:disabled) {
      background: var(--bg-hover);
    }

    .btn-ghost {
      background: transparent;
      color: var(--text-secondary);
    }

    .btn-ghost:hover {
      background: var(--bg-hover);
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 12px;
    }

    .btn-lg {
      padding: 12px 24px;
      font-size: 14px;
    }

    .btn-group {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 500;
    }

    .badge-primary {
      background: var(--accent-soft);
      color: var(--accent);
    }

    .badge-success {
      background: var(--success-soft);
      color: var(--success);
    }

    .badge-warning {
      background: var(--warning-soft);
      color: var(--warning);
    }

    .badge-danger {
      background: var(--danger-soft);
      color: var(--danger);
    }

    .badge-muted {
      background: var(--bg-hover);
      color: var(--text-muted);
    }

    .filters {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .filter-chips {
      display: flex;
      gap: 6px;
    }

    .chip {
      padding: 6px 12px;
      border: 1px solid var(--border-light);
      border-radius: 999px;
      font-size: 12px;
      background: var(--bg-card);
      color: var(--text-secondary);
      cursor: pointer;
      transition: var(--transition);
    }

    .chip:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .chip.active {
      background: var(--accent);
      border-color: var(--accent);
      color: var(--text-inverse);
    }

    .search-box {
      flex: 1;
      min-width: 180px;
      max-width: 280px;
      position: relative;
    }

    .search-box input {
      width: 100%;
      padding: 7px 12px 7px 32px;
      border: 1px solid var(--border-light);
      border-radius: var(--radius-md);
      font-size: 13px;
    }

    .search-box::before {
      content: 'üîç';
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 12px;
    }

    .content-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .content-card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      overflow: hidden;
      box-shadow: 0 14px 28px rgba(15, 23, 42, 0.12), 0 10px 10px rgba(15, 23, 42, 0.08);
      transition: var(--transition);
      border: 1px solid var(--border-light);
    }

    .content-card:hover {
      border-color: var(--border-medium);
    }

    .content-card.expanded {
      border-color: var(--accent);
      box-shadow: 0 16px 32px rgba(37, 99, 235, 0.16), 0 12px 12px rgba(15, 23, 42, 0.08);
    }

    .content-card-header {
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
    }

    .content-card-header:hover {
      background: var(--bg-hover);
    }

    .content-card-icon {
      width: 32px;
      height: 32px;
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
    }

    .type-article {
      background: #e0e7ff;
      color: #4338ca;
    }

    .type-appendix {
      background: #fce7f3;
      color: #db2777;
    }

    .type-intro {
      background: #dcfce7;
      color: #15803d;
    }

    .type-recommendation {
      background: #fef3c7;
      color: #c2410c;
    }

    .type-legal {
      background: #e2e8f0;
      color: #475569;
    }

    .content-card-info {
      flex: 1;
      min-width: 0;
    }

    .content-card-title {
      font-weight: 600;
      font-size: 13px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .content-card-meta {
      font-size: 11px;
      color: var(--text-muted);
    }

    .content-card-status {
      font-size: 11px;
      color: var(--text-muted);
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .content-card-badges {
      display: flex;
      gap: 6px;
      flex-shrink: 0;
    }

    .content-card-toggle {
      width: 26px;
      height: 26px;
      border: none;
      background: var(--bg-hover);
      border-radius: var(--radius-sm);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }

    .content-card.expanded .content-card-toggle {
      transform: rotate(180deg);
    }

    .content-card-body {
      display: none;
      padding: 16px;
      border-top: 1px solid var(--border-light);
      background: var(--bg-hover);
    }

    .content-card.expanded .content-card-body {
      display: block;
    }

    .field-block {
      background: var(--bg-card);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-md);
      padding: 14px;
      margin-bottom: 12px;
    }

    .field-block:last-child {
      margin-bottom: 0;
    }

    .field-block-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border-light);
    }

    .field-block-title {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-secondary);
    }

    .paywall-editor {
      background: var(--bg-card);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-md);
      padding: 16px;
    }

    .paywall-controls {
      display: flex;
      gap: 24px;
      margin-bottom: 16px;
      flex-wrap: wrap;
      align-items: flex-end;
    }

    .paywall-control {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .paywall-control label {
      font-size: 12px;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .paywall-control-value {
      font-size: 18px;
      font-weight: 700;
      color: var(--accent);
    }

    .paywall-slider {
      width: 260px;
      height: 8px;
      -webkit-appearance: none;
      background: var(--border-light);
      border-radius: 4px;
      outline: none;
    }

    .paywall-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--accent);
      cursor: pointer;
      box-shadow: var(--shadow-md);
    }

    .paywall-preview-vertical {
      display: flex;
      flex-direction: column;
      gap: 0;
      margin-top: 16px;
      border-radius: var(--radius-md);
      overflow: hidden;
      border: 1px solid var(--border-light);
    }

    .paywall-section-v {
      padding: 12px;
      position: relative;
      background: var(--bg-card);
    }

    .paywall-section-v::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
    }

    .paywall-open-v {
      background: var(--success-soft);
    }

    .paywall-open-v::before {
      background: var(--success);
    }

    .paywall-teaser-v {
      background: var(--warning-soft);
    }

    .paywall-teaser-v::before {
      background: var(--warning);
    }

    .paywall-hidden-v {
      background: var(--bg-hover);
    }

    .paywall-hidden-v::before {
      background: var(--border-medium);
    }

    .paywall-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .paywall-section-label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .paywall-section-count {
      font-size: 12px;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.8);
    }

    .paywall-blocks {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .paywall-blocks p {
      margin: 0;
      font-size: 12px;
      line-height: 1.5;
    }

    .paywall-block {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px dashed var(--border-light);
      background: rgba(255, 255, 255, 0.85);
      color: var(--text-primary);
    }

    .paywall-block :is(p, li, h2, h3, h4) {
      margin: 0;
      font-size: 12px;
      line-height: 1.5;
    }

    .paywall-block .article-divider {
      display: block;
      height: 1px;
      background: var(--border-medium);
      margin: 6px 0;
      border-radius: 999px;
    }

    .paywall-block .section-label {
      display: inline-block;
      padding: 4px 6px;
      font-size: 10px;
      letter-spacing: 0.4px;
      text-transform: uppercase;
      color: var(--text-secondary);
      border: 1px solid var(--border-light);
      border-radius: 8px;
      background: var(--bg-hover);
    }

    .paywall-block :is(.article-lead, .article-subtitle) {
      background: var(--bg-hover);
      border-radius: 8px;
      padding: 6px 8px;
      margin: 4px 0;
      font-weight: 600;
    }

    .paywall-block :is(.article-card, .component-card, .product-list, .pullquote, .number-callout, .two-column-compare, .checklist, footer.article-footer) {
      border: 1px dashed var(--border-light);
      border-radius: 10px;
      padding: 8px;
      background: var(--bg-page);
    }

    .paywall-block blockquote {
      margin: 4px 0;
      padding-left: 10px;
      border-left: 2px solid var(--border-medium);
      color: var(--text-secondary);
    }

    .paywall-block-placeholder {
      color: var(--text-muted);
      font-style: italic;
      text-align: center;
      font-size: 12px;
    }

    .logs {
      background: var(--bg-dark);
      border-radius: var(--radius-md);
      padding: 14px;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 12px;
      color: #e2e8f0;
      max-height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
    }

    .logs:empty::before {
      content: '–õ–æ–≥–∏ –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ —Å–±–æ—Ä–∫–∏...';
      color: #64748b;
    }

    .editor-layout {
      display: grid;
      grid-template-columns: 240px 1fr;
      gap: 16px;
    }

    @media (max-width: 800px) {
      .editor-layout {
        grid-template-columns: 1fr;
      }
    }

    .editor-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .editor-item {
      padding: 10px 12px;
      border: 1px solid var(--border-light);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: var(--transition);
    }

    .editor-item:hover {
      border-color: var(--accent);
    }

    .editor-item.active {
      border-color: var(--accent);
      background: var(--accent-soft);
    }

    .editor-item-title {
      font-weight: 500;
      font-size: 13px;
    }

    .editor-item-path {
      font-size: 11px;
      color: var(--text-muted);
    }

    .editor-topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      gap: 8px;
      flex-wrap: wrap;
    }

    .mode-switch {
      display: inline-flex;
      border: 1px solid var(--border-light);
      border-radius: var(--radius-md);
      overflow: hidden;
    }

    .mode-switch button {
      border: none;
      background: transparent;
      padding: 6px 10px;
      font-size: 12px;
      cursor: pointer;
      color: var(--text-secondary);
    }

    .mode-switch button.active {
      background: var(--accent);
      color: var(--text-inverse);
    }

    .editor-toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 8px;
    }

    .editor-toolbar button {
      border: 1px solid var(--border-light);
      background: var(--bg-card);
      border-radius: 8px;
      padding: 6px 10px;
      font-size: 12px;
      cursor: pointer;
      color: var(--text-secondary);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .editor-toolbar button:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .wysiwyg-frame {
      width: 100%;
      min-height: 320px;
      border: 1px solid var(--border-medium);
      border-radius: var(--radius-md);
      background: var(--bg-card);
    }

    .code-area {
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 12px;
      min-height: 320px;
      line-height: 1.5;
      width: 100%;
    }

    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 12px 18px;
      border-radius: var(--radius-md);
      background: var(--text-primary);
      color: var(--text-inverse);
      font-size: 13px;
      font-weight: 500;
      box-shadow: var(--shadow-lg);
      transform: translateY(100px);
      opacity: 0;
      transition: var(--transition);
      z-index: 1000;
    }

    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }

    .toast.success {
      background: var(--success);
    }

    .toast.error {
      background: var(--danger);
    }

    .fixed-save {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 52px;
      height: 52px;
      border-radius: 50%;
      background: var(--accent);
      color: var(--text-inverse);
      border: none;
      box-shadow: var(--shadow-lg);
      cursor: pointer;
      font-size: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
      z-index: 99;
    }

    .fixed-save:hover {
      transform: scale(1.1);
      background: var(--accent-hover);
    }

    .stats {
      display: flex;
      gap: 20px;
      margin-bottom: 16px;
    }

    .stat-value {
      font-size: 20px;
      font-weight: 700;
    }

    .stat-label {
      font-size: 12px;
      color: var(--text-muted);
    }

    .menu-preview {
      background: var(--bg-hover);
      border-radius: var(--radius-md);
      padding: 14px;
    }

    .menu-preview-title {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      margin-bottom: 10px;
    }

    .menu-item {
      padding: 6px 0;
      border-bottom: 1px dashed var(--border-light);
    }

    .menu-item:last-child {
      border-bottom: none;
    }

    .menu-item-label {
      font-weight: 500;
      font-size: 13px;
    }

    .menu-item-subtitle {
      font-size: 11px;
      color: var(--text-muted);
    }
  </style>
</head>

<body>
  <div class="app">
    <header class="header">
      <div class="header-inner">
        <div class="brand">
          <div class="brand-logo">‚öôÔ∏è</div>
          <div class="brand-title">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</div>
        </div>
        <div class="status" id="statusBar">
          <div class="status-dot"></div>
          <span id="statusText">–ì–æ—Ç–æ–≤–æ</span>
        </div>
      </div>
    </header>

    <main class="main">
      <nav class="tabs">
        <button class="tab active" data-section="content">üìö –ö–æ–Ω—Ç–µ–Ω—Ç</button>
        <button class="tab" data-section="settings">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        <button class="tab" data-section="build">üöÄ –°–±–æ—Ä–∫–∞</button>
      </nav>

      <section class="section active" data-section="content">
        <div class="section-header">
          <h1 class="section-title">–ö–æ–Ω—Ç–µ–Ω—Ç</h1>
          <p class="section-subtitle">SEO, –º–µ–Ω—é –∏ paywall –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞</p>
        </div>

        <div class="filters">
          <div class="filter-chips" id="typeFilters">
            <button class="chip active" data-type="all">–í—Å–µ</button>
            <button class="chip" data-type="article">–°—Ç–∞—Ç—å–∏</button>
            <button class="chip" data-type="appendix">Appendix</button>
            <button class="chip" data-type="recommendation">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</button>
            <button class="chip" data-type="legal">Legal</button>
          </div>
          <div class="search-box">
            <input type="search" id="searchInput" placeholder="–ü–æ–∏—Å–∫...">
          </div>
        </div>

        <div class="stats">
          <div>
            <div class="stat-value" id="statTotal">0</div>
            <div class="stat-label">–í—Å–µ–≥–æ</div>
          </div>
          <div>
            <div class="stat-value" id="statFilled">0</div>
            <div class="stat-label">–ó–∞–ø–æ–ª–Ω–µ–Ω–æ</div>
          </div>
          <div>
            <div class="stat-value" style="color: var(--warning);" id="statAttention">0</div>
            <div class="stat-label">–¢—Ä–µ–±—É—é—Ç –≤–Ω–∏–º–∞–Ω–∏—è</div>
          </div>
        </div>

        <div class="content-list" id="contentList">
          <div class="card">
            <div class="card-body">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
          </div>
        </div>

        <div class="card" style="margin-top: 20px;">
          <div class="card-header">
            <div class="card-title">üëÅÔ∏è –ü—Ä–µ–≤—å—é –º–µ–Ω—é</div>
          </div>
          <div class="card-body">
            <div class="grid-3" id="menuPreview">
              <div class="menu-preview">
                <div class="menu-preview-title">–†–∞–∑–¥–µ–ª—ã –∫—É—Ä—Å–∞</div>
              </div>
              <div class="menu-preview">
                <div class="menu-preview-title">–ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è</div>
              </div>
              <div class="menu-preview">
                <div class="menu-preview-title">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</div>
              </div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top: 20px;">
          <div class="card-header">
            <div class="card-title">üñº –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>
            <div class="filter-chips" id="imagesFilters" style="gap: 8px; flex-wrap: wrap;">
              <button class="chip active" data-img-filter="all">–í—Å–µ</button>
              <button class="chip" data-img-filter="missing">–ë–µ–∑ alt</button>
              <button class="chip" data-img-filter="markdown">Markdown</button>
              <button class="chip" data-img-filter="static">–°—Ç–∞—Ç–∏–∫–∞</button>
              <button class="chip" data-img-filter="upload">–ó–∞–≥—Ä—É–∑–∫–∏</button>
            </div>
          </div>
          <div class="card-body">
            <div class="form-row" style="gap:12px; align-items:flex-end;">
              <div class="form-group" style="flex:1;">
                <label class="form-label">–ü–æ–∏—Å–∫</label>
                <input type="search" class="form-input" id="imagesSearch" placeholder="–ü—É—Ç—å, –∏–º—è, alt...">
              </div>
              <div class="form-group" style="width:220px;">
                <label class="form-label">–ó–∞–≥—Ä—É–∑–∫–∞</label>
                <input type="file" accept="image/*" id="imageUploadInput">
              </div>
            </div>
            <div id="imagesList" class="content-list" style="margin-top:12px;">
              <div class="card">
                <div class="card-body">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π...</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="section" data-section="settings">
        <div class="section-header">
          <h1 class="section-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1>
          <p class="section-subtitle">–¶–µ–Ω—ã, CTA, Robokassa, legal, SEO</p>
        </div>

        <div class="grid-2">
          <div class="card">
            <div class="card-header">
              <div class="card-title">üí∞ –¶–µ–Ω—ã</div>
            </div>
            <div class="card-body">
              <div class="form-row">
                <div class="form-group"><label class="form-label">–°—Ç–∞—Ä–∞—è —Ü–µ–Ω–∞</label><input type="number"
                    class="form-input" id="originalAmount" placeholder="–ù–∞–ø—Ä. 10000"></div>
                <div class="form-group"><label class="form-label">–ê–∫—Ç—É–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞</label><input type="number"
                    class="form-input" id="currentAmount" placeholder="–ù–∞–ø—Ä. 3400"></div>
                <div class="form-group"><label class="form-label">–í–∞–ª—é—Ç–∞</label><select class="form-select"
                    id="currency">
                    <option value="RUB">RUB (‚ÇΩ)</option>
                    <option value="USD">USD ($)</option>
                    <option value="EUR">EUR (‚Ç¨)</option>
                  </select></div>
              </div>
              <p style="font-size:12px; color: var(--text-muted); margin-top: 8px;">–°—Ç–∞—Ä–∞—è —Ü–µ–Ω–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è
                –ø–µ—Ä–µ—á—ë—Ä–∫–Ω—É—Ç–æ–π, –∞–∫—Ç—É–∞–ª—å–Ω–∞—è —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ —Ä–∞—Å—á—ë—Ç–∞—Ö –∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞—Ö.</p>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-title">üè∑Ô∏è –ü—Ä–æ–º–æ–∫–æ–¥ (–ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä)</div>
            </div>
            <div class="card-body">
              <div class="form-row">
                <div class="form-group" style="flex:1;"><label class="form-label">–ö–æ–¥</label><input type="text"
                    class="form-input" id="promoCodePreview" placeholder="PROMO2025"></div>
                <div class="form-group" style="width:160px;"><label class="form-label">–¢–∏–ø</label><select
                    class="form-select" id="promoTypePreview">
                    <option value="percent">% —Å–∫–∏–¥–∫–∞</option>
                    <option value="fixed">–§–∏–∫—Å. —Å—É–º–º–∞</option>
                  </select></div>
                <div class="form-group" style="width:140px;"><label class="form-label">–ó–Ω–∞—á–µ–Ω–∏–µ</label><input
                    type="number" class="form-input" id="promoValuePreview" placeholder="10"></div>
              </div>
              <div class="form-row" style="align-items: center; gap:12px;">
                <div class="form-group" style="flex:1;">
                  <label class="form-label">–ò—Ç–æ–≥ —Å —É—á—ë—Ç–æ–º –ø—Ä–æ–º–æ–∫–æ–¥–∞</label>
                  <div id="promoResult" style="font-weight:700; font-size:16px; color: var(--text-primary);">‚Äî</div>
                  <div id="promoHint" style="font-size:12px; color: var(--text-muted);">–ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ –±–µ—Ä—ë—Ç—Å—è –∏–∑ –ø–æ–ª—è
                    ‚Äú–ê–∫—Ç—É–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞‚Äù.</div>
                </div>
                <div class="btn-group">
                  <button type="button" class="btn btn-outline btn-sm" id="promoApplyPreview">–û–±–Ω–æ–≤–∏—Ç—å</button>
                  <button type="button" class="btn btn-ghost btn-sm" id="promoClearPreview">–°–±—Ä–æ—Å–∏—Ç—å</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">‚úçÔ∏è –¢–µ–∫—Å—Ç—ã CTA</div>
          </div>
          <div class="card-body">
            <div class="form-group"><label class="form-label">Free ‚Üí –û–ø–ª–∞—Ç–∞</label><input type="text" class="form-input"
                id="ctaEnterFull"></div>
            <div class="form-group"><label class="form-label">Premium ‚Üí –î–∞–ª–µ–µ</label><input type="text"
                class="form-input" id="ctaNext"></div>
            <div class="form-group"><label class="form-label">Appendix ‚Üí –ö—É—Ä—Å</label><input type="text"
                class="form-input" id="ctaGoToCourse"></div>
            <div class="form-group"><label class="form-label">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ ‚Üí –°—Ç–∞—Ä—Ç</label><input type="text"
                class="form-input" id="ctaOpenCourse"></div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">üéØ Favicon –∏ –∏–∫–æ–Ω–∫–∏</div><span class="badge badge-muted">–¢–µ–∫—É—â–∏–π –Ω–∞–±–æ—Ä</span>
          </div>
          <div class="card-body">
            <div class="form-group">
              <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;" id="faviconPreview">
                <div style="color: var(--text-muted); font-size:13px;">–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–≤–∏–∫–æ–Ω...</div>
              </div>
              <div style="font-size:12px; color: var(--text-muted); margin-top:8px;" id="faviconMeta"></div>
            </div>
            <div class="grid-2" style="margin-top: 12px;">
              <div class="form-group"><label class="form-label">Name</label><input type="text" class="form-input"
                  id="manifestName"></div>
              <div class="form-group"><label class="form-label">Short Name</label><input type="text" class="form-input"
                  id="manifestShortName"></div>
            </div>
            <div class="grid-2">
              <div class="form-group"><label class="form-label">Theme Color</label><input type="text" class="form-input"
                  id="manifestThemeColor"></div>
              <div class="form-group"><label class="form-label">Background Color</label><input type="text"
                  class="form-input" id="manifestBgColor"></div>
            </div>
            <div class="form-group"><label class="form-label">Start URL</label><input type="text" class="form-input"
                id="manifestStartUrl"></div>
          </div>
        </div>

        <div class="grid-2">
          <div class="card">
            <div class="card-header">
              <div class="card-title">üìã –§—É—Ç–µ—Ä</div>
            </div>
            <div class="card-body">
              <div class="form-group"><label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏</label><input type="text"
                  class="form-input" id="companyName"></div>
              <div class="form-row">
                <div class="form-group"><label class="form-label">–ò–ù–ù</label><input type="text" class="form-input"
                    id="inn" maxlength="12"></div>
                <div class="form-group"><label class="form-label">–ì–æ–¥ –∫–æ–ø–∏—Ä–∞–π—Ç–∞</label><input type="number"
                    class="form-input" id="year"></div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-title">üîç SEO –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</div>
            </div>
            <div class="card-body">
              <div class="form-group"><label class="form-label">–°—É—Ñ—Ñ–∏–∫—Å &lt;title&gt;</label><input type="text"
                  class="form-input" id="titleSuffix"></div>
              <div class="form-group"><label class="form-label">–ì–ª–æ–±–∞–ª—å–Ω—ã–π META description</label><textarea
                  class="form-textarea" id="globalMetaDescription" rows="2"></textarea></div>
              <div class="form-group"><label class="form-label">OG-image –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</label><input type="text"
                  class="form-input" id="globalOgImage"></div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">üè∑Ô∏è –ü—Ä–æ–º–æ–∫–æ–¥—ã</div>
            <div class="btn-group">
              <button class="btn btn-outline btn-sm" type="button" id="promoAddBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
              <button class="btn btn-primary btn-sm" type="button" id="promoSaveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥—ã</button>
            </div>
          </div>
          <div class="card-body">
            <div id="promoList"></div>
            <p style="font-size:12px; color: var(--text-muted); margin-top:8px;">–£–¥–∞–ª–∏—Ç–µ –∫–æ–¥ –∏–∑ —Å–ø–∏—Å–∫–∞, —á—Ç–æ–±—ã
              –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏.</p>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">üí≥ Robokassa</div>
          </div>
          <div class="card-body">
            <div class="grid-3">
              <div class="form-group"><label class="form-label">–õ–æ–≥–∏–Ω –º–∞–≥–∞–∑–∏–Ω–∞</label><input type="text"
                  class="form-input" id="merchantLogin"></div>
              <div class="form-group"><label class="form-label">–ü–∞—Ä–æ–ª—å #1</label><input type="password"
                  class="form-input" id="password1"></div>
              <div class="form-group"><label class="form-label">–ü–∞—Ä–æ–ª—å #2</label><input type="password"
                  class="form-input" id="password2"></div>
            </div>
            <div class="grid-3">
              <div class="form-group"><label class="form-label">–ü—Ä–µ—Ñ–∏–∫—Å —Å—á—ë—Ç–∞</label><input type="text"
                  class="form-input" id="invoicePrefix"></div>
              <div class="form-group"><label class="form-label">Success URL</label><input type="text" class="form-input"
                  id="successUrl"></div>
              <div class="form-group"><label class="form-label">Fail URL</label><input type="text" class="form-input"
                  id="failUrl"></div>
            </div>
            <div class="grid-3">
              <div class="form-group"><label class="form-label">Result URL</label><input type="text" class="form-input"
                  id="resultUrl"></div>
              <div class="form-group"><label class="form-label">–Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</label><select class="form-select"
                  id="culture">
                  <option value="ru">ru</option>
                  <option value="en">en</option>
                </select></div>
              <div class="form-group"><label class="form-checkbox"><input type="checkbox" id="isTest">–¢–µ—Å—Ç–æ–≤—ã–π
                  —Ä–µ–∂–∏–º</label></div>
            </div>
            <div class="form-group"><label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞</label><input type="text"
                class="form-input" id="paymentDescription" placeholder="–ö—É—Ä—Å ¬´–°–ª–∏—à–∫–æ–º —É–º–Ω–∞—è —É–±–æ—Ä–∫–∞¬ª"></div>
          </div>
        </div>

        <div class="grid-2">
          <div class="card">
            <div class="card-header">
              <div class="card-title">üõ†Ô∏è –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–±–æ—Ä–∫–∏</div>
            </div>
            <div class="card-body">
              <div class="form-row">
                <div class="form-group"><label class="form-label">–°–∫–æ—Ä–æ—Å—Ç—å —á—Ç–µ–Ω–∏—è (—Å–ª–æ–≤/–º–∏–Ω)</label><input type="number"
                    class="form-input" id="wordsPerMinute" style="width: 120px;"></div>
                <div class="form-group" style="display: flex; align-items: flex-end;"><label
                    class="form-checkbox"><input type="checkbox" id="cookiesBannerEnabled"><span>–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –±–∞–Ω–Ω–µ—Ä
                      cookies</span></label></div>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">üìÑ Legal-–¥–æ–∫—É–º–µ–Ω—Ç—ã</div><span class="badge badge-muted">–°—Å—ã–ª–∫–∏ –∏–∑ —Ñ—É—Ç–µ—Ä–∞</span>
          </div>
          <div class="card-body">
            <div class="grid-3">
              <div class="form-group"><label class="form-label">–£—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</label><input type="text"
                  class="form-input" id="legalTerms" placeholder="01-legal-terms.md"></div>
              <div class="form-group"><label class="form-label">–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</label><input type="text"
                  class="form-input" id="legalPrivacy" placeholder="02-privacy.md"></div>
              <div class="form-group"><label class="form-label">–ü—É–±–ª–∏—á–Ω–∞—è –æ—Ñ–µ—Ä—Ç–∞</label><input type="text"
                  class="form-input" id="legalOffer" placeholder="03-offer.md"></div>
              <div class="form-group"><label class="form-label">–ö–æ–Ω—Ç–∞–∫—Ç—ã</label><input type="text" class="form-input"
                  id="legalContacts" placeholder="04-contacts.md"></div>
            </div>
          </div>
        </div>

        <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 12px;">
          <button class="btn btn-primary" id="saveConfigBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        </div>
      </section>

      <section class="section" data-section="build">
        <div class="section-header">
          <h1 class="section-title">–°–±–æ—Ä–∫–∞</h1>
          <p class="section-subtitle">–ó–∞–ø—É—Å–∫ –±–∏–ª–¥–∞ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ HTML-–±–ª–æ–∫–æ–≤</p>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">üöÄ –ó–∞–ø—É—Å–∫ —Å–±–æ—Ä–∫–∏</div>
          </div>
          <div class="card-body">
            <div class="btn-group">
              <button class="btn btn-success btn-lg" data-build="free">üì¶ Free</button>
              <button class="btn btn-primary btn-lg" data-build="premium">‚≠ê Premium</button>
              <button class="btn btn-warning btn-lg" data-build="recommendations">üìö –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</button>
              <button class="btn btn-outline btn-lg" data-build="all">üîÑ –í—Å—ë</button>
              <button class="btn btn-outline btn-lg" id="btnPreview">üåê –ü–æ–¥–Ω—è—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä</button>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">üìù –õ–æ–≥–∏</div><button class="btn btn-ghost btn-sm" id="clearLogs">–û—á–∏—Å—Ç–∏—Ç—å</button>
          </div>
          <div class="card-body">
            <div class="logs" id="logs"></div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">üß© HTML-–±–ª–æ–∫–∏</div>
          </div>
          <div class="card-body">
            <div class="editor-layout">
              <div class="editor-list" id="htmlBlocksList">
                <div class="editor-item">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
              </div>
              <div>
                <div class="editor-topbar">
                  <span style="font-size: 12px; color: var(--text-muted);" id="selectedBlockLabel">–ë–ª–æ–∫ –Ω–µ –≤—ã–±—Ä–∞–Ω</span>
                  <div style="display:flex; gap:8px; align-items:center;">
                    <div class="mode-switch" aria-label="–†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è">
                      <button type="button" class="active" id="modeCode">–ö–æ–¥</button>
                      <button type="button" id="modeWysiwyg">WYSIWYG</button>
                    </div>
                    <div class="btn-group">
                      <button class="btn btn-outline btn-sm" id="loadBlockBtn">üìÑ –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
                      <button class="btn btn-primary btn-sm" id="saveBlockBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    </div>
                  </div>
                </div>
                <div id="toolbarWrapper" class="editor-toolbar" style="display:none;">
                  <button type="button" data-cmd="bold"><strong>–ñ</strong></button>
                  <button type="button" data-cmd="italic"><em>–ö</em></button>
                  <button type="button" data-cmd="h2">H2</button>
                  <button type="button" data-cmd="ul">‚Ä¢ –°–ø–∏—Å–æ–∫</button>
                  <button type="button" data-cmd="link">üîó –°—Å—ã–ª–∫–∞</button>
                  <button type="button" data-cmd="emoji">üòä –≠–º–æ–¥–∂–∏</button>
                  <button type="button" data-cmd="align-left">‚Ü§ –í–ª–µ–≤–æ</button>
                  <button type="button" data-cmd="align-center">‚Üî –¶–µ–Ω—Ç—Ä</button>
                  <button type="button" data-cmd="align-right">‚Ü¶ –í–ø—Ä–∞–≤–æ</button>
                  <button type="button" data-cmd="indent">‚Ü™ –û—Ç—Å—Ç—É–ø</button>
                  <button type="button" data-cmd="outdent">‚Ü© –£–±—Ä–∞—Ç—å –æ—Ç—Å—Ç—É–ø</button>
                  <button type="button" data-cmd="clear">‚úñ –û—á–∏—Å—Ç–∏—Ç—å</button>
                </div>
                <iframe class="wysiwyg-frame" id="wysiwygFrame" style="display:none;" title="WYSIWYG —Ä–µ–¥–∞–∫—Ç–æ—Ä"></iframe>
                <textarea class="form-textarea code-area" id="htmlBlockContent"
                  placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –±–ª–æ–∫ –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ó–∞–≥—Ä—É–∑–∏—Ç—å¬ª"></textarea>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <div class="toast" id="toast">–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ</div>
  <button class="fixed-save" id="fixedSave" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏">üíæ</button>

  <script>
    const state = {
      items: [],
      filter: 'all',
      search: '',
      config: null,
      legal: {},
      htmlBlocks: [],
      selectedBlock: null,
      editorMode: 'code',
      promos: [],
      images: [],
      imagesFilter: 'all',
      imagesSearch: ''
    };

    const qs = (sel) => document.querySelector(sel);
    const qsa = (sel) => Array.from(document.querySelectorAll(sel));
    const escapeSelector = (value) => {
      if (window.CSS && CSS.escape) return CSS.escape(value);
      return String(value || '').replace(/[^a-zA-Z0-9_-]/g, '\\\\$&');
    };
    const safeId = (value) => String(value || '').replace(/[^a-zA-Z0-9_-]/g, '-');

    document.addEventListener('DOMContentLoaded', () => {
      bindTabs();
      bindFilters();
      bindSearch();
      bindSettingsSave();
      bindBuildButtons();
      bindHtmlBlocksButtons();
      bindEditorMode();
      initWysiwygFrame();
      bindPromoPreview();
      bindImagesPanel();
      loadAll();
    });

    async function loadAll() {
      await Promise.all([loadContent(), loadConfig(), loadLegal(), loadHtmlBlocksList(), loadFaviconStatus(), loadPromos(), loadImages()]);
    }

    function setStatus(text, isLoading = false) {
      const statusText = qs('#statusText');
      const dot = qs('#statusBar .status-dot');
      statusText.textContent = text;
      dot.style.background = isLoading ? 'var(--warning)' : 'var(--success)';
    }

    function showToast(msg, type = 'success') {
      const toast = qs('#toast');
      toast.textContent = msg;
      toast.className = `toast ${type} show`;
      setTimeout(() => toast.classList.remove('show'), 2500);
    }

    function bindImagesPanel() {
      const filters = qs('#imagesFilters');
      if (filters) {
        filters.addEventListener('click', (e) => {
          const chip = e.target.closest('.chip');
          if (!chip) return;
          filters.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
          chip.classList.add('active');
          state.imagesFilter = chip.dataset.imgFilter || 'all';
          renderImages();
        });
      }
      const search = qs('#imagesSearch');
      if (search) {
        search.addEventListener('input', (e) => {
          state.imagesSearch = (e.target.value || '').toLowerCase();
          renderImages();
        });
      }
      const uploadInput = qs('#imageUploadInput');
      if (uploadInput) {
        uploadInput.addEventListener('change', async (e) => {
          const file = e.target.files?.[0];
          if (!file) return;
          try {
            setStatus('–ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...', true);
            const form = new FormData();
            form.append('file', file);
            const res = await fetch('/api/upload-image', { method: 'POST', body: form });
            if (!res.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å');
            await loadImages();
            showToast('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ');
          } catch (error) {
            showToast(error.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', 'error');
          } finally {
            setStatus('–ì–æ—Ç–æ–≤–æ', false);
            uploadInput.value = '';
          }
        });
      }
    }

    function bindTabs() {
      console.log('[–ê–¥–º–∏–Ω–∫–∞] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∫–ª–∞–¥–æ–∫...');
      const tabs = qsa('.tab');
      console.log('[–ê–¥–º–∏–Ω–∫–∞] –ù–∞–π–¥–µ–Ω–æ –≤–∫–ª–∞–¥–æ–∫:', tabs.length);

      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          console.log('[–ê–¥–º–∏–Ω–∫–∞] –ö–ª–∏–∫ –ø–æ –≤–∫–ª–∞–¥–∫–µ:', tab.dataset.section);
          const target = tab.dataset.section;
          qsa('.tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          qsa('.section').forEach(s => s.classList.toggle('active', s.dataset.section === target));
        });
      });

      console.log('[–ê–¥–º–∏–Ω–∫–∞] –í–∫–ª–∞–¥–∫–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã');
    }

    function bindFilters() {
      qs('#typeFilters').addEventListener('click', (e) => {
        const chip = e.target.closest('.chip');
        if (!chip) return;
        qsa('#typeFilters .chip').forEach(c => c.classList.remove('active'));
        chip.classList.add('active');
        state.filter = chip.dataset.type;
        renderContentList();
      });
    }

    function bindSearch() {
      qs('#searchInput').addEventListener('input', (e) => {
        state.search = (e.target.value || '').toLowerCase();
        renderContentList();
      });
    }

    function bindPromoPreview() {
      const recalc = () => {
        const base = Number(qs('#currentAmount').value);
        const type = qs('#promoTypePreview').value;
        const value = Number(qs('#promoValuePreview').value);
        const code = qs('#promoCodePreview').value.trim();
        const resultEl = qs('#promoResult');
        const hintEl = qs('#promoHint');

        if (!code || !Number.isFinite(base) || base <= 0) {
          resultEl.textContent = '‚Äî';
          hintEl.textContent = '–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏ –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Ü–µ–Ω—É, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∏—Ç–æ–≥.';
          return;
        }

        let final = base;
        if (Number.isFinite(value) && value > 0) {
          if (type === 'percent') {
            final = Math.max(0, base - (base * value / 100));
          } else {
            final = Math.max(0, base - value);
          }
        }
        resultEl.textContent = `${final.toLocaleString('ru-RU')} ${qs('#currency').value || ''}`.trim();
        hintEl.textContent = type === 'percent'
          ? `–°–∫–∏–¥–∫–∞ ${value || 0}% –æ—Ç ${base}`
          : `–°–∫–∏–¥–∫–∞ ${value || 0} –æ—Ç ${base}`;
      };

      ['promoCodePreview', 'promoTypePreview', 'promoValuePreview', 'currentAmount', 'currency'].forEach(id => {
        const el = qs('#' + id);
        if (el) {
          el.addEventListener('input', recalc);
          el.addEventListener('change', recalc);
        }
      });

      qs('#promoApplyPreview').addEventListener('click', recalc);
      qs('#promoClearPreview').addEventListener('click', () => {
        qs('#promoCodePreview').value = '';
        qs('#promoValuePreview').value = '';
        qs('#promoTypePreview').value = 'percent';
        qs('#promoResult').textContent = '‚Äî';
        qs('#promoHint').textContent = '–ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ –±–µ—Ä—ë—Ç—Å—è –∏–∑ –ø–æ–ª—è ‚Äú–ê–∫—Ç—É–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞‚Äù.';
      });
    }

    async function loadPromos() {
      try {
        const res = await fetch('/api/promo');
        state.promos = await res.json();
        renderPromos();
      } catch (e) {
        state.promos = [];
      }
    }

    async function loadImages() {
      try {
        const res = await fetch('/api/images');
        if (!res.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
        state.images = await res.json();
        renderImages();
      } catch (error) {
        const container = qs('#imagesList');
        if (container) container.innerHTML = `<div class="card"><div class="card-body">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</div></div>`;
      }
    }

    function filterImages(list) {
      const q = (state.imagesSearch || '').trim();
      const filter = state.imagesFilter;
      return list.filter(img => {
        const matchesFilter = filter === 'all'
          ? true
          : filter === 'missing'
            ? img.status?.missingAlt
            : img.sources?.includes(filter);
        const hay = [
          img.path,
          img.filename,
          img.alt,
          img.description
        ].join(' ').toLowerCase();
        const matchesSearch = q ? hay.includes(q.toLowerCase()) : true;
        return matchesFilter && matchesSearch;
      });
    }

    function renderImages() {
      const container = qs('#imagesList');
      if (!container) return;
      const images = filterImages(state.images || []);
      if (!images.length) {
        container.innerHTML = '<div class="card"><div class="card-body">–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</div></div>';
        return;
      }
      container.innerHTML = '';
      images.forEach(img => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="card-body" style="display:flex; gap:12px; align-items:flex-start;">
            <div style="width:80px; height:80px; border:1px solid var(--border-light); border-radius:12px; overflow:hidden; flex-shrink:0; display:flex; align-items:center; justify-content:center; background:#fafafa;">
              <img src="${img.path}" alt="" style="max-width:100%; max-height:100%; object-fit:contain;">
            </div>
            <div style="flex:1; min-width:0;">
              <div style="font-weight:600; font-size:13px; margin-bottom:4px; word-break:break-all;">${img.path}</div>
              <div style="font-size:12px; color:var(--text-muted); margin-bottom:8px;">${(img.sources || []).join(', ') || '‚Äî'} ¬∑ use: ${img.inUse?.length || 0}</div>
              <div class="form-row" style="gap:8px;">
                <div class="form-group" style="flex:1;">
                  <label class="form-label">Alt</label>
                  <input type="text" class="form-input" data-img-alt="${img.id}" value="${img.alt || ''}">
                </div>
                <div class="form-group" style="flex:1;">
                  <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                  <input type="text" class="form-input" data-img-desc="${img.id}" value="${img.description || ''}">
                </div>
                <button type="button" class="btn btn-primary btn-sm" data-img-save="${img.id}">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              </div>
            </div>
          </div>
        `;
        container.appendChild(card);
      });

      container.querySelectorAll('[data-img-save]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.dataset.imgSave;
          const altInput = container.querySelector(`[data-img-alt="${CSS.escape(id)}"]`);
          const descInput = container.querySelector(`[data-img-desc="${CSS.escape(id)}"]`);
          try {
            setStatus('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ alt/description...', true);
            const res = await fetch(`/api/images/${encodeURIComponent(id)}`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                alt: altInput?.value || '',
                description: descInput?.value || ''
              })
            });
            if (!res.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å');
            showToast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
            await loadImages();
          } catch (error) {
            showToast(error.message || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
          } finally {
            setStatus('–ì–æ—Ç–æ–≤–æ', false);
          }
        });
      });
    }


    function renderPromos() {
      const container = qs('#promoList');
      if (!container) return;
      container.innerHTML = '';
      if (!state.promos || state.promos.length === 0) {
        container.innerHTML = '<div style="font-size:13px; color: var(--text-muted);">–ü—Ä–æ–º–æ–∫–æ–¥—ã –Ω–µ –∑–∞–¥–∞–Ω—ã</div>';
        return;
      }
      state.promos.forEach((promo, idx) => {
        const row = document.createElement('div');
        row.className = 'form-row';
        row.style.gap = '8px';
        row.style.alignItems = 'flex-end';
        row.innerHTML = `
          <div class="form-group" style="flex:1;">
            <label class="form-label">–ö–æ–¥</label>
            <input type="text" class="form-input" data-promo-field="code" data-idx="${idx}" value="${promo.code || ''}">
          </div>
          <div class="form-group" style="width:120px;">
            <label class="form-label">–¢–∏–ø</label>
            <select class="form-select" data-promo-field="type" data-idx="${idx}">
              <option value="percent"${promo.type === 'percent' ? ' selected' : ''}>%</option>
              <option value="fixed"${promo.type === 'fixed' ? ' selected' : ''}>–§–∏–∫—Å.</option>
            </select>
          </div>
          <div class="form-group" style="width:120px;">
            <label class="form-label">–ó–Ω–∞—á–µ–Ω–∏–µ</label>
            <input type="number" class="form-input" data-promo-field="value" data-idx="${idx}" value="${promo.value || ''}">
          </div>
          <div class="form-group" style="width:140px;">
            <label class="form-label">–ù–∞—á–∞–ª–æ</label>
            <input type="date" class="form-input" data-promo-field="starts_at" data-idx="${idx}" value="${promo.starts_at || ''}">
          </div>
          <div class="form-group" style="width:140px;">
            <label class="form-label">–û–∫–æ–Ω—á–∞–Ω–∏–µ</label>
            <input type="date" class="form-input" data-promo-field="ends_at" data-idx="${idx}" value="${promo.ends_at || ''}">
          </div>
          <div class="form-group" style="width:120px;">
            <label class="form-label">–õ–∏–º–∏—Ç</label>
            <input type="number" class="form-input" data-promo-field="max_uses" data-idx="${idx}" value="${promo.max_uses ?? ''}" placeholder="‚àû">
          </div>
          <div class="form-group" style="width:120px;">
            <label class="form-label">–ù–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
            <input type="number" class="form-input" data-promo-field="max_uses_per_user" data-idx="${idx}" value="${promo.max_uses_per_user ?? ''}" placeholder="‚àû">
          </div>
          <button type="button" class="btn btn-ghost btn-sm" data-promo-remove="${idx}">‚úñ</button>
        `;
        container.appendChild(row);
      });

      container.querySelectorAll('[data-promo-field]').forEach(el => {
        el.addEventListener('input', (e) => {
          const idx = Number(e.target.dataset.idx);
          const field = e.target.dataset.promoField;
          if (!Number.isFinite(idx) || !state.promos[idx]) return;
          state.promos[idx][field] = e.target.value;
        });
      });

      container.querySelectorAll('[data-promo-remove]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const idx = Number(e.target.dataset.promoRemove);
          if (!Number.isFinite(idx)) return;
          state.promos.splice(idx, 1);
          renderPromos();
        });
      });
    }

    function addPromo() {
      if (!state.promos) state.promos = [];
      state.promos.push({
        code: '',
        type: 'percent',
        value: '',
        starts_at: '',
        ends_at: '',
        max_uses: '',
        max_uses_per_user: ''
      });
      renderPromos();
    }

    async function savePromos() {
      try {
        const cleaned = (state.promos || []).map(p => ({
          code: (p.code || '').trim(),
          type: p.type === 'fixed' ? 'fixed' : 'percent',
          value: p.value === '' ? '' : Number(p.value),
          starts_at: p.starts_at || '',
          ends_at: p.ends_at || '',
          max_uses: p.max_uses === '' ? '' : Number(p.max_uses),
          max_uses_per_user: p.max_uses_per_user === '' ? '' : Number(p.max_uses_per_user)
        })).filter(p => p.code);

        for (const promo of cleaned) {
          if (!promo.code) throw new Error('–ö–æ–¥ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
          if (!promo.value || promo.value <= 0) throw new Error(`–£ –ø—Ä–æ–º–æ–∫–æ–¥–∞ ${promo.code} –Ω–µ –∑–∞–¥–∞–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ`);
        }

        await fetch('/api/promo', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(cleaned)
        });
        state.promos = cleaned;
        showToast('–ü—Ä–æ–º–æ–∫–æ–¥—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
      } catch (e) {
        showToast(e.message || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤', 'error');
      }
    }

    function bindSettingsSave() {
      qs('#saveConfigBtn').addEventListener('click', saveConfig);
      qs('#fixedSave').addEventListener('click', saveConfig);
      const addBtn = qs('#promoAddBtn');
      const saveBtn = qs('#promoSaveBtn');
      if (addBtn) addBtn.addEventListener('click', addPromo);
      if (saveBtn) saveBtn.addEventListener('click', savePromos);
    }

    function bindBuildButtons() {
      qsa('[data-build]').forEach(btn => btn.addEventListener('click', () => runBuild(btn.dataset.build)));
      qs('#btnPreview').addEventListener('click', runPreview);
      qs('#clearLogs').addEventListener('click', () => { qs('#logs').textContent = ''; });
    }

    function bindHtmlBlocksButtons() {
      qs('#loadBlockBtn').addEventListener('click', loadSelectedBlock);
      qs('#saveBlockBtn').addEventListener('click', saveSelectedBlock);
      const toolbar = qs('#toolbarWrapper');
      toolbar.addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-cmd]');
        if (!btn) return;
        handleToolbarCommand(btn.dataset.cmd);
      });
      const codeArea = qs('#htmlBlockContent');
      codeArea.addEventListener('input', debounce(syncToWysiwyg, 300));
    }

    async function loadContent() {
      setStatus('–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞...', true);
      try {
        const res = await fetch('/api/content');
        const data = await res.json();
        state.items = data.items || [];
        renderStats(data.stats || {});
        renderContentList();
        renderMenuPreview();
        setStatus('–ì–æ—Ç–æ–≤–æ');
      } catch (e) {
        setStatus('–û—à–∏–±–∫–∞');
        showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞', 'error');
      }
    }

    function renderStats(stats) {
      qs('#statTotal').textContent = stats.total || 0;
      qs('#statFilled').textContent = stats.filled || 0;
      qs('#statAttention').textContent = stats.attention || 0;
    }

    function filteredItems() {
      const term = state.search;
      return state.items.filter(item => {
        const matchesType = state.filter === 'all' || item.type === state.filter;
        const hay = `${item.file} ${item.h1_md}`.toLowerCase();
        const matchesSearch = !term || hay.includes(term);
        return matchesType && matchesSearch;
      });
    }

    function renderContentList() {
      const list = qs('#contentList');
      const items = filteredItems();
      if (!items.length) {
        list.innerHTML = '<div class="card"><div class="card-body">–ù–µ—Ç —ç–ª–µ–º–µ–Ω—Ç–æ–≤</div></div>';
        return;
      }

      list.innerHTML = items.map(renderCard).join('');

      list.querySelectorAll('.content-card-header').forEach(header => {
        header.addEventListener('click', () => header.parentElement.classList.toggle('expanded'));
      });

      list.querySelectorAll('[data-action="save"]').forEach(btn => {
        btn.addEventListener('click', () => saveContent(btn.dataset.path));
      });

      list.querySelectorAll('.paywall-slider, [data-teaser-input]').forEach(input => {
        input.addEventListener('input', () => {
          const editor = input.closest('.paywall-editor');
          const targetId = input.dataset.target;
          if (targetId && editor) {
            const label = editor.querySelector(`#${targetId}`);
            if (label) label.textContent = input.value;
          }
          updatePaywallPreview(editor);
        });
      });
    }

    function renderCard(item) {
      const statusLine = renderStatusLine(item);
      const badge = item.meta_description ? '<span class="badge badge-success">‚úì</span>' : '<span class="badge badge-warning">‚ö†</span>';
      const typeBadge = renderTypeBadge(item.type);
      const icon = getTypeIcon(item.type);
      const typeClass = `type-${item.type}`;
      const paywallBlock = item.type === 'article' ? renderPaywall(item) : '';
      const menuBlock = (item.type === 'article' || item.type === 'appendix') ? renderMenuFields(item) : '';
      const carouselBlock = item.type === 'recommendation' ? renderCarousel(item) : '';
      const slugField = (item.type === 'intro' || item.type === 'legal') ? '' : renderSlugFields(item);

      return `
        <article class="content-card" data-type="${item.type}" data-path="${item.pathKey}">
          <div class="content-card-header">
            <div class="content-card-icon ${typeClass}">${icon}</div>
            <div class="content-card-info">
            <div class="content-card-title">${item.file}</div>
            <div class="content-card-meta">H1: ${item.h1_md || '‚Äî'} ‚Ä¢ ${item.branch}/</div>
            <div class="content-card-status">${statusLine}</div>
          </div>
            <div class="content-card-badges">${typeBadge}${badge}</div>
            <button class="content-card-toggle">‚ñæ</button>
          </div>
          <div class="content-card-body">
            <div class="form-group">
              <label class="form-label">H1 –∏–∑ MD</label>
              <input type="text" class="form-input readonly" value="${item.h1_md || ''}" readonly>
            </div>

            ${slugField}

            ${item.type === 'legal' ? renderLegalSeo(item) : renderSeoBlock(item)}

            ${menuBlock}
            ${paywallBlock}
            ${carouselBlock}

            <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 12px;">
              <button class="btn btn-primary btn-sm" data-action="save" data-path="${item.pathKey}">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
          </div>
        </article>
      `;
    }

    function renderSlugFields(item) {
      return `
        <div class="field-block">
          <div class="field-block-header">
            <div class="field-block-title">Slug</div>
          </div>
          <div class="form-group">
            <label class="form-label">Slug (URL)</label>
            <input type="text" class="form-input" data-field="slug" value="${item.slug || ''}">
            <div class="form-hint">–ï—Å–ª–∏ –ø—É—Å—Ç–æ ‚Üí —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—è –∏–∑ H1</div>
          </div>
        </div>
      `;
    }

    function renderMenuFields(item) {
      return `
        <div class="field-block">
          <div class="field-block-header">
            <div class="field-block-title">üìë –ú–µ–Ω—é</div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">–ó–∞–≥–æ–ª–æ–≤–æ–∫ –≤ –º–µ–Ω—é</label>
              <input type="text" class="form-input" data-field="menu_label" value="${item.menu_label || ''}">
              <div class="form-hint">–ï—Å–ª–∏ –ø—É—Å—Ç–æ ‚Üí H1 –∏–∑ MD</div>
            </div>
            <div class="form-group">
              <label class="form-label">–ü–æ–¥–ø–∏—Å—å –≤ –º–µ–Ω—é</label>
              <input type="text" class="form-input" data-field="menu_subtitle" value="${item.menu_subtitle || ''}">
            </div>
          </div>
        </div>
      `;
    }

    function renderSeoBlock(item) {
      return `
        <div class="field-block">
          <div class="field-block-header">
            <div class="field-block-title">üîç SEO</div>
          </div>
          <div class="form-group">
            <label class="form-label">SEO-H1</label>
            <input type="text" class="form-input" data-field="seo_h1" value="${item.seo_h1 || ''}">
          </div>
          <div class="form-group">
            <label class="form-label">Title</label>
            <input type="text" class="form-input" data-field="title" value="${item.title || ''}">
          </div>
          <div class="form-group">
            <label class="form-label">META description</label>
            <textarea class="form-textarea" data-field="meta_description" rows="2">${item.meta_description || ''}</textarea>
          </div>
        </div>
      `;
    }

    function renderLegalSeo(item) {
      return `
        <div class="field-block">
          <div class="field-block-header">
            <div class="field-block-title">üîç SEO</div>
          </div>
          <div class="form-group">
            <label class="form-label">SEO-H1</label>
            <input type="text" class="form-input" data-field="seo_h1" value="${item.seo_h1 || ''}">
          </div>
        </div>
      `;
    }
    function renderPaywall(item) {
      const maxBlocks = item.paywallPreview?.totalBlocks || 30;
      const open = Math.min(item.paywallPreview?.openBlocks ?? item.paywall?.openBlocks ?? 3, maxBlocks);
      const teaser = Math.min(item.paywallPreview?.teaserBlocks ?? item.paywall?.teaserBlocks ?? 2, Math.max(0, maxBlocks - open));
      const idSafe = safeId(item.pathKey);
      const dataPreview = item.paywallPreview ? encodeURIComponent(JSON.stringify(item.paywallPreview.blocks || item.paywallPreview.paragraphs || [])) : '[]';
      return `
        <div class="field-block">
          <div class="field-block-header">
            <div class="field-block-title">üîí Paywall</div>
          </div>
          <div class="paywall-editor">
            <div class="paywall-controls">
              <div class="paywall-control">
                <label>–û—Ç–∫—Ä—ã—Ç–æ –±–ª–æ–∫–æ–≤</label>
                <div style="display: flex; align-items: center; gap: 12px;">
                  <input type="range" class="paywall-slider" min="0" max="${maxBlocks}" value="${open}" data-field="openBlocks" data-target="openValue-${idSafe}">
                  <span class="paywall-control-value" id="openValue-${idSafe}">${open}</span>
                </div>
              </div>
              <div class="paywall-control">
                <label>–ë–ª–æ–∫–æ–≤ –≤ –±–ª—é—Ä–µ (teaser)</label>
                <div style="display: flex; align-items: center; gap: 12px;">
                  <input type="number" class="form-input" style="width:90px;" min="0" max="${maxBlocks}" value="${teaser}" data-teaser-input data-field="teaserBlocks" data-target="teaserValue-${idSafe}">
                  <span class="paywall-control-value" id="teaserValue-${idSafe}">${teaser}</span>
                </div>
              </div>
            </div>
            <div class="paywall-preview-vertical" data-paywall-blocks="${dataPreview}">${renderPaywallPreview(item.paywallPreview, open, teaser)}</div>
          </div>
        </div>
      `;
    }

    function renderCarousel(item) {
      const carousel = item.carousel || {};
      const enabled = carousel.enabled !== false;
      return `
        <div class="field-block">
          <div class="field-block-header">
            <div class="field-block-title">üé† –ö–∞—Ä—É—Å–µ–ª—å</div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
              <input type="text" class="form-input" data-field="carousel_label" value="${carousel.label || ''}">
            </div>
            <div class="form-group">
              <label class="form-label">–ü–æ–¥–ø–∏—Å—å</label>
              <input type="text" class="form-input" data-field="carousel_subtitle" value="${carousel.subtitle || ''}">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Emoji –∏–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∞</label>
              <div style="display:flex; gap:8px; align-items:center;">
                <input type="text" class="form-input" data-field="carousel_icon" value="${carousel.icon || ''}" placeholder="üòÄ" style="max-width:120px;" maxlength="2">
                <input type="file" accept="image/*" data-field="carousel_file" style="flex:1;">
              </div>
              <div class="form-hint">–í–≤–µ–¥–∏—Ç–µ 1 emoji –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∫–∞—Ä—Ç–∏–Ω–∫–∏. –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª –±—É–¥–µ—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±–∏–ª–¥.</div>
            </div>
            <div class="form-group">
              <label class="form-label">–ü–æ—Ä—è–¥–æ–∫</label>
              <input type="number" class="form-input" data-field="carousel_order" value="${carousel.order ?? ''}">
            </div>
          </div>
          <label class="form-checkbox" style="margin-top: 8px;">
            <input type="checkbox" data-field="carousel_enabled" ${enabled ? 'checked' : ''}>
            <span>–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤ –∫–∞—Ä—É—Å–µ–ª–∏</span>
          </label>
        </div>
      `;
    }

    function getTypeIcon(type) {
      switch (type) {
        case 'article': return 'üìò';
        case 'appendix': return 'üìë';
        case 'intro': return 'üö™';
        case 'recommendation': return 'üéØ';
        case 'legal': return '‚öñÔ∏è';
        default: return 'üìÑ';
      }
    }

    function renderTypeBadge(type) {
      const map = {
        article: { label: 'article', className: 'badge-primary' },
        appendix: { label: 'appendix', className: 'badge-danger' },
        intro: { label: 'intro', className: 'badge-success' },
        recommendation: { label: 'recommendation', className: 'badge-warning' },
        legal: { label: 'legal', className: 'badge-muted' }
      };
      const info = map[type] || map.article;
      return `<span class="badge ${info.className}">${info.label}</span>`;
    }

    function renderStatusLine(item) {
      const parts = [];
      const mark = (value, filled) => {
        if (filled) return '‚úì';
        if (value === null || value === undefined || value === '') return '‚úó';
        return '‚ñ≥';
      };
      const markPaywall = (isSet) => isSet ? '‚ñ≥' : '‚úó';

      const filled = item.filled || {};

      if (item.type !== 'intro' && item.type !== 'legal') {
        parts.push(`Slug ${mark(item.slug, filled.slug)}`);
      }

      parts.push(`SEO-H1 ${mark(item.seo_h1, filled.seo_h1)}`);
      parts.push(`Title ${mark(item.title, filled.title)}`);
      parts.push(`META ${mark(item.meta_description, filled.meta_description)}`);

      if (item.type === 'article' || item.type === 'appendix') {
        parts.push(`–ú–µ–Ω—é ${mark(item.menu_label, filled.menu_label)}`);
      }

      if (item.type === 'article') {
        const pw = item.paywall || {};
        parts.push(`Paywall ${markPaywall(filled.paywall_open)}/${markPaywall(filled.paywall_teaser)}`);
      }

      if (item.type === 'recommendation') {
        const c = item.carousel || {};
        parts.push(`–ö–∞—Ä—É—Å–µ–ª—å ${mark(c.label, filled.carousel_label)}${c.order !== null && c.order !== undefined ? ` ‚Ä¢ ‚Ññ${c.order}` : ''}`);
      }

      if (item.type === 'legal') {
        parts.push('Legal');
      }

      return parts.map(p => `<span>${p}</span>`).join('');
    }

    function renderPaywallPreview(preview, open, teaser) {
      if (!preview) {
        return `
          <div class="paywall-section-v paywall-open-v">
            <div class="paywall-section-header">
              <div class="paywall-section-label">‚úÖ –û—Ç–∫—Ä—ã—Ç–∞—è —á–∞—Å—Ç—å</div>
              <div class="paywall-section-count">${open} –±–ª–æ–∫–æ–≤</div>
            </div>
            <div class="paywall-blocks"><div class="paywall-block-placeholder">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞</div></div>
          </div>
        `;
      }

      const openBlocks = preview.open || [];
      const teaserBlocks = preview.teaser || [];
      const hiddenBlocks = preview.hidden || [];

      return `
        <div class="paywall-preview-vertical">
          <div class="paywall-section-v paywall-open-v">
            <div class="paywall-section-header">
              <div class="paywall-section-label">‚úÖ –û—Ç–∫—Ä—ã—Ç–∞—è —á–∞—Å—Ç—å</div>
              <div class="paywall-section-count">${openBlocks.length} –±–ª–æ–∫–æ–≤</div>
            </div>
            <div class="paywall-blocks">
              ${openBlocks.map(html => `<div class="paywall-block">${html}</div>`).join('')}
              ${!openBlocks.length ? `<div class="paywall-block paywall-block-placeholder">–ü—É—Å—Ç–æ</div>` : ''}
            </div>
          </div>
          <div class="paywall-section-v paywall-teaser-v">
            <div class="paywall-section-header">
              <div class="paywall-section-label">üî∂ Teaser (blur)</div>
              <div class="paywall-section-count">${teaserBlocks.length} –±–ª–æ–∫–æ–≤</div>
            </div>
            <div class="paywall-blocks">
              ${teaserBlocks.map(html => `<div class="paywall-block">${html}</div>`).join('')}
              ${!teaserBlocks.length ? `<div class="paywall-block paywall-block-placeholder">–ü—É—Å—Ç–æ</div>` : ''}
            </div>
          </div>
          <div class="paywall-section-v paywall-hidden-v">
            <div class="paywall-section-header">
              <div class="paywall-section-label">üîí –°–∫—Ä—ã—Ç–æ</div>
              <div class="paywall-section-count">${hiddenBlocks.length} –±–ª–æ–∫–æ–≤</div>
            </div>
            <div class="paywall-blocks">
              ${hiddenBlocks.length
          ? `<div class="paywall-block-placeholder">–°–∫—Ä—ã—Ç–æ ${hiddenBlocks.length} –±–ª–æ–∫(–æ–≤)</div>`
          : '<div class="paywall-block-placeholder">–ü—É—Å—Ç–æ</div>'}
            </div>
          </div>
        </div>
      `;
    }

    function renderPaywallPreviewFromBlocks(blocks, open, teaser) {
      const total = blocks.length;
      const openCount = Math.min(Number(open) || 0, total);
      const teaserCount = Math.min(Number(teaser) || 0, Math.max(0, total - openCount));
      const hiddenStart = openCount + teaserCount;

      const openBlocks = blocks.slice(0, openCount);
      const teaserBlocks = blocks.slice(openCount, hiddenStart);
      const hiddenBlocks = blocks.slice(hiddenStart);

      return renderPaywallPreview({
        open: openBlocks,
        teaser: teaserBlocks,
        hidden: hiddenBlocks
      }, openBlocks.length, teaserBlocks.length);
    }

    function updatePaywallPreview(editor) {
      if (!editor) return;
      const previewBox = editor.querySelector('.paywall-preview-vertical[data-paywall-blocks]');
      if (!previewBox) return;
      const blocksRaw = previewBox.dataset.paywallBlocks || '[]';
      let blocks = [];
      try {
        blocks = JSON.parse(decodeURIComponent(blocksRaw));
      } catch (e) {
        blocks = [];
      }
      const open = Number(editor.querySelector('.paywall-slider')?.value || 0);
      const teaser = Number(editor.querySelector('[data-teaser-input]')?.value || 0);
      previewBox.innerHTML = renderPaywallPreviewFromBlocks(blocks, open, teaser);
    }

    async function saveContent(pathKey) {
      const card = qs(`[data-path="${escapeSelector(pathKey)}"]`);
      if (!card) return;
      const data = {};
      card.querySelectorAll('[data-field]').forEach(input => {
        const key = input.dataset.field;
        if (key === 'openBlocks' || key === 'teaserBlocks' || key === 'carousel_order') {
          data[key] = Number(input.value);
        } else if (key === 'carousel_enabled') {
          data[key] = input.checked;
        } else {
          data[key] = input.value;
        }
      });

      const fileInput = card.querySelector('[data-field="carousel_file"]');
      let uploadedPath = '';
      if (fileInput && fileInput.files && fileInput.files[0]) {
        const form = new FormData();
        form.append('file', fileInput.files[0]);
        try {
          const res = await fetch('/api/upload-asset', {
            method: 'POST',
            body: form
          });
          const result = await res.json();
          if (result?.url) {
            uploadedPath = result.url;
          }
        } catch (e) {
          console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª –∏–∫–æ–Ω–∫–∏:', e);
        }
      }

      if (uploadedPath) {
        data.carousel_icon = uploadedPath;
      }

      data.paywall = {
        openBlocks: Number(data.openBlocks),
        teaserBlocks: Number(data.teaserBlocks)
      };
      delete data.openBlocks;
      delete data.teaserBlocks;

      try {
        await fetch('/api/content', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ pathKey, data })
        });
        showToast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
        await loadContent();
      } catch (e) {
        showToast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
      }
    }

    function renderMenuPreview() {
      const courseColumn = qs('#menuPreview').children[0];
      const appendixColumn = qs('#menuPreview').children[1];
      const recColumn = qs('#menuPreview').children[2];
      courseColumn.innerHTML = '<div class="menu-preview-title">–†–∞–∑–¥–µ–ª—ã –∫—É—Ä—Å–∞</div>';
      appendixColumn.innerHTML = '<div class="menu-preview-title">–ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è</div>';
      recColumn.innerHTML = '<div class="menu-preview-title">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</div>';

      state.items.filter(i => i.type === 'article').forEach(item => {
        courseColumn.innerHTML += `<div class="menu-item"><div class="menu-item-label">${item.menu_label || item.h1_md}</div><div class="menu-item-subtitle">${item.menu_subtitle || ''}</div></div>`;
      });
      state.items.filter(i => i.type === 'appendix').forEach(item => {
        appendixColumn.innerHTML += `<div class="menu-item"><div class="menu-item-label">${item.menu_label || item.h1_md}</div><div class="menu-item-subtitle">${item.menu_subtitle || ''}</div></div>`;
      });
      state.items.filter(i => i.type === 'recommendation' && (!i.carousel || i.carousel.enabled !== false)).forEach(item => {
        const icon = item.carousel?.icon || '';
        const label = item.carousel?.label || item.h1_md;
        const subtitle = item.carousel?.subtitle || '';
        const iconHtml = renderMenuIcon(icon);
        recColumn.innerHTML += `<div class="menu-item"><div class="menu-item-label">${iconHtml}${label}</div><div class="menu-item-subtitle">${subtitle}</div></div>`;
      });
    }

    function renderMenuIcon(icon) {
      if (!icon) return '';
      const isImage = /^https?:\/\//i.test(icon) || icon.startsWith('/');
      if (isImage) {
        return `<img src="${icon}" alt="" style="width:16px;height:16px;object-fit:contain;margin-right:6px;vertical-align:middle;">`;
      }
      return `<span style="margin-right:6px;">${icon}</span>`;
    }

    async function loadConfig() {
      try {
        const res = await fetch('/api/config');
        state.config = await res.json();
        fillConfigForm();
      } catch (e) {
        showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫', 'error');
      }
    }

    function fillConfigForm() {
      const cfg = state.config || {};
      const pricing = cfg.pricing || {};
      const cta = cfg.ctaTexts || {};
      const footer = cfg.footer || {};
      const robokassa = cfg.robokassa || {};
      const build = cfg.build || {};
      const seo = cfg.seo || {};
      const manifest = cfg.manifest || {};

      qs('#originalAmount').value = pricing.originalAmount ?? '';
      qs('#currentAmount').value = pricing.currentAmount ?? '';
      qs('#currency').value = pricing.currency || 'RUB';

      qs('#ctaEnterFull').value = cta.enterFull || '';
      qs('#ctaNext').value = cta.next || '';
      qs('#ctaGoToCourse').value = cta.goToCourse || '';
      qs('#ctaOpenCourse').value = cta.openCourse || '';

      qs('#companyName').value = footer.companyName || '';
      qs('#inn').value = footer.inn || '';
      qs('#year').value = footer.year || new Date().getFullYear();

      qs('#merchantLogin').value = robokassa.merchantLogin || '';
      qs('#password1').value = robokassa.password1 || '';
      qs('#password2').value = robokassa.password2 || '';
      qs('#invoicePrefix').value = robokassa.invoicePrefix || '';
      qs('#paymentDescription').value = robokassa.description || '';
      qs('#successUrl').value = robokassa.successUrl || '';
      qs('#failUrl').value = robokassa.failUrl || '';
      qs('#resultUrl').value = robokassa.resultUrl || '';
      qs('#culture').value = robokassa.culture || 'ru';
      qs('#isTest').checked = robokassa.isTest !== false;

      qs('#wordsPerMinute').value = build.wordsPerMinute || 150;
      qs('#cookiesBannerEnabled').checked = (cfg.features && cfg.features.cookiesBannerEnabled) !== false;

      qs('#titleSuffix').value = seo.titleSuffix || '';
      qs('#globalMetaDescription').value = seo.globalMetaDescription || '';
      qs('#globalOgImage').value = seo.globalOgImage || '';

      qs('#manifestName').value = manifest.name || '';
      qs('#manifestShortName').value = manifest.short_name || manifest.shortName || '';
      qs('#manifestThemeColor').value = manifest.theme_color || manifest.themeColor || '';
      qs('#manifestBgColor').value = manifest.background_color || manifest.backgroundColor || '';
      qs('#manifestStartUrl').value = manifest.start_url || manifest.startUrl || '';
    }

    async function saveConfig() {
      const payload = {
        domain: state.config?.domain || 'example.com',
        pricing: {
          originalAmount: Number(qs('#originalAmount').value),
          currentAmount: Number(qs('#currentAmount').value),
          currency: qs('#currency').value
        },
        ctaTexts: {
          enterFull: qs('#ctaEnterFull').value,
          next: qs('#ctaNext').value,
          goToCourse: qs('#ctaGoToCourse').value,
          openCourse: qs('#ctaOpenCourse').value
        },
        footer: {
          companyName: qs('#companyName').value,
          inn: qs('#inn').value,
          year: Number(qs('#year').value)
        },
        robokassa: {
          merchantLogin: qs('#merchantLogin').value,
          password1: qs('#password1').value,
          password2: qs('#password2').value,
          invoicePrefix: qs('#invoicePrefix').value,
          description: qs('#paymentDescription').value,
          successUrl: qs('#successUrl').value,
          failUrl: qs('#failUrl').value,
          resultUrl: qs('#resultUrl').value,
          culture: qs('#culture').value,
          isTest: qs('#isTest').checked
        },
        build: {
          wordsPerMinute: Number(qs('#wordsPerMinute').value) || 150
        },
        features: {
          cookiesBannerEnabled: qs('#cookiesBannerEnabled').checked
        },
        seo: {
          titleSuffix: qs('#titleSuffix').value,
          globalMetaDescription: qs('#globalMetaDescription').value,
          globalOgImage: qs('#globalOgImage').value
        },
        manifest: {
          name: qs('#manifestName').value,
          short_name: qs('#manifestShortName').value,
          theme_color: qs('#manifestThemeColor').value,
          background_color: qs('#manifestBgColor').value,
          start_url: qs('#manifestStartUrl').value
        },
        legal: state.legal || {}
      };

      try {
        await fetch('/api/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º manifest –≤ favicon-–∫–æ–Ω—Ñ–∏–≥–µ
        await fetch('/api/favicon/manifest', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ manifest: payload.manifest })
        });
        await saveLegal(); // keep together
        showToast('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
      } catch (e) {
        showToast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫', 'error');
      }
    }

    async function loadLegal() {
      try {
        const res = await fetch('/api/legal');
        state.legal = await res.json();
        qs('#legalTerms').value = state.legal.terms || '';
        qs('#legalPrivacy').value = state.legal.privacy || '';
        qs('#legalOffer').value = state.legal.offer || '';
        qs('#legalContacts').value = state.legal.contacts || '';
      } catch (e) {
        state.legal = {};
      }
    }

    async function saveLegal() {
      const legal = {
        terms: qs('#legalTerms').value,
        privacy: qs('#legalPrivacy').value,
        offer: qs('#legalOffer').value,
        contacts: qs('#legalContacts').value
      };
      state.legal = legal;
      await fetch('/api/legal', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(legal)
      });
    }

    async function runBuild(target) {
      const logs = qs('#logs');
      logs.textContent += `\n–ó–∞–ø—É—Å–∫ —Å–±–æ—Ä–∫–∏ ${target || 'all'}...\n`;
      try {
        const res = await fetch('/api/build', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ target })
        });
        const data = await res.json();
        logs.textContent += (data.output || '') + '\n';
        showToast(data.success ? '–°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞' : '–°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–∞–º–∏', data.success ? 'success' : 'error');
      } catch (e) {
        logs.textContent += '–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –±–∏–ª–¥–∞\n';
        showToast('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –±–∏–ª–¥–∞', 'error');
      }
      logs.scrollTop = logs.scrollHeight;
    }

    async function runPreview() {
      try {
        const res = await fetch('/api/preview', { method: 'POST' });
        const data = await res.json();
        const logs = qs('#logs');
        if (data.success) {
          const msg = data.message || `–ü—Ä–µ–≤—å—é –∑–∞–ø—É—â–µ–Ω–æ: ${data.url || ''}`;
          logs.textContent += `\n${msg}\n`;
          showToast('–ü—Ä–µ–≤—å—é –∑–∞–ø—É—â–µ–Ω–æ', 'success');
        } else {
          logs.textContent += `\n–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–µ–≤—å—é: ${data.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}\n`;
          showToast('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–µ–≤—å—é', 'error');
        }
        logs.scrollTop = logs.scrollHeight;
      } catch (e) {
        const logs = qs('#logs');
        logs.textContent += `\n–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–µ–≤—å—é: ${e.message}\n`;
        logs.scrollTop = logs.scrollHeight;
        showToast('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–µ–≤—å—é', 'error');
      }
    }

    async function loadHtmlBlocksList() {
      try {
        const res = await fetch('/api/html-blocks');
        state.htmlBlocks = await res.json();
        const list = qs('#htmlBlocksList');
        list.innerHTML = '';
        state.htmlBlocks.forEach(block => {
          const div = document.createElement('div');
          div.className = 'editor-item';
          div.dataset.name = block.name;
          div.innerHTML = `<div class="editor-item-title">${block.label}</div><div class="editor-item-path">${block.path}</div>`;
          div.addEventListener('click', () => selectBlock(block.name));
          list.appendChild(div);
        });
        if (state.htmlBlocks[0]) {
          selectBlock(state.htmlBlocks[0].name);
        }
      } catch (e) {
        qs('#htmlBlocksList').innerHTML = '<div class="editor-item">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å</div>';
      }
    }

    function selectBlock(name) {
      state.selectedBlock = name;
      qsa('.editor-item').forEach(item => item.classList.toggle('active', item.dataset.name === name));
      const block = state.htmlBlocks.find(b => b.name === name);
      qs('#selectedBlockLabel').textContent = block ? block.label : '–ë–ª–æ–∫ –Ω–µ –≤—ã–±—Ä–∞–Ω';
    }

    async function loadSelectedBlock() {
      if (!state.selectedBlock) return;
      try {
        const res = await fetch(`/api/html-block?name=${encodeURIComponent(state.selectedBlock)}`);
        const text = await res.text();
        qs('#htmlBlockContent').value = text || '';
        syncToWysiwyg();
      } catch (e) {
        showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–ª–æ–∫–∞', 'error');
      }
    }

    async function saveSelectedBlock() {
      if (!state.selectedBlock) return;
      try {
        if (state.editorMode === 'wysiwyg') {
          syncToTextarea();
        }
        await fetch(`/api/html-block?name=${encodeURIComponent(state.selectedBlock)}`, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' },
          body: qs('#htmlBlockContent').value
        });
        showToast('–ë–ª–æ–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
      } catch (e) {
        showToast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –±–ª–æ–∫–∞', 'error');
      }
    }

    function bindEditorMode() {
      const btnCode = qs('#modeCode');
      const btnWysiwyg = qs('#modeWysiwyg');
      const codeArea = qs('#htmlBlockContent');
      const wysiwygFrame = qs('#wysiwygFrame');
      const toolbar = qs('#toolbarWrapper');

      const applyMode = (mode) => {
        state.editorMode = mode;
        const isCode = mode === 'code';
        btnCode.classList.toggle('active', isCode);
        btnWysiwyg.classList.toggle('active', !isCode);
        codeArea.style.display = isCode ? 'block' : 'none';
        wysiwygFrame.style.display = isCode ? 'none' : 'block';
        toolbar.style.display = isCode ? 'none' : 'flex';
        if (!isCode) {
          syncToWysiwyg();
        }
      };

      btnCode.addEventListener('click', () => applyMode('code'));
      btnWysiwyg.addEventListener('click', () => applyMode('wysiwyg'));

      applyMode('code');
    }

    function syncToWysiwyg() {
      const doc = getWysiwygDoc();
      if (!doc) return;
      const code = qs('#htmlBlockContent').value || '';
      if (doc.readyState !== 'complete') {
        doc.addEventListener('DOMContentLoaded', () => { doc.body.innerHTML = code; }, { once: true });
      } else {
        doc.body.innerHTML = code;
      }
    }

    function syncToTextarea() {
      const doc = getWysiwygDoc();
      if (!doc) return;
      qs('#htmlBlockContent').value = doc.body.innerHTML;
    }

    function handleToolbarCommand(cmd) {
      const doc = getWysiwygDoc();
      if (!doc || !doc.body) return;
      doc.body.focus();
      switch (cmd) {
        case 'bold':
        case 'italic':
          doc.execCommand(cmd, false, null);
          break;
        case 'h2':
          doc.execCommand('formatBlock', false, 'h2');
          break;
        case 'ul':
          doc.execCommand('insertUnorderedList', false, null);
          break;
        case 'link': {
          const url = prompt('–í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É (https://...)', 'https://');
          if (!url) return;
          doc.execCommand('createLink', false, url);
          break;
        }
        case 'emoji': {
          const emoji = prompt('–í–≤–µ–¥–∏—Ç–µ —ç–º–æ–¥–∂–∏ –∏–ª–∏ —Å–∏–º–≤–æ–ª', 'üòä');
          if (!emoji) return;
          doc.execCommand('insertText', false, emoji);
          break;
        }
        case 'align-left':
          doc.execCommand('justifyLeft', false, null);
          break;
        case 'align-center':
          doc.execCommand('justifyCenter', false, null);
          break;
        case 'align-right':
          doc.execCommand('justifyRight', false, null);
          break;
        case 'indent':
          doc.execCommand('indent', false, null);
          break;
        case 'outdent':
          doc.execCommand('outdent', false, null);
          break;
        case 'clear':
          doc.body.innerHTML = '';
          break;
        default:
          break;
      }
      syncToTextarea();
    }

    function debounce(fn, delay = 250) {
      let t;
      return (...args) => {
        clearTimeout(t);
        t = setTimeout(() => fn.apply(null, args), delay);
      };
    }

    function getWysiwygDoc() {
      const frame = qs('#wysiwygFrame');
      if (!frame || !frame.contentDocument) return null;
      return frame.contentDocument;
    }

    function initWysiwygFrame() {
      const frame = qs('#wysiwygFrame');
      if (!frame) return;
      const html = `
        <!doctype html>
        <html lang="ru">
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <style>
            body { margin: 0; padding: 14px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; min-height: 100vh; box-sizing: border-box; }
            :focus { outline: none; }
          </style>
        </head>
        <body contenteditable="true">
        <script>
          (function () {
            const d = document;
            function show(id) { const el = d.getElementById(id); if (el) el.removeAttribute('hidden'); }
            function hide(id) { const el = d.getElementById(id); if (el) el.setAttribute('hidden', ''); }

            window.openLoginModal = function () { show('login-modal'); };
            window.closeLoginModal = function () { hide('login-modal'); };

            window.openLegalModal = function (type) { show('legal-' + type + '-modal'); };
            window.closeLegalModal = function (type) { hide('legal-' + type + '-modal'); };

            window.openCookieBanner = function () { show('cookie-banner'); };
            window.closeCookieBanner = function () { hide('cookie-banner'); };
            window.acceptCookies = function () { hide('cookie-banner'); };
            window.declineCookies = function () { hide('cookie-banner'); };

            window.openSettingsModal = function () { show('settings-modal'); };
            window.closeSettingsModal = function () { hide('settings-modal'); };

            window.openPaymentSuccessModal = function () { show('payment-success-modal'); };
            window.closePaymentSuccessModal = function () { hide('payment-success-modal'); };
            window.openPaymentFailModal = function () { show('payment-fail-modal'); };
            window.closePaymentFailModal = function () { hide('payment-fail-modal'); };

            d.addEventListener('click', function (e) {
              const cookieBtn = e.target.closest('[data-cookie-action]');
              if (cookieBtn) {
                const action = cookieBtn.getAttribute('data-cookie-action');
                if (action === 'accept') window.acceptCookies();
                if (action === 'decline') window.declineCookies();
                if (action === 'close') window.closeCookieBanner();
              }
            });

            d.addEventListener('keydown', function (e) {
              if (e.key === 'Escape') {
                ['terms','offer','privacy','refund','contacts'].forEach(window.closeLegalModal);
                window.closeLoginModal();
                window.closeCookieBanner();
                window.closeSettingsModal();
                window.closePaymentSuccessModal();
                window.closePaymentFailModal();
              }
            });
          })();
        <\/script>
        </body>
        </html>`;
      frame.srcdoc = html;
    }

    async function loadFaviconStatus() {
      const preview = qs('#faviconPreview');
      const meta = qs('#faviconMeta');
      try {
        const res = await fetch('/api/favicon');
        const data = await res.json();
        preview.innerHTML = '';

        const manifest = data.manifest || {};

        const uploadable = new Set([
          'favicon.svg',
          'favicon-dark.svg',
          'favicon-32x32.png',
          'favicon-16x16.png',
          'apple-touch-icon.png',
          'android-chrome-192x192.png',
          'android-chrome-512x512.png',
          'web-app-manifest-192x192.png',
          'web-app-manifest-512x512.png'
        ]);

        const icons = [
          { label: 'favicon.svg', path: data.files?.['favicon.svg']?.path, target: 'favicon.svg' },
          { label: 'favicon-dark.svg (prefers-color-scheme: dark)', path: data.files?.['favicon-dark.svg']?.path, target: 'favicon-dark.svg' },
          { label: 'favicon-32x32.png', path: data.files?.['favicon-32x32.png']?.path, target: 'favicon-32x32.png' },
          { label: 'favicon-16x16.png', path: data.files?.['favicon-16x16.png']?.path, target: 'favicon-16x16.png' },
          { label: 'apple-touch-icon.png', path: data.files?.['apple-touch-icon.png']?.path, target: 'apple-touch-icon.png' },
          { label: 'android-chrome-192x192.png', path: data.files?.['android-chrome-192x192.png']?.path, target: 'android-chrome-192x192.png' },
          { label: 'android-chrome-512x512.png', path: data.files?.['android-chrome-512x512.png']?.path, target: 'android-chrome-512x512.png' },
          { label: 'web-app-manifest-192x192.png', path: data.files?.['web-app-manifest-192x192.png']?.path, target: 'web-app-manifest-192x192.png' },
          { label: 'web-app-manifest-512x512.png', path: data.files?.['web-app-manifest-512x512.png']?.path, target: 'web-app-manifest-512x512.png' }
        ];

        if (Array.isArray(manifest.icons)) {
          manifest.icons.forEach((icon, idx) => {
            icons.push({
              label: icon.sizes ? `manifest ${icon.sizes}` : `manifest icon ${idx + 1}`,
              path: icon.src,
              target: null
            });
          });
        }

        const iconsPrepared = icons.map(icon => {
          const path = icon.path ? icon.path.replace(/^\/assets\//, '/assets/') : '';
          return { ...icon, path };
        });

        preview.innerHTML = '';
        iconsPrepared.forEach(icon => {
          const wrap = document.createElement('div');
          wrap.style.display = 'flex';
          wrap.style.flexDirection = 'column';
          wrap.style.alignItems = 'center';
          wrap.style.gap = '6px';
          wrap.style.fontSize = '11px';
          wrap.style.color = 'var(--text-muted)';

          const img = document.createElement('img');
          img.src = icon.path || 'data:image/gif;base64,R0lGODlhAQABAAAAACw=';
          img.alt = icon.label;
          img.style.width = '48px';
          img.style.height = '48px';
          img.style.objectFit = 'contain';
          img.style.border = '1px solid var(--border-light)';
          img.style.borderRadius = '8px';
          img.loading = 'lazy';

          const label = document.createElement('div');
          label.textContent = icon.label;

          wrap.appendChild(img);
          wrap.appendChild(label);

          if (icon.target && uploadable.has(icon.target)) {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            fileInput.style.display = 'none';

            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'btn btn-outline btn-sm';
            btn.textContent = '–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª';
            btn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', () => {
              if (fileInput.files && fileInput.files[0]) {
                uploadIcon(icon.target, fileInput.files[0]);
              }
            });

            wrap.appendChild(btn);
            wrap.appendChild(fileInput);
          }

          preview.appendChild(wrap);
        });

        const primary = data.primary ? `–û—Å–Ω–æ–≤–Ω–æ–π: ${data.primary}` : '–û—Å–Ω–æ–≤–Ω–æ–π –Ω–µ –∑–∞–¥–∞–Ω';
        const manifestParts = [];
        if (manifest.name) manifestParts.push(`–ò–º—è: ${manifest.name}`);
        if (manifest.short_name || manifest.shortName) manifestParts.push(`–ö–æ—Ä–æ—Ç–∫–æ–µ: ${manifest.short_name || manifest.shortName}`);
        if (manifest.theme_color || manifest.themeColor) manifestParts.push(`–¢–µ–º–∞: ${manifest.theme_color || manifest.themeColor}`);
        if (manifest.background_color || manifest.backgroundColor) manifestParts.push(`–§–æ–Ω: ${manifest.background_color || manifest.backgroundColor}`);
        if (manifest.icons && manifest.icons.length) {
          manifestParts.push(`–ò–∫–æ–Ω–æ–∫: ${manifest.icons.length}`);
        }
        meta.textContent = [primary, manifestParts.join(' ‚Ä¢ ')].filter(Boolean).join(' ‚Äî ');

        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—è –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞ –∏–∑ favicon-–∫–æ–Ω—Ñ–∏–≥–∞
        qs('#manifestName').value = manifest.name || '';
        qs('#manifestShortName').value = manifest.short_name || manifest.shortName || '';
        qs('#manifestThemeColor').value = manifest.theme_color || manifest.themeColor || '';
        qs('#manifestBgColor').value = manifest.background_color || manifest.backgroundColor || '';
        qs('#manifestStartUrl').value = manifest.start_url || manifest.startUrl || '';
      } catch (e) {
        preview.innerHTML = '<div style="color: var(--danger); font-size:13px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–≤–∏–∫–æ–Ω–æ–∫</div>';
        meta.textContent = '';
      }
    }

    async function uploadIcon(targetName, file) {
      const formData = new FormData();
      formData.append('file', file, targetName);
      try {
        const res = await fetch('/api/favicon', { method: 'POST', body: formData });
        const data = await res.json();
        if (data.success) {
          showToast(`–ò–∫–æ–Ω–∫–∞ ${targetName} –æ–±–Ω–æ–≤–ª–µ–Ω–∞`);
          await loadFaviconStatus();
        } else {
          showToast(data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∫–æ–Ω–∫–∏', 'error');
        }
      } catch (e) {
        showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∫–æ–Ω–∫–∏', 'error');
      }
    }
  </script>
</body>

</html>
