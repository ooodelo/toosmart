# ТЗ_разработчика_v1.1

## 1. Цель и результат работы

Цель: реализовать систему генерации и публикации сайта курса по клинингу в соответствии с архитектурой `ARCHITECTURE_v1.1`.

По итогам работы должны быть:

- рабочие сборки `dist/free` и `dist/premium`, готовые к заливке на хостинг;
- PHP-часть (`server/`), обеспечивающая авторизацию, работу с Robokassa и защиту платного контента;
- документированный пайплайн сборки и обновления контента;
- код, готовый к дальнейшему расширению без ручного переписывания структуры.

---

## 2. Технический контекст

- Node.js: актуальная LTS-версия (фиксируется в README).
- PHP: 7.4+.
- База данных: SQLite.
- Hosting: общий PHP-хостинг с поддержкой `.htaccess`, без Docker и без Node.js на сервере (Node используется только локально для сборки).

---

## 3. Структура контента и файлов

### 3.1. Дерево `content/`

Реализовать и поддерживать следующую структуру:

```text
content/
  intro/
    00_intro.md
  course/
    01_*.md
    02_*.md
    ...
  appendix/
    A_*.md
    B_*.md
    ...
  recommendations/
    *.md
  legal/
    offer.md
    privacy.md
    cookies.md
    contacts.md
    requisites.md
```

### 3.2. Правила именования и slug’и

- `intro/00_intro.md` — всегда один файл, вводная часть.
- `course/NN_*.md`:
  - `NN` — двузначный номер, определяющий порядок;
  - остальная часть имени — slug (латиница или транслит).
- `appendix/LETTER_*.md`:
  - `LETTER` — A, B, C… определяет порядок приложений.
- `recommendations/*.md`:
  - имя файла без расширения — slug, если явно не задан в front matter.
- `legal/*.md`:
  - имена соответствуют типу документа (`offer`, `privacy`, `cookies`, `contacts`, `requisites`).

---

## 4. Требования к парсеру Markdown и логическому введению

### 4.1. Общий парсер

Реализовать модуль, который:

1. Читает Markdown-файл.
2. Парсит front matter (если есть).
3. Строит структуру:
   - `H1` → title;
   - список `H2`, `H3` и абзацев;
4. Считает количество слов в теле текста (для времени чтения).

### 4.2. Алгоритм выделения логического введения

Для файлов в `content/intro`, `content/course`, `content/appendix`:

1. Найти первый `H1` и позицию после него.
2. Найти `H2`, в тексте которого есть «Введение» (регистр и пробелы игнорировать).
   - Если найдено:
     - логическое введение = этот `H2` + все абзацы/элементы до следующего `H2` или горизонтальной линии (`---`).
3. Если `H2` «Введение» отсутствует:
   - логическое введение = первые 1–3 абзаца после `H1` до первого заголовка (`H2`/`H3`) или горизонтальной линии.
4. Если после `H1` нет ни одного абзаца (сразу `---` или `H2`):
   - логическое введение = первый `H2` и первые 1–2 абзаца под ним.

Парсер должен возвращать:

- HTML-строку введения;
- HTML-строку остального контента («хвост»);
- данные о структуре (список `H2` и их якорей).

---

## 5. Генерация free-версии

### 5.1. Вводная часть

Для `content/intro/00_intro.md`:

- собрать страницу `dist/free/index.html`;
- вывести контент полностью (без blur);
- добавить:
  - блок краткой структуры курса (по данным меню);
  - карусель рекомендаций;
  - цену курса (параметры из конфига).

### 5.2. Разделы курса (`content/course`)

Для каждого `course/NN_*.md`:

1. Определить slug и title.
2. Сформировать URL `/course/<slug>/` и файл `dist/free/course/<slug>.html`.
3. Внутри страницы:

   - показать:
     - H1;
     - время чтения (для **всего** раздела, не только введения);
     - логическое введение (полностью);
   - далее добавить блок blur-тизера (`section.premium-teaser`):
     - взять первые 1–2 абзаца из хвоста (после введения);
     - обернуть их в `div.premium-teaser__blurred`:
       - текст завернуть в `<!--noindex--> ... <!--/noindex-->`;
       - добавить атрибут `data-nosnippet` на контейнер;
     - поверх/рядом вывести `div.premium-teaser__overlay` с текстом:
       - «Осталось ещё ~N минут чтения» (N = время чтения раздела минус время введения, округлённое);
       - кнопка `button.premium-teaser__cta` с текстом «Получить полный доступ».

4. Остальной хвост раздела **не рендерить** в free-страницу.

### 5.3. Рекомендации (`content/recommendations`)

Для каждого `*.md`:

1. Прочитать front matter: `title`, `teaser`, `image`, `order`, `slug` (опционально).
2. Сформировать URL `/recommendations/<slug>/` и файл `dist/free/recommendations/<slug>.html`.
3. Внутри страницы:

   - вывести H1 (из `title` или `H1` файла);
   - время чтения статьи;
   - основной текст (без teaser-фразы);
   - блок «Курс» с ссылками:
     - на главную `/`;
     - на вводную/структуру курса;
     - на кнопку оплаты/CTA.

4. Добавить запись в JSON для карусели рекомендаций (см. раздел 7.3 архитектуры).

### 5.4. Legal (`content/legal`)

- Сформировать HTML-фрагменты (partials) для каждого файлa в `legal/`.
- (Опционально) сгенерировать отдельные страницы `/legal/<slug>/`.

Фрагменты должны быть удобны для вставки в модальные окна футера.

---

## 6. Генерация premium-версии

### 6.1. Вводная

- Сгенерировать `dist/premium/index.html`:
  - аналогичную структуре free-варианта, но без paywall и CTA;
  - с ссылками «Перейти к курсу»/«Продолжить» на первый раздел.

### 6.2. Разделы курса и приложения

Для каждого `course/NN_*.md` и `appendix/*`:

1. Определить slug и title.
2. Сформировать URL вида:
   - `/premium/course/<slug>/` — для разделов;
   - `/premium/appendix/<slug>/` — для приложений.
3. Сформировать страницу в `dist/premium/...`:

   - общий layout premium;
   - H1;
   - время чтения;
   - **весь текст раздела** (введение + хвост);
   - блок «Назад/Далее» (см. раздел 8.2).

Никаких blur-блоков или noindex/nosnippet для основного текста в premium.

---

## 7. Меню, навигация и рекомендации

### 7.1. Генерация меню курса

Реализовать функцию генерации структуры курса:

1. Источник данных:

   - `intro/00_intro.md` (тип `intro`);
   - все `course/NN_*.md` (тип `course`);
   - все `appendix/*` (тип `appendix`).

2. Для каждого элемента меню:

   - `label` — `H1` файла;
   - `url`:
     - для intro: `/` (free) и `/premium/` (premium);
     - для course: `/course/<slug>/` (free) и `/premium/course/<slug>/` (premium);
     - для appendix: только `/premium/appendix/<slug>/`;
   - `readingTime` — вычисленное время чтения полного текста;
   - `type` — `intro` | `course` | `appendix`.

3. В free-версии выводить только `intro` + `course`.
4. В premium-версии выводить `intro` + `course` + `appendix` (приложения — в конце списка).

### 7.2. Переходы «Назад» и «Далее»

На основе списка меню построить линейную цепочку:

`intro → course[0] → course[1] → ... → course[n] → appendix[A] → appendix[B] → ...`

Реализовать:

- Для premium-страниц:
  - вычислять `prevSlug` и `nextSlug` для каждой точки;
  - выводить внизу страницы две кнопки:
    - «Назад» (если есть предыдущий элемент);
    - «Далее» (если есть следующий элемент).
- Для intro-premium:
  - «Назад» не выводить;
  - «Далее» вести на первый раздел курса.
- Для последнего элемента цепочки:
  - по умолчанию «Далее» ведёт на финальную страницу (описать URL в конфиге или жёстко зафиксировать);
  - альтернативный вариант — не выводить кнопку «Далее» (выбрать и зафиксировать в макете).

В free-версии:

- по умолчанию кнопки «Назад/Далее» **не выводить**, чтобы не создавать иллюзии свободного прохождения;
- допускается опциональная кнопка «Перейти к следующему разделу» (если будет принято дизайн-решение, оно отдельно уточняется).

### 7.3. Карусель рекомендаций

Реализовать:

1. Скрипт сборки `build:reco`, который:
   - сканирует `content/recommendations`;
   - читает `title`, `teaser`, `image`, `order`, `slug`;
   - формирует JSON-массив карточек, отсортированных по `order`, затем по `title`/slug.

2. На фронтенде:
   - использовать этот JSON для генерации карусели на:
     - главной;
     - страницах `/course/<slug>/` и `/premium/course/<slug>/`;
   - показывать на карточке:
     - `title`;
     - `teaser`;
     - картинку;
     - ссылку на статью.

3. Жёстко закрепить: **рекомендации никогда не входят в боковое меню курса**.

---

## 8. SEO, robots.txt и sitemap.xml

### 8.1. robots.txt

Реализовать robots.txt со следующими правилами:

- `Allow: /`
- `Allow: /course/`
- `Allow: /recommendations/`
- `Allow: /legal/`
- `Disallow: /premium/`
- `Disallow: /server/`
- `Disallow: /dist/premium/`
- `Disallow: /scripts/`
- `Host: toosmart.ru`
- `Sitemap: https://toosmart.ru/sitemap.xml`

### 8.2. sitemap.xml

Скрипт сборки должен:

- собирать URL:
  - `/`
  - все `/course/<slug>/`
  - все `/recommendations/<slug>/`
  - (опционально) все `/legal/<slug>/`
- записывать `sitemap.xml` в `dist/free/` и обеспечивать его доступ по `/sitemap.xml`.

### 8.3. Мета-теги и Schema.org

Общие требования:

- Для всех публичных страниц:
  - `<title>` формируем из `H1` + название сайта;
  - `<meta name="description">` — первые 150–160 символов логического введения (intro/разделы) или текста статьи (recommendations).
- Open Graph / Twitter:
  - `og:title`, `og:description`, `og:image`, `og:type`, `og:url`.

Микроразметка:

- На главной — `Course`, описывающий весь курс.
- На страницах разделов (`/course/<slug>/`) — `WebPage`, с указанием, что часть контента доступна только по подписке.
- На страницах рекомендаций — `Article` + `isAccessibleForFree: true`.
- На premium-страницах (если нужно) — `Article`/`WebPageElement` с `isAccessibleForFree: false`.

---

## 9. PHP-часть: авторизация и Robokassa

### 9.1. Структура `server/`

Минимальный состав:

```text
server/
  public/
    index.php
    auth.php
    check-auth.php
    robokassa-callback.php
  private/
    db.sqlite
    config.php
```

### 9.2. SQLite

В `db.sqlite`:

- `users`:
  - id (PK);
  - email (уникальный);
  - password_hash;
  - created_at;
  - is_active (флаг доступа к курсу).
- `payments`:
  - id (PK);
  - user_id (FK);
  - invoice_id (ID счета в Robokassa);
  - amount;
  - currency;
  - status (pending/success/fail);
  - paid_at;
  - raw_callback (опционально, для логирования).

### 9.3. Поток оплаты

Реализовать:

1. Скрипт формирования счёта:
   - принимает email (и, возможно, имя);
   - проверяет/создаёт пользователя;
   - создаёт запись в `payments` со status = pending;
   - рассчитывает подпись для Robokassa;
   - отдаёт данные для POST/redirect на Robokassa.

2. Callback Robokassa:
   - принимает данные (`OutSum`, `InvId`, `SignatureValue` и др.);
   - валидирует подпись;
   - при успехе:
     - помечает `payments.status = success`;
     - устанавливает `users.is_active = 1` для соответствующего пользователя;
   - при неуспешной попытке — статус `fail`, запись в лог.

3. Страница/скрипт авторизации:
   - форма email + пароль;
   - проверка `password_hash` и `is_active`;
   - установка сессии при успехе.

4. Скрипт `check-auth.php`:
   - проверяет сессию;
   - если ок — проксирует запрос к `dist/premium/*`;
   - если нет — редиректит на `auth.php` или страницу «Нет доступа».

---

## 10. Кнопки CTA и навигация (подробное поведение)

### 10.1. Кнопка «Получить полный доступ»

Требования:

1. **Отрисовка и расположение:**
   - элемент `button.premium-teaser__cta` внутри `section.premium-teaser`;
   - находится непосредственно под логическим введением, над/поверх градиента blur;
   - на мобильных должна появляться в первом экране после введения (без скролла до середины страницы).

2. **Условия показа:**
   - отображается только на страницах free-разделов курса (`/course/<slug>/`);
   - не отображается в:
     - intro (`/`);
     - рекомендациях (`/recommendations/...`);
     - премиум-версии (`/premium/...`).

3. **Поведение при клике:**
   - базовый сценарий:
     - открывается модальное окно с формой:
       - поле email (обязательное);
       - чекбокс согласия с офертой;
       - кнопка «Перейти к оплате»;
     - при сабмите формы:
       - POST-запрос к backend (создание инвойса);
       - в случае успеха — редирект на страницу Robokassa;
       - в случае ошибки — сообщение над/под кнопкой.
   - альтернативный сценарий (если будет принят):
     - переход на отдельную страницу описания полного курса, где уже расположена форма оплаты и кнопка «Оплатить».

4. **Состояния:**
   - `normal` — доступна для клика;
   - `loading` — при отправке формы/ожидании ответа backend:
     - визуально показывать спиннер;
     - блокировать повторный клик;
   - `error` — подсветка и текст (например, «Не удалось связаться с сервером, попробуйте ещё раз»).

5. **Аналитика:**
   - у кнопки должен быть атрибут `data-analytics="cta-premium"`;
   - в JS предусмотреть простой хук:
     - при клике вызывать `window.analytics && analytics.track('cta_click', { slug: '<slug>' })` (или аналогичную заглушку);
   - при необходимости легко интегрируется любая система метрик.

### 10.2. Кнопки «Назад» и «Далее»

Требования:

1. **Отрисовка и расположение:**
   - две кнопки/ссылки внизу контента premium-страницы:
     - левая — «Назад» (`data-analytics="nav-prev"`);
     - правая — «Далее» (`data-analytics="nav-next"`);
   - разметка может быть:
     - либо `a` с классами `.nav-prev`, `.nav-next`;
     - либо `button` внутри `a`, но конечный клик должен вести по ссылке.

2. **Условия показа:**
   - показываются только на premium-страницах (`/premium/...`);
   - на intro-странице premium:
     - «Назад» не рендерится;
     - «Далее» ведёт на первый раздел курса;
   - на первом разделе курса:
     - «Назад» ведёт на intro;
   - на последнем разделе курса:
     - «Далее» ведёт на первое приложение (если есть) или на финальную страницу (если приложений нет);
   - на последнем приложении:
     - по умолчанию «Далее» ведёт на финальную страницу (например, `/premium/finish/` или `/premium/thanks/`).

3. **Поведение:**
   - переход должен работать без JS:
     - `href` должен быть выставлен на реальный URL (`/premium/course/<slug>/`, `/premium/appendix/<slug>/` или `/premium/finish/`);
   - при наличии JS можно дополнительно:
     - подсвечивать активный пункт меню;
     - обновлять историю (history.pushState), но базовая работа обязана быть в чистом HTML.

4. **Состояния:**
   - для начального элемента цепочки:
     - «Назад» не рендерится;
   - для конечного элемента (если нет финальной страницы):
     - «Далее» не рендерится.

5. **Аналитика:**
   - по клику отправлять событие (если интегрирована аналитика):
     - `nav_next` / `nav_prev` с полями:
       - `fromSlug`;
       - `toSlug`;
       - `type` (`intro` | `course` | `appendix`).

---

## 11. Конфигурируемость и цены

### 11.1. Конфиг `config/site.json`

Реализовать JSON-конфиг (или PHP-аналог), включающий:

- `domain`: `"https://toosmart.ru"`;
- `pricing`:
  - `oldPrice`: число (например, 10000);
  - `currentPrice`: число (например, 3400);
  - `currency`: `"RUB"`;
- `readingSpeed`: число (слов/мин, по умолчанию 200);
- `finishUrl`: строка (URL финальной страницы после последнего элемента курса);
- флаги:
  - `showNextInFree`: true/false (управляет отображением «Далее» в free);
  - `cookiesBannerEnabled`: true/false.

Все места, где отображается цена или используется домен/скорость чтения, должны брать значения из конфига, а не быть зашитыми в коде.

---

## 12. Нефункциональные требования и сборка

### 12.1. Команды

Реализовать в `package.json` как минимум:

- `build:free` — сборка `dist/free` (intro, course с превью, recommendations, legal, sitemap, robots).
- `build:premium` — сборка `dist/premium` (intro, course целиком, appendix, premium-layout).
- `build:reco` — отдельная сборка JSON-рекомендаций (можно запускать внутри `build:free`).
- `build` — общая команда (выполняет `build:free` + `build:premium` + `build:reco`).

### 12.2. Качество

- Минификация CSS/JS (например, через PostCSS/Terser).
- Линтер, проверяющий отсутствие битых внутренних ссылок.
- Относительные пути к ресурсам.
- Обновлённый README с инструкциями:
  - как добавлять новые разделы и рекомендации;
  - как запускать сборку;
  - как разворачивать сайт на хостинге и обновлять контент.

---

## 13. Приоритеты реализации

1. Структура `content/` и корректный парсер логического введения.
2. Генерация free/premium страниц курса с paywall по описанной логике.
3. SQLite-авторизация и интеграция Robokassa.
4. SEO (robots.txt, sitemap.xml, мета-теги, Schema.org).
5. Карусель рекомендаций и JSON.
6. Кнопки CTA и «Назад/Далее» с заданным поведением.
7. Юридические модальные окна в футере и cookie-баннер.
8. Дополнительные оптимизации и рефакторинг.

