# ARCHITECTURE_v1.1

## 1. Назначение документа

Этот документ описывает целевую архитектуру проекта курса по клинингу:

- как организованы файлы и типы контента;
- как собираются бесплатная и платная версии;
- как генерируются страницы, меню, карусель рекомендаций;
- как устроены авторизация, платёжка, SEO и защита платного контента.

Документ — «истина» для реализации. Все остальные описания (черновые ТЗ, старые схемы) считаются устаревшими, если противоречат этому тексту.

---

## 2. Обзор системы

### 2.1. Цель

Сайт продаёт доступ к платному курсу по клинингу (структурированные разделы) и параллельно даёт:

- бесплатную вводную часть курса;
- бесплатные превью платных разделов (логическое введение + небольшой размазанный тизер);
- полностью открытые статьи-рекомендации, оптимизированные под SEO.

Монетизация — единоразовый доступ к полной версии курса (все разделы + приложения).

### 2.2. Общий стек

- Контент: Markdown-файлы с минимальной метаинформацией (front matter там, где нужно).
- Генерация: Node.js-скрипты, которые собирают:
  - `dist/free` — бесплатная версия;
  - `dist/premium` — платная версия.
- Веб-сервер: обычный PHP-хостинг с поддержкой:
  - PHP 7.4+;
  - SQLite;
  - `.htaccess` (mod_rewrite).
- Платежи: Robokassa (оплата курса, callback и назначение доступа).

---

## 3. Логическая структура контента

### 3.1. Типы контента

Вся смысловая информация живёт в `content/` и делится на 5 типов:

1. `intro/` — вводная часть курса (полностью открыта в free и premium).
2. `course/` — основные разделы курса (в free показывается только введение + blur, в premium — полностью).
3. `appendix/` — приложения (только в платной версии, всегда в конце курса).
4. `recommendations/` — статьи-рекомендации (полностью открыты, используются для SEO и карусели).
5. `legal/` — юридические тексты (оферта, политика, реквизиты, cookies, контакты).

### 3.2. Сценарии пользователя

1. **Новый пользователь:**
   - попадает на главную (`intro`);
   - видит вводную часть, краткую структуру курса, карусель рекомендаций, цену/скидку;
   - проваливается в раздел курса, читает введение, видит blur и CTA «Получить полный доступ».

2. **Покупатель курса:**
   - нажимает CTA → Robokassa → успешная оплата;
   - получает логин/пароль на email и/или ссылку для входа;
   - после авторизации попадает в premium-версию: полные разделы, кнопка «Далее», приложения.

3. **Читатель рекомендаций:**
   - с поиска или главной заходит на `/recommendations/...`;
   - читает полную статью;
   - видит блок «Курс» с ссылкой на введение/структуру курса и ценой.

---

## 4. Файловая структура проекта

### 4.1. Корень репозитория (логическая схема)

```text
project-root/
  content/
    intro/
    course/
    appendix/
    recommendations/
    legal/
  src/
    layouts/
    partials/
    styles/
    scripts/
  scripts/
    build.js
    build-free.js
    build-premium.js
    build-reco.js
  server/
    public/
    private/
  config/
    site.json
    seo.json
  dist/
    free/
    premium/
  README.md
```

### 4.2. content/

#### 4.2.1. intro/

- Одна основная Markdown-страница вводной части.  
  Пример: `content/intro/00_intro.md`.
- Используется как:
  - главная страница проекта;
  - источник текста для открытой части курса.

#### 4.2.2. course/

- Набор файлов с префиксами `NN_…`:

  ```text
  01_basics.md
  02_tools.md
  ...
  10_special_cases.md
  ```

- `NN` задаёт порядок разделов.
- Внутри — текст раздела с заголовком `H1` и подзаголовками `H2`, `H3`.

#### 4.2.3. appendix/

- Файлы вида `A_appendix.md`, `B_extra_cases.md` и т.п.
- Порядок:

  1. Все `course/NN_*` по возрастанию;
  2. Затем все `appendix/*` по алфавиту (A, B, C…).

- В free-сборке приложения **не рендерятся**.

#### 4.2.4. recommendations/

- Файлы рекомендаций с YAML-front matter:

  ```markdown
  ---
  title: "Эко-средства: маркетинг против реальности"
  teaser: "Короткое живое описание для карточки в 1–2 строки."
  image: "/images/reco/eco-cleaning.png"
  order: 10
  ---

  # Эко-средства: маркетинг против реальности

  (Основной текст статьи...)
  ```

- `title`: заголовок карточки и `<title>` (если не переопределён).
- `teaser`: скрытое описание для карточки (не выводится как отдельный текст в самой статье).
- `image`: путь к иллюстрации.
- `order`: сортировка карточек в карусели (чем меньше, тем выше).

Если `teaser` отсутствует, генератор берёт fallback — первые N символов основного текста без заголовков.

#### 4.2.5. legal/

- Отдельные файлы для:
  - оферты;
  - политики конфиденциальности;
  - политики cookies;
  - реквизитов;
  - контактов.

Используются:

- как источники для модальных окон в футере;
- и, при необходимости, как отдельные страницы `/legal/offer/` и т.п.

---

## 5. Публичные URL и их связь с dist/*

### 5.1. Основные публичные адреса

Пользователь видит «чистые» URL, модуль сборки генерирует соответствующие HTML-файлы:

- Главная / вводная:

  - Публичный URL:  
    `/`
  - Физический файл:  
    `dist/free/index.html` (free),  
    `dist/premium/index.html` (premium).

- Раздел курса (free):

  - Публичный URL:  
    `/course/<slug>/`
  - Файл:  
    `dist/free/course/<slug>.html`.

- Раздел курса (premium):

  - Публичный URL:  
    `/premium/course/<slug>/`
  - Файл:  
    `dist/premium/course/<slug>.html`.

- Приложение (premium):

  - Публичный URL:  
    `/premium/appendix/<slug>/`
  - Файл:  
    `dist/premium/appendix/<slug>.html`.

- Рекомендация:

  - Публичный URL:  
    `/recommendations/<slug>/`
  - Файл:  
    `dist/free/recommendations/<slug>.html`.

- Юр.страницы (опционально):

  - `/legal/offer/`, `/legal/privacy/` и т.д.

### 5.2. Связь slug ↔ имя файла

- slug для разделов и приложений берётся из имени файла без префикса:

  - `content/course/03_himiya.md` → slug `himiya` → `/course/himiya/`.
  - `content/appendix/A_cheatsheets.md` → slug `cheatsheets` → `/premium/appendix/cheatsheets/`.

- slug для рекомендаций:

  - если в front matter есть поле `slug` — используется оно;
  - иначе slug = имя файла без расширения.

---

## 6. Генерация HTML: общая логика

### 6.1. Парсинг Markdown

Единый парсер для всех типов:

- читает front matter (если есть);
- разбирает структуру:
  - первый `H1` — title страницы;
  - `H2`, `H3` — для структуры внутри раздела;
- считает количество слов для расчёта времени чтения.

### 6.2. Логическое введение раздела

Для файлов в `course/` (и, при необходимости, intro):

1. Получаем список блоков (заголовки и абзацы).
2. Пытаемся найти `H2`, в тексте которого есть «Введение»:
   - все абзацы от этого `H2` до следующего `H2` или горизонтальной линии считаются логическим введением.
3. Если такого `H2` нет:
   - логическое введение — первые 1–3 абзаца после `H1` (до первого `H2` или `---`).
4. Если после `H1` сразу идёт `---` или `H2`, и нет ни одного абзаца:
   - логическое введение — первые 1–2 абзаца под первым `H2`.

Это правило одинаково используется:

- для free-превью (отображаем полностью);
- для расчёта времени чтения (на основе полного текста раздела, не только введения).

### 6.3. Блок blur-тизера в free-версии

После логического введения:

1. Берётся следующий фрагмент текста (1–2 абзаца), в сумме не превышающий примерно 300 px по высоте в верстке (эта высота задаётся через CSS `max-height`).
2. Этот фрагмент оборачивается в контейнер:

   ```html
   <section class="premium-teaser" data-nosnippet>
     <div class="premium-teaser__blurred">
       <!-- noindex -->
       <!-- здесь абзацы тизера -->
       <!-- /noindex -->
     </div>
     <div class="premium-teaser__overlay">
       <p>Осталось ещё ~N минут чтения</p>
       <button class="premium-teaser__cta">Получить полный доступ</button>
     </div>
   </section>
   ```

3. Весь остальной текст раздела **не попадает** в HTML free-страницы.

В premium-версии:

- blur-контейнер либо не рендерится, либо показывается как обычный блок без блюра;
- весь текст раздела выводится полностью.

### 6.4. Время чтения

- Для каждого раздела (`intro`, каждый `course/NN_*`, каждый `appendix/*`) при сборке считается количество слов.
- Скорость чтения задаётся в конфиге (`config/site.json`), по умолчанию 200 слов/мин.
- Время чтения = `ceil(слова / скорость)`.
- Формат отображения:
  - `< 1 мин`;
  - `~5 мин`;
  - `10+ мин`.

Время чтения:

- отображается рядом с пунктами меню;
- используется в блоках «Осталось ~N минут чтения» (на основе разницы между общим временем раздела и введением).

---

## 7. Меню, навигация и карусель рекомендаций

### 7.1. Боковое меню курса

1. Источник структуры:

   - `intro/00_intro.md` → первый пункт меню («Вводная» или другое название из `H1`);
   - все файлы `course/NN_*.md` в порядке `NN`;
   - файлы `appendix/*` — **только в premium**, после всех разделов.

2. Для каждого пункта меню:

   - заголовок берётся из `H1` соответствующего файла;
   - рядом отображается время чтения;
   - URL строится по схеме выше (`/course/<slug>/` или `/premium/...`).

3. Подменю внутри раздела:

   - по `H2` внутри файла формируются «якоря» для навигации по странице;
   - эти H2 могут отображаться в форме внутренней навигации (toc/flyout), но не меняют структуру основного меню.

### 7.2. Переходы «Далее / Назад»

- Формируется линейный список всех пунктов курса (intro → course → appendix).
- Для premium:

  - для каждого раздела/приложения вычисляются `prevSlug` и `nextSlug`;
  - на страницах внизу выводятся кнопки «Назад» и «Далее» на основе этих ссылок.

В free-версии кнопки «Назад/Далее» могут не выводиться или выводиться только в виде «Перейти к следующему разделу» по решению дизайна (по умолчанию — нет).

### 7.3. Карусель рекомендаций

1. Build-скрипт `build-reco`:

   - сканирует `content/recommendations/*`;
   - читает front matter (`title`, `teaser`, `image`, `order`);
   - формирует `dist/shared/recommendations.json` (или аналогичный модуль) со списком карточек.

2. На фронте:

   - на главной и на страницах курса выводится карусель;
   - каждая карточка показывает:
     - `title`;
     - `teaser` (короткое описание);
     - картинку;
     - ссылку на `/recommendations/<slug>/`.

3. Рекомендации **никогда не попадают в боковое меню курса**, только в карусель и через прямые URL.

---

## 8. Авторизация, Robokassa и база пользователей

### 8.1. SQLite-схема

В `server/private/db.sqlite` как минимум:

- `users`:
  - id;
  - email;
  - пароль (hash);
  - created_at;
- `payments`:
  - id;
  - user_id;
  - robokassa_invoice_id;
  - amount;
  - currency;
  - status;
  - paid_at;
- по необходимости — `sessions` или хранение сессий через стандартные механизмы PHP.

JSON-файлы могут использоваться только временно для миграции, не как основное хранилище.

### 8.2. Поток оплаты через Robokassa

1. Пользователь в free-версии нажимает «Получить полный доступ».
2. JS формирует запрос на backend (например, `/server/create-invoice.php`), который:
   - создаёт (или находит) пользователя по email;
   - создаёт запись в `payments` со статусом «pending`;
   - возвращает данные для формы Robokassa (SignatureValue и т.п.).
3. Пользователь переходит на страницу Robokassa, оплачивает.
4. После успешной оплаты Robokassa вызывает callback-скрипт (`/server/robokassa-callback.php`), который:
   - валидирует подпись;
   - помечает `payments.status = success` и фиксирует `paid_at`;
   - активирует доступ пользователю (флаг в `users`).
5. Пользователь получает письмо:
   - с логином и ссылкой для установки/смены пароля (или автогенерируемым паролем);
   - с инструкцией «как войти в полную версию».

### 8.3. Защита dist/premium

- Все запросы к `dist/premium/*` проходят через `check-auth.php`:
  - если сессия валидна и доступ активен — отдаётся запрошенный ресурс;
  - иначе — редирект на страницу авторизации или сообщение об ошибке.
- `.htaccess` запрещает прямой доступ к HTML/CSS/JS в `dist/premium` без `check-auth.php`.
- Надстраиваются заголовки:
  - `X-Robots-Tag: noindex, nofollow, noarchive` для всех файлов premium.

---

## 9. SEO и микроразметка

### 9.1. Политика индексации

- Intro (`/`) — `index, follow`.
- Страницы с превью разделов (`/course/<slug>/`) — `index, follow`.  
  Индексируется только логическое введение и интерфейс, платный текст скрыт.
- Рекомендации (`/recommendations/<slug>/`) — `index, follow`.
- Premium-страницы (`/premium/...`) — `noindex, nofollow`, закрыты и заголовками, и robots.txt.

### 9.2. robots.txt

- Разрешаем:
  - `/`;
  - `/course/`;
  - `/recommendations/`;
- Запрещаем:
  - `/premium/`;
  - `/server/`;
  - служебные пути (`/dist/premium/`, `/scripts/`).
- Указываем:
  - `Host: toosmart.ru`;
  - `Sitemap: https://toosmart.ru/sitemap.xml`.

### 9.3. sitemap.xml

В sitemap попадают:

- главная `/`;
- все `/course/<slug>/`;
- все `/recommendations/<slug>/`;
- по необходимости — `/legal/*`.

Приложения и premium-страницы в sitemap не включаются.

### 9.4. Мета-теги и разметка Schema.org

- `<title>`:
  - для intro: название курса + бренд;
  - для раздела: `H1 раздела + бренд`;
  - для рекомендаций: `title` front matter или `H1`.
- `<meta name="description">`:
  - первые 150–160 символов введения.
- Open Graph / Twitter:
  - `og:title`, `og:description`, `og:image`, `og:type` (`article` или `website`), `og:url`.

Schema.org:

- Главная: `Course` + общая информация.
- Разделы курса с превью: `WebPage` + `isPartOf` курс, указание, что есть платная часть.
- Платные разделы (premium): `Article`/`WebPageElement` с `isAccessibleForFree: false`.
- Рекомендации: `Article` + `isAccessibleForFree: true`.

---

## 10. Фронтенд: поведение ключевых элементов

### 10.1. Кнопка «Получить полный доступ»

1. **Расположение:**
   - внутри блока `.premium-teaser` сразу под логическим введением;
   - визуально привязана к размытым абзацам (над ними или поверх градиента);
   - на мобильных должна находиться в зоне первого экрана после введения.

2. **Условия отображения:**
   - показывается только в free-версии разделов курса (`/course/<slug>/`);
   - не показывается в intro и рекомендациях;
   - не показывается в premium-сборке.

3. **Поведение при клике:**
   - базовый сценарий: открывается модальное окно:
     - поля: email, чекбокс согласия с офертой, кнопка «Перейти к оплате»;
     - после сабмита — запрос к backend на формирование счёта Robokassa и редирект на платёжную страницу;
   - допустимый альтернативный сценарий: прямой переход на страницу «Как получить полный доступ», где уже расположена форма оплаты.

4. **Отслеживание:**
   - у кнопки должен быть стабильный CSS-класс и/или `data-*` атрибут (например, `data-analytics="cta-premium"`), чтобы подключить аналитики;
   - клик по кнопке фиксируется в JS (в консоль и/или в условную `window.analytics`), чтобы интегрировать метрики без переписывания верстки.

5. **Состояния:**
   - обычное;
   - `disabled / loading` — при инициации запроса к серверу (во время получения параметров Robokassa) кнопка визуально блокируется;
   - в случае ошибки (нет ответа от сервера, ошибка Robokassa) рядом показывается текстовое сообщение.

### 10.2. Кнопки «Назад» и «Далее»

1. **Расположение:**
   - в premium-версии внизу страницы раздела, сразу после основного текста;
   - на мобильных — по умолчанию под текстом, без fixed-позиционирования.

2. **Условия отображения:**
   - показываются только в premium-версии;
   - на intro:
     - «Назад» скрыта;
     - «Далее» ведёт к первому разделу курса;
   - для первого раздела:
     - «Назад» ведёт на intro;
     - «Далее» — на следующий раздел;
   - для последнего раздела:
     - «Далее» ведёт на первое приложение или (если приложений нет) на финальную/«Спасибо» страницу;
   - для последнего приложения:
     - «Далее» либо ведёт на финальную страницу, либо скрывается (решение фиксируется в отдельном макете, по умолчанию — ведёт на финальную страницу).

3. **Поведение:**
   - кнопки должны использовать ссылки на реальные URL (`/premium/course/<slug>/` и т.п.), чтобы работала навигация без JS;
   - допускается дополнительная JS-навигация (history.pushState и т.п.), но HTML-ссылка обязательна.

4. **Отслеживание:**
   - обе кнопки имеют `data-analytics` (`"nav-prev"` и `"nav-next"`) для возможной интеграции аналитики;
   - в консоль/метрики можно отправлять события вида: `nav_next: from=<slug>, to=<slug>`.

5. **Состояния:**
   - для «Назад» на intro — кнопка не рендерится;
   - для «Далее» на последнем элементе цепочки, если выбрана схема «без финальной страницы», — кнопка не рендерится.

---

## 11. Нефункциональные требования и сборка

### 11.1. Команды сборки

Минимальный набор:

- `build:free` — генерирует `dist/free`:
  - intro (главную);
  - страницу списка разделов (если предусмотрена);
  - все `/course/<slug>/` с превью;
  - все `/recommendations/<slug>/`;
  - общие CSS/JS;
  - `recommendations.json` для карусели.

- `build:premium` — генерирует `dist/premium`:
  - полные версии intro и всех разделов + приложений;
  - те же CSS/JS (или минимально отличающиеся);
  - служебные страницы авторизации, заглушки и т.п.

- `build:reco` — отдельная команда для теста/обновления карусели рекомендаций.

### 11.2. Качество сборки

- Минификация CSS/JS, но с сохранением корректности.
- Проверка битых ссылок (внутренний линтер).
- Все пути к ресурсам — относительные (чтобы сборку можно было развернуть в подкаталог / на другой домен).
- README содержит инструкции по:
  - подготовке контента;
  - запуску команд сборки;
  - деплою на целевой хостинг.
