# План элегантного переписывания build-скрипта под ТЗ

Ниже — минимальный, но расширяемый дизайн, который позволяет собирать обе версии (free/premium) из единого пайплайна и поддерживает все ветки контента из ТЗ: `intro/`, `course/`, `appendix/`, `recommendations/`, `legal/`.

## 1. Структура источников и контракт данных
- `content/` → первичными данными являются **markdown-файлы с заголовками**: `H1` служит названием раздела/страницы, `H2` — подзаголовками для меню.
- Нумерация файлов (`01-...`) определяет порядок внутри ветки. Манифест `content/<branch>/index.json` опционален: если он есть — переопределяет порядок/видимость/тизер, если нет — сборка работает полностью по заголовкам.
- Общие ассеты (`src/*`, `content/images`, `content/articles`) остаются без изменений.

Такой контракт позволяет собирать free/premium без дополнительных JSON, но при необходимости задавать тонкие настройки через манифест.

## 2. Единый пайплайн сборки
1. **Сканирование**: читаем все манифесты веток → формируем массив `sections` с типом (`branch`), путём к MD и правилом отображения.
2. **Парсинг**: конвертируем MD → HTML (marked + DOMPurify) с переопределением рендера картинок и сид-датой (anchors).
3. **Нормализация**: упорядочиваем по `order` внутри ветки, связываем `next/prev`, вычисляем меню (ветка → разделы → подразделы).
4. **Рендер**: общая функция `renderPage({template, menu, content, mode})`:
   - `mode = 'free' | 'premium'`
   - для `visibility: preview` → выводим тизер + `<div class="blurred">full</div> + CTA`;
   - для `visibility: public` → выводим контент целиком;
   - для `visibility: hidden` в free → пропускаем; в premium → показываем.
5. **Копирование ресурсов**: ассеты/изображения/статьи единым helper'ом `copyTree(src, dest)`, PHP-файлы — только в premium.

## 3. API build-скрипта
- `node scripts/build.js --target=free|premium --all` (как сейчас).
- Экспортируем утилиту `build(target)` чтобы можно было тестировать из unit-тестов.

## 4. Ключевые функции (упрощённые сигнатуры)
```js
async function loadContentBranches(branches) { /* читает манифесты, парсит MD, возвращает sections */ }
function applyVisibilityFilter(sections, mode) { /* режет/трансформирует контент под free/premium */ }
function renderSite({sections, mode}) { /* строит меню + html страниц с учётом ветки */ }
```

## 5. Поведение по веткам (соответствие ТЗ)
- **intro** — public в обеих версиях.
- **course** — `preview` в free (тизер + blur), `public` в premium.
- **appendix** — `hidden` в free, `public` в premium (только ссылки в меню премиума).
- **recommendations** — `public` в обеих, но в free можно ограничить длину списка (например, первые N или выборка по тегу `public`).
- **legal** — `public` в обеих, без paywall.

## 6. Вёрстка paywall/тизера
- Единый компонент (HTML-шаблон в `src/partials/paywall.html` или строковый шаблон) с параметрами `ctaLabel`, `price`, `nextPage`.
- Использовать `<template>` + `replace` вместо конкатенации строк внутри JS для лучшей читабельности.

## 7. Расширяемость и тестируемость
- Вынести логику в модуль `scripts/lib/build.js` с чистыми функциями; `scripts/build.js` только разбирает CLI и вызывает `build`.
- Добавить unit-тесты для `applyVisibilityFilter`, `generateMenu`, `parseMarkdown` (Jest).

## 8. Что поменять в темплейте
- Меню должно уметь группировать по веткам (название ветки + список страниц).
- Вставить слот под модалку оплаты, не завязанный на конкретную цену (параметры из ENV или JSON-конфига).

## 9. Настройка цены, реквизитов и футера
- Завести единый конфиг `config/build.json` или `config/build.local.json`, который подхватывается build-скриптом и пробрасывается в шаблон. Минимальный формат:
  ```json
  {
    "pricing": {
      "currency": "RUB",
      "amount": 990,
      "originalAmount": 1490,
      "cta": "Купить курс"
    },
    "payment": {
      "merchant": "ООО \"Пример\"",
      "inn": "7700000000",
      "bank": "ПАО Банк",
      "account": "40702810000000000000",
      "agreement": "Договор оферты №123 от 01.01.2024"
    },
    "footer": {
      "email": "support@example.com",
      "phone": "+7 999 000-00-00",
      "address": "Москва, ул. Пример, д. 1",
      "links": [
        { "label": "Публичная оферта", "href": "/legal/oferta.html" },
        { "label": "Политика конфиденциальности", "href": "/legal/privacy.html" }
      ]
    }
  }
  ```
- В шаблоне (`src/template.html` + частичные `partials/footer.html` и `partials/paywall.html`) оставить плейсхолдеры вида `{{ pricing.amount }}`, `{{ payment.inn }}`, которые при сборке заменяются на значения из конфига через простую функцию `renderTemplate(data)`.
- Для CI/production — читать переменные из ENV с префиксом `PAYMENT_`/`PRICING_` и собирать промежуточный JSON перед запуском пайплайна (чтобы не хранить чувствительные данные в git).
- В free-сборке данные оплаты могут быть обрезаны до CTA/цены, реквизиты и платёжные ссылки остаются только в premium.

## 10. Выгоды такого переписывания
- Появляется явный контракт данных → меньше «магии» имени файла.
- Одинаковый пайплайн для free/premium, отличия только в фильтре видимости и дополнительных файлах.
- Легко добавить новые ветки/режимы без переписывания логики.
```
