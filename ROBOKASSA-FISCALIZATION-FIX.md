# ✅ РЕШЕНИЕ: Убран параметр Receipt из запроса к Robokassa

## Проблема

Ошибка **"Error code: 29 - No payment methods available"** возникала из-за конфликта настроек:

- В личном кабинете Robokassa выбрано **"Самостоятельное"** (фискализация без интеграции с Robokassa)
- Но код отправлял параметр **`Receipt`** в Robokassa

**Robokassa отклоняла запрос**, так как:
- При режиме "Самостоятельное" НЕ нужно отправлять Receipt
- При режиме "С интеграцией через Robokassa" НУЖНО отправлять Receipt

---

## Решение

**Убран параметр `Receipt`** из запроса к Robokassa в файле `server/api/order/create.php`

### Что изменилось:

**Было:**
```php
$params = [
  'MerchantLogin' => $cfg['robokassa']['merchant_login'],
  'OutSum' => $outSum,
  'Receipt' => $receipt_urlenc, // ❌ конфликт с настройкой "Самостоятельное"
  // ...
];
```

**Стало:**
```php
$params = [
  'MerchantLogin' => $cfg['robokassa']['merchant_login'],
  'OutSum' => $outSum,
  // Receipt убран - фискализация самостоятельная
  // Чек сохраняется в БД (receipt_json) для последующей обработки
  // ...
];
```

---

## Как это работает сейчас

### 1. При создании заказа:
- Чек **формируется** на сервере (как и раньше)
- Чек **сохраняется в БД** в поле `receipt_json` (как и раньше)
- Чек **НЕ отправляется** в Robokassa (новое!)

### 2. При оплате:
- Пользователь оплачивает через Robokassa
- Robokassa **не формирует чек** (режим "Самостоятельное")
- Платеж проходит успешно

### 3. Для фискализации (если требуется):
- Чек находится в БД в таблице `orders`, поле `receipt_json`
- Вы можете самостоятельно отправить его в вашу ККТ/ОФД
- Или настроить интеграцию с сервисом фискализации

---

## Что делать дальше

### Вариант 1: Оставить как есть (рекомендуется для начала)

Если вам **не требуется фискализация** (цифровые товары, услуги для физлиц без необходимости чека):
- ✅ Ничего делать не нужно
- ✅ Оплата будет работать
- ✅ Чеки сохраняются в БД на случай, если понадобятся

### Вариант 2: Настроить самостоятельную фискализацию

Если вам **требуется фискализация** (обязательная отправка чеков в ОФД):

1. **Подключите сервис ККТ:**
   - Атол Онлайн
   - СБИС
   - Контур.ОФД
   - Или любой другой

2. **Создайте обработчик для отправки чеков:**
   - После получения уведомления от Robokassa (ResultURL)
   - Получите `receipt_json` из БД
   - Отправьте его в ваш сервис ККТ
   - Сохраните номер фискального чека

3. **Пример интеграции с Атол Онлайн:**
   ```php
   // В файле server/robokassa/result.php
   // После успешной оплаты
   $order = getOrderByInvId($invId);
   $receipt = json_decode($order['receipt_json'], true);

   // Отправка в Атол
   $atol = new AtolClient($cfg['atol']);
   $fiscalResponse = $atol->sell($receipt);

   // Сохранение номера чека
   saveReceiptNumber($orderId, $fiscalResponse['receipt_number']);
   ```

### Вариант 3: Переключиться на фискализацию через Robokassa

Если хотите, чтобы Robokassa сама формировала чеки:

1. **В личном кабинете Robokassa:**
   - Перейдите в настройки магазина
   - Измените режим на **"С интеграцией через Robokassa"**
   - Подключите ККТ через Robokassa (они предоставляют)

2. **В коде верните параметр Receipt:**
   ```php
   $params = [
     'Receipt' => $receipt_urlenc, // вернуть обратно
   ];
   ```

---

## Проверка работы

### Тестирование оплаты:

1. Откройте сайт: https://toosmart.ru
2. Нажмите кнопку "Купить курс"
3. Введите email
4. Нажмите "Оплатить"
5. Должен произойти редирект на Robokassa
6. **Ошибка "No payment methods available" НЕ должна появляться!**
7. Выберите способ оплаты (банковская карта, СБП)
8. Завершите тестовую оплату

### Проверка в БД:

```sql
SELECT inv_id, email, amount, receipt_json, created_at
FROM orders
ORDER BY created_at DESC
LIMIT 1;
```

Убедитесь, что:
- ✅ Заказ создан
- ✅ `receipt_json` содержит чек
- ✅ Статус `pending` → после оплаты станет `paid`

---

## Важные замечания

### О фискализации для цифровых товаров:

Согласно 54-ФЗ, **чеки обязательны** при:
- Продаже товаров
- Оказании услуг
- **Кроме:** некоторых видов деятельности (см. исключения в законе)

**Для онлайн-курсов:**
- Если вы ИП/ООО → фискализация обязательна
- Если вы самозанятый → зависит от условий (проконсультируйтесь с бухгалтером)

### Текущая конфигурация сохраняет чеки:

Даже без отправки в Robokassa, чеки **сохраняются в БД**:
- Можно использовать для бухгалтерии
- Можно отправить в ККТ позже
- Можно предоставить по запросу налоговой

---

## Структура чека в БД

```json
{
  "sno": "usn_income",
  "items": [
    {
      "name": "Курс \"Clean - Теория правильной уборки\"",
      "quantity": 1,
      "sum": "5490.00",
      "tax": "none",
      "payment_method": "full_payment",
      "payment_object": "service"
    }
  ]
}
```

---

## Контакты поддержки

Если нужна помощь с фискализацией:
- **Robokassa поддержка:** support@robokassa.ru, 8 (800) 500-44-55
- **Атол Онлайн:** https://online.atol.ru/
- **СБИС:** https://sbis.ru/

---

**Дата:** 2025-12-15
**Версия:** 2.0
**Статус:** ✅ Исправлено - параметр Receipt убран для режима "Самостоятельное"
