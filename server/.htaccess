# ========================================
# ЗАЩИТА ПРЕМИУМ ВЕРСИИ КУРСА
# ========================================

# Security Headers
<IfModule mod_headers.c>
    # Запретить индексацию поисковиками
    Header set X-Robots-Tag "noindex, nofollow, noarchive"

    # Защита от clickjacking
    Header always set X-Frame-Options "SAMEORIGIN"

    # Защита от XSS
    Header always set X-XSS-Protection "1; mode=block"

    # Предотвращение MIME sniffing
    Header always set X-Content-Type-Options "nosniff"

    # Referrer Policy
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    # Permissions Policy (отключить ненужные API)
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=()"

    # HSTS - форсировать HTTPS (раскомментировать когда SSL настроен)
    # Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

    # Content Security Policy
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; font-src 'self'; img-src 'self' data:; connect-src 'self'; frame-ancestors 'none'; base-uri 'self'; form-action 'self';"
</IfModule>

# Индексный файл по умолчанию
DirectoryIndex index.php

# Включить mod_rewrite
<IfModule mod_rewrite.c>
    RewriteEngine On

    # Исключения: публичные PHP формы (не требуют авторизации)
    RewriteRule ^(forgot-password-form|resend-password-form|reset-password-form)\.php$ - [L]
    
    # Все запросы к .html файлам проксировать через check-auth.php
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^(.+)\.html$ check-auth.php?page=$1 [L,QSA]

    # Фолбэк: всё остальное отдаём через index.php (для /server/?payment=success и др.)
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^(.*)$ index.php [QSA,L]
    
    # HTTPS Redirect (отключено - настроено на уровне хостинга)
    # RewriteCond %{HTTPS} off
    # RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</IfModule>

# Отключить листинг директорий
Options -Indexes

# Защитить прямой доступ к HTML, JS, CSS файлам
<FilesMatch "\.(html|js|css)$">
    Order Deny,Allow
    Deny from all
</FilesMatch>

# Разрешить только PHP и изображения
<FilesMatch "\.(php|png|jpg|jpeg|svg|gif|webp)$">
    Allow from all
</FilesMatch>

# Защита от hotlinking изображений
<IfModule mod_rewrite.c>
    RewriteEngine on
    RewriteCond %{HTTP_REFERER} !^$
    RewriteCond %{HTTP_REFERER} !^https://(www\\.)?toosmart\\.ru [NC]
    RewriteRule \.(jpg|jpeg|png|gif|svg)$ - [F,L]
</IfModule>

# Блокировать известных скраперов
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteCond %{HTTP_USER_AGENT} (HTTrack|wget|curl|libwww) [NC]
    RewriteRule .* - [F,L]
</IfModule>
